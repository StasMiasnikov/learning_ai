
<!DOCTYPE html>

<html class="no-js" lang="en">
<head>
<meta charset="utf-8"/>
<meta content="width=device-width,initial-scale=1" name="viewport"/>
<meta content="A comprehensive learning module for understanding, building, securing, and measuring Large Language Model agents and Multi-Agent Collaboration Platforms" name="description"/>
<meta content="Learning Path Contributors" name="author"/>
<link href="https://example.com/docs/llms/fine-tuning/" rel="canonical"/>
<link href="../../../assets/images/favicon.png" rel="icon"/>
<meta content="mkdocs-1.6.1, mkdocs-material-9.6.20" name="generator"/>
<title>Fine-tuning &amp; Adaptation: Customizing LLMs for Specific Tasks - LLM and Multi-Agent Collaboration Platforms - Learning Path</title>
<link href="../../../assets/stylesheets/main.e53b48f4.min.css" rel="stylesheet"/>
<link href="../../../assets/stylesheets/palette.06af60db.min.css" rel="stylesheet"/>
<link crossorigin="" href="https://fonts.gstatic.com" rel="preconnect"/>
<link href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&amp;display=fallback" rel="stylesheet"/>
<style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
<link href="../../../stylesheets/extra.css" rel="stylesheet"/>
<script>__md_scope=new URL("../../..",location),__md_hash=e=>[...e].reduce(((e,_)=>(e<<5)-e+_.charCodeAt(0)),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
</head>
<body data-md-color-accent="indigo" data-md-color-primary="indigo" data-md-color-scheme="default" dir="ltr">
<input autocomplete="off" class="md-toggle" data-md-toggle="drawer" id="__drawer" type="checkbox"/>
<input autocomplete="off" class="md-toggle" data-md-toggle="search" id="__search" type="checkbox"/>
<label class="md-overlay" for="__drawer"></label>
<div data-md-component="skip">
<a class="md-skip" href="#fine-tuning-adaptation-customizing-llms-for-specific-tasks">
          Skip to content
        </a>
</div>
<div data-md-component="announce">
</div>
<header class="md-header" data-md-component="header">
<nav aria-label="Header" class="md-header__inner md-grid">
<a aria-label="LLM and Multi-Agent Collaboration Platforms - Learning Path" class="md-header__button md-logo" data-md-component="logo" href="../../.." title="LLM and Multi-Agent Collaboration Platforms - Learning Path">
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54"></path></svg>
</a>
<label class="md-header__button md-icon" for="__drawer">
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M3 6h18v2H3zm0 5h18v2H3zm0 5h18v2H3z"></path></svg>
</label>
<div class="md-header__title" data-md-component="header-title">
<div class="md-header__ellipsis">
<div class="md-header__topic">
<span class="md-ellipsis">
            LLM and Multi-Agent Collaboration Platforms - Learning Path
          </span>
</div>
<div class="md-header__topic" data-md-component="header-topic">
<span class="md-ellipsis">
            
              Fine-tuning &amp; Adaptation: Customizing LLMs for Specific Tasks
            
          </span>
</div>
</div>
</div>
<form class="md-header__option" data-md-component="palette">
<input aria-label="Switch to dark mode" class="md-option" data-md-color-accent="indigo" data-md-color-media="" data-md-color-primary="indigo" data-md-color-scheme="default" id="__palette_0" name="__palette" type="radio"/>
<label class="md-header__button md-icon" for="__palette_1" hidden="" title="Switch to dark mode">
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M12 8a4 4 0 0 0-4 4 4 4 0 0 0 4 4 4 4 0 0 0 4-4 4 4 0 0 0-4-4m0 10a6 6 0 0 1-6-6 6 6 0 0 1 6-6 6 6 0 0 1 6 6 6 6 0 0 1-6 6m8-9.31V4h-4.69L12 .69 8.69 4H4v4.69L.69 12 4 15.31V20h4.69L12 23.31 15.31 20H20v-4.69L23.31 12z"></path></svg>
</label>
<input aria-label="Switch to light mode" class="md-option" data-md-color-accent="indigo" data-md-color-media="" data-md-color-primary="indigo" data-md-color-scheme="slate" id="__palette_1" name="__palette" type="radio"/>
<label class="md-header__button md-icon" for="__palette_0" hidden="" title="Switch to light mode">
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M12 18c-.89 0-1.74-.2-2.5-.55C11.56 16.5 13 14.42 13 12s-1.44-4.5-3.5-5.45C10.26 6.2 11.11 6 12 6a6 6 0 0 1 6 6 6 6 0 0 1-6 6m8-9.31V4h-4.69L12 .69 8.69 4H4v4.69L.69 12 4 15.31V20h4.69L12 23.31 15.31 20H20v-4.69L23.31 12z"></path></svg>
</label>
</form>
<script>var palette=__md_get("__palette");if(palette&&palette.color){if("(prefers-color-scheme)"===palette.color.media){var media=matchMedia("(prefers-color-scheme: light)"),input=document.querySelector(media.matches?"[data-md-color-media='(prefers-color-scheme: light)']":"[data-md-color-media='(prefers-color-scheme: dark)']");palette.color.media=input.getAttribute("data-md-color-media"),palette.color.scheme=input.getAttribute("data-md-color-scheme"),palette.color.primary=input.getAttribute("data-md-color-primary"),palette.color.accent=input.getAttribute("data-md-color-accent")}for(var[key,value]of Object.entries(palette.color))document.body.setAttribute("data-md-color-"+key,value)}</script>
<label class="md-header__button md-icon" for="__search">
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"></path></svg>
</label>
<div class="md-search" data-md-component="search" role="dialog">
<label class="md-search__overlay" for="__search"></label>
<div class="md-search__inner" role="search">
<form class="md-search__form" name="search">
<input aria-label="Search" autocapitalize="off" autocomplete="off" autocorrect="off" class="md-search__input" data-md-component="search-query" name="query" placeholder="Search" required="" spellcheck="false" type="text"/>
<label class="md-search__icon md-icon" for="__search">
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"></path></svg>
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"></path></svg>
</label>
<nav aria-label="Search" class="md-search__options">
<button aria-label="Clear" class="md-search__icon md-icon" tabindex="-1" title="Clear" type="reset">
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"></path></svg>
</button>
</nav>
<div class="md-search__suggest" data-md-component="search-suggest"></div>
</form>
<div class="md-search__output">
<div class="md-search__scrollwrap" data-md-scrollfix="" tabindex="0">
<div class="md-search-result" data-md-component="search-result">
<div class="md-search-result__meta">
            Initializing search
          </div>
<ol class="md-search-result__list" role="presentation"></ol>
</div>
</div>
</div>
</div>
</div>
<div class="md-header__source">
<a class="md-source" data-md-component="source" href="https://github.com/example/llm-mcp-learning-path" title="Go to repository">
<div class="md-source__icon md-icon">
<svg viewbox="0 0 448 512" xmlns="http://www.w3.org/2000/svg"><!--! Font Awesome Free 7.0.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path d="M439.6 236.1 244 40.5c-5.4-5.5-12.8-8.5-20.4-8.5s-15 3-20.4 8.4L162.5 81l51.5 51.5c27.1-9.1 52.7 16.8 43.4 43.7l49.7 49.7c34.2-11.8 61.2 31 35.5 56.7-26.5 26.5-70.2-2.9-56-37.3L240.3 199v121.9c25.3 12.5 22.3 41.8 9.1 55-6.4 6.4-15.2 10.1-24.3 10.1s-17.8-3.6-24.3-10.1c-17.6-17.6-11.1-46.9 11.2-56v-123c-20.8-8.5-24.6-30.7-18.6-45L142.6 101 8.5 235.1C3 240.6 0 247.9 0 255.5s3 15 8.5 20.4l195.6 195.7c5.4 5.4 12.7 8.4 20.4 8.4s15-3 20.4-8.4l194.7-194.7c5.4-5.4 8.4-12.8 8.4-20.4s-3-15-8.4-20.4"></path></svg>
</div>
<div class="md-source__repository">
    LLM-MCP-Learning-Path
  </div>
</a>
</div>
</nav>
</header>
<div class="md-container" data-md-component="container">
<nav aria-label="Tabs" class="md-tabs" data-md-component="tabs">
<div class="md-grid">
<ul class="md-tabs__list">
<li class="md-tabs__item">
<a class="md-tabs__link" href="../../../index.md">
        
  
  
    
  
  Home

      </a>
</li>
<li class="md-tabs__item">
<a class="md-tabs__link" href="../../../introduction/overview.md">
          
  
  
  Introduction

        </a>
</li>
<li class="md-tabs__item">
<a class="md-tabs__link" href="../../../foundations/ai-ml-fundamentals.md">
          
  
  
  Foundational Knowledge

        </a>
</li>
<li class="md-tabs__item">
<a class="md-tabs__link" href="../../../llms/architecture.md">
          
  
  
  Understanding LLMs

        </a>
</li>
<li class="md-tabs__item">
<a class="md-tabs__link" href="../../../agents/architecture.md">
          
  
  
  Building LLM Agents

        </a>
</li>
<li class="md-tabs__item">
<a class="md-tabs__link" href="../../../security/fundamentals.md">
          
  
  
  Security &amp; Safety

        </a>
</li>
<li class="md-tabs__item">
<a class="md-tabs__link" href="../../../performance/metrics.md">
          
  
  
  Performance Measurement

        </a>
</li>
<li class="md-tabs__item">
<a class="md-tabs__link" href="../../../mcp/fundamentals.md">
          
  
  
  Multi-Agent Platforms

        </a>
</li>
<li class="md-tabs__item">
<a class="md-tabs__link" href="../../../mcp-llm-connectivity/index.md">
          
  
  
  MCP-LLM Connectivity Patterns

        </a>
</li>
<li class="md-tabs__item">
<a class="md-tabs__link" href="../../../resources/learning.md">
          
  
  
  Resources

        </a>
</li>
<li class="md-tabs__item">
<a class="md-tabs__link" href="../../../capstone/overview.md">
          
  
  
  Capstone Project

        </a>
</li>
</ul>
</div>
</nav>
<main class="md-main" data-md-component="main">
<div class="md-main__inner md-grid">
<div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation">
<div class="md-sidebar__scrollwrap">
<div class="md-sidebar__inner">
<nav aria-label="Navigation" class="md-nav md-nav--primary md-nav--lifted" data-md-level="0">
<label class="md-nav__title" for="__drawer">
<a aria-label="LLM and Multi-Agent Collaboration Platforms - Learning Path" class="md-nav__button md-logo" data-md-component="logo" href="../../.." title="LLM and Multi-Agent Collaboration Platforms - Learning Path">
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54"></path></svg>
</a>
    LLM and Multi-Agent Collaboration Platforms - Learning Path
  </label>
<div class="md-nav__source">
<a class="md-source" data-md-component="source" href="https://github.com/example/llm-mcp-learning-path" title="Go to repository">
<div class="md-source__icon md-icon">
<svg viewbox="0 0 448 512" xmlns="http://www.w3.org/2000/svg"><!--! Font Awesome Free 7.0.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path d="M439.6 236.1 244 40.5c-5.4-5.5-12.8-8.5-20.4-8.5s-15 3-20.4 8.4L162.5 81l51.5 51.5c27.1-9.1 52.7 16.8 43.4 43.7l49.7 49.7c34.2-11.8 61.2 31 35.5 56.7-26.5 26.5-70.2-2.9-56-37.3L240.3 199v121.9c25.3 12.5 22.3 41.8 9.1 55-6.4 6.4-15.2 10.1-24.3 10.1s-17.8-3.6-24.3-10.1c-17.6-17.6-11.1-46.9 11.2-56v-123c-20.8-8.5-24.6-30.7-18.6-45L142.6 101 8.5 235.1C3 240.6 0 247.9 0 255.5s3 15 8.5 20.4l195.6 195.7c5.4 5.4 12.7 8.4 20.4 8.4s15-3 20.4-8.4l194.7-194.7c5.4-5.4 8.4-12.8 8.4-20.4s-3-15-8.4-20.4"></path></svg>
</div>
<div class="md-source__repository">
    LLM-MCP-Learning-Path
  </div>
</a>
</div>
<ul class="md-nav__list" data-md-scrollfix="">
<li class="md-nav__item">
<a class="md-nav__link" href="../../../index.md">
<span class="md-ellipsis">
    Home
    
  </span>
</a>
</li>
<li class="md-nav__item md-nav__item--nested">
<input class="md-nav__toggle md-toggle md-toggle--indeterminate" id="__nav_2" type="checkbox"/>
<label class="md-nav__link" for="__nav_2" id="__nav_2_label" tabindex="0">
<span class="md-ellipsis">
    Introduction
    
  </span>
<span class="md-nav__icon md-icon"></span>
</label>
<nav aria-expanded="false" aria-labelledby="__nav_2_label" class="md-nav" data-md-level="1">
<label class="md-nav__title" for="__nav_2">
<span class="md-nav__icon md-icon"></span>
            Introduction
          </label>
<ul class="md-nav__list" data-md-scrollfix="">
<li class="md-nav__item">
<a class="md-nav__link" href="../../../introduction/overview.md">
<span class="md-ellipsis">
    Overview
    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../../introduction/applications.md">
<span class="md-ellipsis">
    Applications
    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../../introduction/prerequisites.md">
<span class="md-ellipsis">
    Prerequisites
    
  </span>
</a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item md-nav__item--nested">
<input class="md-nav__toggle md-toggle md-toggle--indeterminate" id="__nav_3" type="checkbox"/>
<label class="md-nav__link" for="__nav_3" id="__nav_3_label" tabindex="0">
<span class="md-ellipsis">
    Foundational Knowledge
    
  </span>
<span class="md-nav__icon md-icon"></span>
</label>
<nav aria-expanded="false" aria-labelledby="__nav_3_label" class="md-nav" data-md-level="1">
<label class="md-nav__title" for="__nav_3">
<span class="md-nav__icon md-icon"></span>
            Foundational Knowledge
          </label>
<ul class="md-nav__list" data-md-scrollfix="">
<li class="md-nav__item">
<a class="md-nav__link" href="../../../foundations/ai-ml-fundamentals.md">
<span class="md-ellipsis">
    AI/ML Fundamentals
    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../../foundations/mathematics.md">
<span class="md-ellipsis">
    Mathematics for AI
    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../../foundations/programming.md">
<span class="md-ellipsis">
    Programming Essentials
    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../../foundations/deep-learning.md">
<span class="md-ellipsis">
    Deep Learning Basics
    
  </span>
</a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item md-nav__item--nested">
<input class="md-nav__toggle md-toggle md-toggle--indeterminate" id="__nav_4" type="checkbox"/>
<label class="md-nav__link" for="__nav_4" id="__nav_4_label" tabindex="0">
<span class="md-ellipsis">
    Understanding LLMs
    
  </span>
<span class="md-nav__icon md-icon"></span>
</label>
<nav aria-expanded="false" aria-labelledby="__nav_4_label" class="md-nav" data-md-level="1">
<label class="md-nav__title" for="__nav_4">
<span class="md-nav__icon md-icon"></span>
            Understanding LLMs
          </label>
<ul class="md-nav__list" data-md-scrollfix="">
<li class="md-nav__item">
<a class="md-nav__link" href="../../../llms/architecture.md">
<span class="md-ellipsis">
    LLM Architecture
    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../../llms/training.md">
<span class="md-ellipsis">
    Training Process
    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../../llms/fine-tuning.md">
<span class="md-ellipsis">
    Fine-tuning &amp; Adaptation
    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../../llms/prompt-engineering.md">
<span class="md-ellipsis">
    Prompt Engineering
    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../../llms/evaluation.md">
<span class="md-ellipsis">
    Model Evaluation
    
  </span>
</a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item md-nav__item--nested">
<input class="md-nav__toggle md-toggle md-toggle--indeterminate" id="__nav_5" type="checkbox"/>
<label class="md-nav__link" for="__nav_5" id="__nav_5_label" tabindex="0">
<span class="md-ellipsis">
    Building LLM Agents
    
  </span>
<span class="md-nav__icon md-icon"></span>
</label>
<nav aria-expanded="false" aria-labelledby="__nav_5_label" class="md-nav" data-md-level="1">
<label class="md-nav__title" for="__nav_5">
<span class="md-nav__icon md-icon"></span>
            Building LLM Agents
          </label>
<ul class="md-nav__list" data-md-scrollfix="">
<li class="md-nav__item">
<a class="md-nav__link" href="../../../agents/architecture.md">
<span class="md-ellipsis">
    Agent Architecture
    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../../agents/planning.md">
<span class="md-ellipsis">
    Planning &amp; Reasoning
    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../../agents/tools.md">
<span class="md-ellipsis">
    Tool Integration
    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../../agents/memory.md">
<span class="md-ellipsis">
    Memory Systems
    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../../agents/deployment.md">
<span class="md-ellipsis">
    Deployment Strategies
    
  </span>
</a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item md-nav__item--nested">
<input class="md-nav__toggle md-toggle md-toggle--indeterminate" id="__nav_6" type="checkbox"/>
<label class="md-nav__link" for="__nav_6" id="__nav_6_label" tabindex="0">
<span class="md-ellipsis">
    Security &amp; Safety
    
  </span>
<span class="md-nav__icon md-icon"></span>
</label>
<nav aria-expanded="false" aria-labelledby="__nav_6_label" class="md-nav" data-md-level="1">
<label class="md-nav__title" for="__nav_6">
<span class="md-nav__icon md-icon"></span>
            Security &amp; Safety
          </label>
<ul class="md-nav__list" data-md-scrollfix="">
<li class="md-nav__item">
<a class="md-nav__link" href="../../../security/fundamentals.md">
<span class="md-ellipsis">
    Security Fundamentals
    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../../security/vulnerabilities.md">
<span class="md-ellipsis">
    Common Vulnerabilities
    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../../security/alignment.md">
<span class="md-ellipsis">
    Safety Alignment
    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../../security/monitoring.md">
<span class="md-ellipsis">
    Monitoring &amp; Detection
    
  </span>
</a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item md-nav__item--nested">
<input class="md-nav__toggle md-toggle md-toggle--indeterminate" id="__nav_7" type="checkbox"/>
<label class="md-nav__link" for="__nav_7" id="__nav_7_label" tabindex="0">
<span class="md-ellipsis">
    Performance Measurement
    
  </span>
<span class="md-nav__icon md-icon"></span>
</label>
<nav aria-expanded="false" aria-labelledby="__nav_7_label" class="md-nav" data-md-level="1">
<label class="md-nav__title" for="__nav_7">
<span class="md-nav__icon md-icon"></span>
            Performance Measurement
          </label>
<ul class="md-nav__list" data-md-scrollfix="">
<li class="md-nav__item">
<a class="md-nav__link" href="../../../performance/metrics.md">
<span class="md-ellipsis">
    Evaluation Metrics
    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../../performance/benchmarking.md">
<span class="md-ellipsis">
    Benchmarking
    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../../performance/monitoring.md">
<span class="md-ellipsis">
    Monitoring Systems
    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../../performance/optimization.md">
<span class="md-ellipsis">
    Optimization Techniques
    
  </span>
</a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item md-nav__item--nested">
<input class="md-nav__toggle md-toggle md-toggle--indeterminate" id="__nav_8" type="checkbox"/>
<label class="md-nav__link" for="__nav_8" id="__nav_8_label" tabindex="0">
<span class="md-ellipsis">
    Multi-Agent Platforms
    
  </span>
<span class="md-nav__icon md-icon"></span>
</label>
<nav aria-expanded="false" aria-labelledby="__nav_8_label" class="md-nav" data-md-level="1">
<label class="md-nav__title" for="__nav_8">
<span class="md-nav__icon md-icon"></span>
            Multi-Agent Platforms
          </label>
<ul class="md-nav__list" data-md-scrollfix="">
<li class="md-nav__item">
<a class="md-nav__link" href="../../../mcp/fundamentals.md">
<span class="md-ellipsis">
    MCP Fundamentals
    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../../mcp/communication.md">
<span class="md-ellipsis">
    Agent Communication
    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../../mcp/coordination.md">
<span class="md-ellipsis">
    Coordination Strategies
    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../../mcp/frameworks.md">
<span class="md-ellipsis">
    Frameworks &amp; Tools
    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../../mcp/scaling.md">
<span class="md-ellipsis">
    Scaling Considerations
    
  </span>
</a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item md-nav__item--nested">
<input class="md-nav__toggle md-toggle md-toggle--indeterminate" id="__nav_9" type="checkbox"/>
<label class="md-nav__link" for="__nav_9" id="__nav_9_label" tabindex="0">
<span class="md-ellipsis">
    MCP-LLM Connectivity Patterns
    
  </span>
<span class="md-nav__icon md-icon"></span>
</label>
<nav aria-expanded="false" aria-labelledby="__nav_9_label" class="md-nav" data-md-level="1">
<label class="md-nav__title" for="__nav_9">
<span class="md-nav__icon md-icon"></span>
            MCP-LLM Connectivity Patterns
          </label>
<ul class="md-nav__list" data-md-scrollfix="">
<li class="md-nav__item">
<a class="md-nav__link" href="../../../mcp-llm-connectivity/index.md">
<span class="md-ellipsis">
    Overview
    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../../mcp-llm-connectivity/basic-flow.md">
<span class="md-ellipsis">
    Basic Communication Flow
    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../../mcp-llm-connectivity/tool-integration.md">
<span class="md-ellipsis">
    Tool Integration
    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../../mcp-llm-connectivity/multi-agent.md">
<span class="md-ellipsis">
    Multi-Agent Systems
    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../../mcp-llm-connectivity/enterprise-architecture.md">
<span class="md-ellipsis">
    Enterprise Architecture
    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../../mcp-llm-connectivity/real-time-streaming.md">
<span class="md-ellipsis">
    Real-Time Streaming
    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../../mcp-llm-connectivity/security-patterns.md">
<span class="md-ellipsis">
    Security Patterns
    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../../mcp-llm-connectivity/scaling-patterns.md">
<span class="md-ellipsis">
    Scaling Patterns
    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../../mcp-llm-connectivity/data-flow.md">
<span class="md-ellipsis">
    Data Flow Patterns
    
  </span>
</a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item md-nav__item--nested">
<input class="md-nav__toggle md-toggle md-toggle--indeterminate" id="__nav_10" type="checkbox"/>
<label class="md-nav__link" for="__nav_10" id="__nav_10_label" tabindex="0">
<span class="md-ellipsis">
    Resources
    
  </span>
<span class="md-nav__icon md-icon"></span>
</label>
<nav aria-expanded="false" aria-labelledby="__nav_10_label" class="md-nav" data-md-level="1">
<label class="md-nav__title" for="__nav_10">
<span class="md-nav__icon md-icon"></span>
            Resources
          </label>
<ul class="md-nav__list" data-md-scrollfix="">
<li class="md-nav__item">
<a class="md-nav__link" href="../../../resources/learning.md">
<span class="md-ellipsis">
    Learning Resources
    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../../resources/tools.md">
<span class="md-ellipsis">
    Tools &amp; Libraries
    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../../resources/communities.md">
<span class="md-ellipsis">
    Communities
    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../../resources/updates.md">
<span class="md-ellipsis">
    Staying Updated
    
  </span>
</a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item md-nav__item--nested">
<input class="md-nav__toggle md-toggle md-toggle--indeterminate" id="__nav_11" type="checkbox"/>
<label class="md-nav__link" for="__nav_11" id="__nav_11_label" tabindex="0">
<span class="md-ellipsis">
    Capstone Project
    
  </span>
<span class="md-nav__icon md-icon"></span>
</label>
<nav aria-expanded="false" aria-labelledby="__nav_11_label" class="md-nav" data-md-level="1">
<label class="md-nav__title" for="__nav_11">
<span class="md-nav__icon md-icon"></span>
            Capstone Project
          </label>
<ul class="md-nav__list" data-md-scrollfix="">
<li class="md-nav__item">
<a class="md-nav__link" href="../../../capstone/overview.md">
<span class="md-ellipsis">
    Project Overview
    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../../capstone/planning.md">
<span class="md-ellipsis">
    Planning Phase
    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../../capstone/implementation.md">
<span class="md-ellipsis">
    Implementation
    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../../capstone/evaluation.md">
<span class="md-ellipsis">
    Evaluation
    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../../capstone/documentation.md">
<span class="md-ellipsis">
    Documentation
    
  </span>
</a>
</li>
</ul>
</nav>
</li>
</ul>
</nav>
</div>
</div>
</div>
<div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc">
<div class="md-sidebar__scrollwrap">
<div class="md-sidebar__inner">
<nav aria-label="Table of contents" class="md-nav md-nav--secondary">
<label class="md-nav__title" for="__toc">
<span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
<ul class="md-nav__list" data-md-component="toc" data-md-scrollfix="">
<li class="md-nav__item">
<a class="md-nav__link" href="#fine-tuning-fundamentals">
<span class="md-ellipsis">
      🎯 Fine-tuning Fundamentals
    </span>
</a>
<nav aria-label="🎯 Fine-tuning Fundamentals" class="md-nav">
<ul class="md-nav__list">
<li class="md-nav__item">
<a class="md-nav__link" href="#types-of-fine-tuning">
<span class="md-ellipsis">
      Types of Fine-tuning
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#when-to-fine-tune-vs-prompt-engineering">
<span class="md-ellipsis">
      When to Fine-tune vs. Prompt Engineering
    </span>
</a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#parameter-efficient-fine-tuning-peft">
<span class="md-ellipsis">
      🔧 Parameter-Efficient Fine-tuning (PEFT)
    </span>
</a>
<nav aria-label="🔧 Parameter-Efficient Fine-tuning (PEFT)" class="md-nav">
<ul class="md-nav__list">
<li class="md-nav__item">
<a class="md-nav__link" href="#lora-low-rank-adaptation">
<span class="md-ellipsis">
      LoRA (Low-Rank Adaptation)
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#other-peft-methods">
<span class="md-ellipsis">
      Other PEFT Methods
    </span>
</a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#domain-specific-fine-tuning">
<span class="md-ellipsis">
      📚 Domain-Specific Fine-tuning
    </span>
</a>
<nav aria-label="📚 Domain-Specific Fine-tuning" class="md-nav">
<ul class="md-nav__list">
<li class="md-nav__item">
<a class="md-nav__link" href="#medical-domain-example">
<span class="md-ellipsis">
      Medical Domain Example
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#code-generation-fine-tuning">
<span class="md-ellipsis">
      Code Generation Fine-tuning
    </span>
</a>
</li>
</ul>
</nav>
</li>
</ul>
</nav>
</div>
</div>
</div>
<div class="md-content" data-md-component="content">
<article class="md-content__inner md-typeset">
<h1 id="fine-tuning-adaptation-customizing-llms-for-specific-tasks">Fine-tuning &amp; Adaptation: Customizing LLMs for Specific Tasks</h1>
<p>Fine-tuning allows you to adapt pre-trained language models for specific domains, tasks, or use cases. This section covers various fine-tuning approaches and their applications in agent systems.</p>
<h2 id="fine-tuning-fundamentals">🎯 Fine-tuning Fundamentals</h2>
<h3 id="types-of-fine-tuning">Types of Fine-tuning</h3>
<pre class="mermaid"><code>graph TD
    A[Pre-trained Base Model] --&gt; B[Full Fine-tuning]
    A --&gt; C[Parameter-Efficient Fine-tuning]
    A --&gt; D[In-Context Learning]

    B --&gt; E[Task-Specific Model]
    C --&gt; F[LoRA Adapters]
    C --&gt; G[Prefix Tuning]
    C --&gt; H[P-Tuning]
    D --&gt; I[Few-shot Prompting]</code></pre>
<p><strong>Full Fine-tuning</strong>: Update all model parameters</p>
<p><strong>Parameter-Efficient</strong>: Update only a subset of parameters</p>
<p><strong>In-Context Learning</strong>: No parameter updates, only prompting</p>
<h3 id="when-to-fine-tune-vs-prompt-engineering">When to Fine-tune vs. Prompt Engineering</h3>
<table>
<thead>
<tr>
<th>Approach</th>
<th>Best For</th>
<th>Pros</th>
<th>Cons</th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>Fine-tuning</strong></td>
<td>Domain-specific tasks, Consistent performance</td>
<td>Higher accuracy, Specialized behavior</td>
<td>Resource-intensive, Risk of overfitting</td>
</tr>
<tr>
<td><strong>Prompt Engineering</strong></td>
<td>General tasks, Quick iteration</td>
<td>Fast, No training needed</td>
<td>Less consistent, Token limit constraints</td>
</tr>
<tr>
<td><strong>RAG</strong></td>
<td>Knowledge-intensive tasks</td>
<td>Up-to-date info, Factual accuracy</td>
<td>Complex architecture, Retrieval quality dependency</td>
</tr>
</tbody>
</table>
<h2 id="parameter-efficient-fine-tuning-peft">🔧 Parameter-Efficient Fine-tuning (PEFT)</h2>
<h3 id="lora-low-rank-adaptation">LoRA (Low-Rank Adaptation)</h3>
<p><strong>LoRA Implementation</strong>:
<div class="highlight"><pre><span></span><code><a href="#__codelineno-0-1" id="__codelineno-0-1" name="__codelineno-0-1"></a><span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>
<a href="#__codelineno-0-2" id="__codelineno-0-2" name="__codelineno-0-2"></a><span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">Dict</span><span class="p">,</span> <span class="n">List</span><span class="p">,</span> <span class="n">Tuple</span>
<a href="#__codelineno-0-3" id="__codelineno-0-3" name="__codelineno-0-3"></a>
<a href="#__codelineno-0-4" id="__codelineno-0-4" name="__codelineno-0-4"></a><span class="k">class</span><span class="w"> </span><span class="nc">LoRALayer</span><span class="p">:</span>
<a href="#__codelineno-0-5" id="__codelineno-0-5" name="__codelineno-0-5"></a><span class="w">    </span><span class="sd">"""Low-Rank Adaptation layer for parameter-efficient fine-tuning"""</span>
<a href="#__codelineno-0-6" id="__codelineno-0-6" name="__codelineno-0-6"></a>
<a href="#__codelineno-0-7" id="__codelineno-0-7" name="__codelineno-0-7"></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> 
<a href="#__codelineno-0-8" id="__codelineno-0-8" name="__codelineno-0-8"></a>                 <span class="n">in_features</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> 
<a href="#__codelineno-0-9" id="__codelineno-0-9" name="__codelineno-0-9"></a>                 <span class="n">out_features</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> 
<a href="#__codelineno-0-10" id="__codelineno-0-10" name="__codelineno-0-10"></a>                 <span class="n">rank</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">16</span><span class="p">,</span> 
<a href="#__codelineno-0-11" id="__codelineno-0-11" name="__codelineno-0-11"></a>                 <span class="n">alpha</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">32</span><span class="p">,</span>
<a href="#__codelineno-0-12" id="__codelineno-0-12" name="__codelineno-0-12"></a>                 <span class="n">dropout</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.1</span><span class="p">):</span>
<a href="#__codelineno-0-13" id="__codelineno-0-13" name="__codelineno-0-13"></a>
<a href="#__codelineno-0-14" id="__codelineno-0-14" name="__codelineno-0-14"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">in_features</span> <span class="o">=</span> <span class="n">in_features</span>
<a href="#__codelineno-0-15" id="__codelineno-0-15" name="__codelineno-0-15"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">out_features</span> <span class="o">=</span> <span class="n">out_features</span>
<a href="#__codelineno-0-16" id="__codelineno-0-16" name="__codelineno-0-16"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">rank</span> <span class="o">=</span> <span class="n">rank</span>
<a href="#__codelineno-0-17" id="__codelineno-0-17" name="__codelineno-0-17"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">alpha</span> <span class="o">=</span> <span class="n">alpha</span>
<a href="#__codelineno-0-18" id="__codelineno-0-18" name="__codelineno-0-18"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">dropout</span> <span class="o">=</span> <span class="n">dropout</span>
<a href="#__codelineno-0-19" id="__codelineno-0-19" name="__codelineno-0-19"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">scaling</span> <span class="o">=</span> <span class="n">alpha</span> <span class="o">/</span> <span class="n">rank</span>
<a href="#__codelineno-0-20" id="__codelineno-0-20" name="__codelineno-0-20"></a>
<a href="#__codelineno-0-21" id="__codelineno-0-21" name="__codelineno-0-21"></a>        <span class="c1"># LoRA matrices: W = W_0 + (B @ A) * scaling</span>
<a href="#__codelineno-0-22" id="__codelineno-0-22" name="__codelineno-0-22"></a>        <span class="c1"># A: (in_features, rank), B: (rank, out_features)</span>
<a href="#__codelineno-0-23" id="__codelineno-0-23" name="__codelineno-0-23"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">lora_A</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">randn</span><span class="p">(</span><span class="n">in_features</span><span class="p">,</span> <span class="n">rank</span><span class="p">)</span> <span class="o">*</span> <span class="mf">0.01</span>
<a href="#__codelineno-0-24" id="__codelineno-0-24" name="__codelineno-0-24"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">lora_B</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">rank</span><span class="p">,</span> <span class="n">out_features</span><span class="p">))</span>
<a href="#__codelineno-0-25" id="__codelineno-0-25" name="__codelineno-0-25"></a>
<a href="#__codelineno-0-26" id="__codelineno-0-26" name="__codelineno-0-26"></a>        <span class="c1"># Store original frozen weights (would be loaded from pre-trained model)</span>
<a href="#__codelineno-0-27" id="__codelineno-0-27" name="__codelineno-0-27"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">original_weight</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">randn</span><span class="p">(</span><span class="n">in_features</span><span class="p">,</span> <span class="n">out_features</span><span class="p">)</span> <span class="o">*</span> <span class="mf">0.02</span>
<a href="#__codelineno-0-28" id="__codelineno-0-28" name="__codelineno-0-28"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">frozen</span> <span class="o">=</span> <span class="kc">True</span>
<a href="#__codelineno-0-29" id="__codelineno-0-29" name="__codelineno-0-29"></a>
<a href="#__codelineno-0-30" id="__codelineno-0-30" name="__codelineno-0-30"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
<a href="#__codelineno-0-31" id="__codelineno-0-31" name="__codelineno-0-31"></a><span class="w">        </span><span class="sd">"""Forward pass with LoRA adaptation"""</span>
<a href="#__codelineno-0-32" id="__codelineno-0-32" name="__codelineno-0-32"></a>        <span class="c1"># Original computation (frozen)</span>
<a href="#__codelineno-0-33" id="__codelineno-0-33" name="__codelineno-0-33"></a>        <span class="n">original_output</span> <span class="o">=</span> <span class="n">x</span> <span class="o">@</span> <span class="bp">self</span><span class="o">.</span><span class="n">original_weight</span>
<a href="#__codelineno-0-34" id="__codelineno-0-34" name="__codelineno-0-34"></a>
<a href="#__codelineno-0-35" id="__codelineno-0-35" name="__codelineno-0-35"></a>        <span class="c1"># LoRA adaptation</span>
<a href="#__codelineno-0-36" id="__codelineno-0-36" name="__codelineno-0-36"></a>        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">frozen</span><span class="p">:</span>
<a href="#__codelineno-0-37" id="__codelineno-0-37" name="__codelineno-0-37"></a>            <span class="n">lora_output</span> <span class="o">=</span> <span class="p">(</span><span class="n">x</span> <span class="o">@</span> <span class="bp">self</span><span class="o">.</span><span class="n">lora_A</span><span class="p">)</span> <span class="o">@</span> <span class="bp">self</span><span class="o">.</span><span class="n">lora_B</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">scaling</span>
<a href="#__codelineno-0-38" id="__codelineno-0-38" name="__codelineno-0-38"></a>            <span class="k">return</span> <span class="n">original_output</span> <span class="o">+</span> <span class="n">lora_output</span>
<a href="#__codelineno-0-39" id="__codelineno-0-39" name="__codelineno-0-39"></a>
<a href="#__codelineno-0-40" id="__codelineno-0-40" name="__codelineno-0-40"></a>        <span class="k">return</span> <span class="n">original_output</span>
<a href="#__codelineno-0-41" id="__codelineno-0-41" name="__codelineno-0-41"></a>
<a href="#__codelineno-0-42" id="__codelineno-0-42" name="__codelineno-0-42"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">get_merged_weight</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
<a href="#__codelineno-0-43" id="__codelineno-0-43" name="__codelineno-0-43"></a><span class="w">        </span><span class="sd">"""Get the merged weight matrix (original + LoRA adaptation)"""</span>
<a href="#__codelineno-0-44" id="__codelineno-0-44" name="__codelineno-0-44"></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">original_weight</span> <span class="o">+</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">lora_A</span> <span class="o">@</span> <span class="bp">self</span><span class="o">.</span><span class="n">lora_B</span><span class="p">)</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">scaling</span>
<a href="#__codelineno-0-45" id="__codelineno-0-45" name="__codelineno-0-45"></a>
<a href="#__codelineno-0-46" id="__codelineno-0-46" name="__codelineno-0-46"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">get_trainable_parameters</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">]:</span>
<a href="#__codelineno-0-47" id="__codelineno-0-47" name="__codelineno-0-47"></a><span class="w">        </span><span class="sd">"""Return only the trainable LoRA parameters"""</span>
<a href="#__codelineno-0-48" id="__codelineno-0-48" name="__codelineno-0-48"></a>        <span class="k">return</span> <span class="p">{</span>
<a href="#__codelineno-0-49" id="__codelineno-0-49" name="__codelineno-0-49"></a>            <span class="s1">'lora_A'</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">lora_A</span><span class="p">,</span>
<a href="#__codelineno-0-50" id="__codelineno-0-50" name="__codelineno-0-50"></a>            <span class="s1">'lora_B'</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">lora_B</span>
<a href="#__codelineno-0-51" id="__codelineno-0-51" name="__codelineno-0-51"></a>        <span class="p">}</span>
<a href="#__codelineno-0-52" id="__codelineno-0-52" name="__codelineno-0-52"></a>
<a href="#__codelineno-0-53" id="__codelineno-0-53" name="__codelineno-0-53"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">update_parameters</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">gradients</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">],</span> <span class="n">learning_rate</span><span class="p">:</span> <span class="nb">float</span><span class="p">):</span>
<a href="#__codelineno-0-54" id="__codelineno-0-54" name="__codelineno-0-54"></a><span class="w">        </span><span class="sd">"""Update LoRA parameters"""</span>
<a href="#__codelineno-0-55" id="__codelineno-0-55" name="__codelineno-0-55"></a>        <span class="k">if</span> <span class="s1">'lora_A'</span> <span class="ow">in</span> <span class="n">gradients</span><span class="p">:</span>
<a href="#__codelineno-0-56" id="__codelineno-0-56" name="__codelineno-0-56"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">lora_A</span> <span class="o">-=</span> <span class="n">learning_rate</span> <span class="o">*</span> <span class="n">gradients</span><span class="p">[</span><span class="s1">'lora_A'</span><span class="p">]</span>
<a href="#__codelineno-0-57" id="__codelineno-0-57" name="__codelineno-0-57"></a>        <span class="k">if</span> <span class="s1">'lora_B'</span> <span class="ow">in</span> <span class="n">gradients</span><span class="p">:</span>
<a href="#__codelineno-0-58" id="__codelineno-0-58" name="__codelineno-0-58"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">lora_B</span> <span class="o">-=</span> <span class="n">learning_rate</span> <span class="o">*</span> <span class="n">gradients</span><span class="p">[</span><span class="s1">'lora_B'</span><span class="p">]</span>
<a href="#__codelineno-0-59" id="__codelineno-0-59" name="__codelineno-0-59"></a>
<a href="#__codelineno-0-60" id="__codelineno-0-60" name="__codelineno-0-60"></a><span class="k">class</span><span class="w"> </span><span class="nc">LoRATransformerBlock</span><span class="p">:</span>
<a href="#__codelineno-0-61" id="__codelineno-0-61" name="__codelineno-0-61"></a><span class="w">    </span><span class="sd">"""Transformer block with LoRA adaptations"""</span>
<a href="#__codelineno-0-62" id="__codelineno-0-62" name="__codelineno-0-62"></a>
<a href="#__codelineno-0-63" id="__codelineno-0-63" name="__codelineno-0-63"></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">d_model</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">rank</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">16</span><span class="p">):</span>
<a href="#__codelineno-0-64" id="__codelineno-0-64" name="__codelineno-0-64"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">d_model</span> <span class="o">=</span> <span class="n">d_model</span>
<a href="#__codelineno-0-65" id="__codelineno-0-65" name="__codelineno-0-65"></a>
<a href="#__codelineno-0-66" id="__codelineno-0-66" name="__codelineno-0-66"></a>        <span class="c1"># Add LoRA to attention projections</span>
<a href="#__codelineno-0-67" id="__codelineno-0-67" name="__codelineno-0-67"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">q_lora</span> <span class="o">=</span> <span class="n">LoRALayer</span><span class="p">(</span><span class="n">d_model</span><span class="p">,</span> <span class="n">d_model</span><span class="p">,</span> <span class="n">rank</span><span class="p">)</span>
<a href="#__codelineno-0-68" id="__codelineno-0-68" name="__codelineno-0-68"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">k_lora</span> <span class="o">=</span> <span class="n">LoRALayer</span><span class="p">(</span><span class="n">d_model</span><span class="p">,</span> <span class="n">d_model</span><span class="p">,</span> <span class="n">rank</span><span class="p">)</span>
<a href="#__codelineno-0-69" id="__codelineno-0-69" name="__codelineno-0-69"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">v_lora</span> <span class="o">=</span> <span class="n">LoRALayer</span><span class="p">(</span><span class="n">d_model</span><span class="p">,</span> <span class="n">d_model</span><span class="p">,</span> <span class="n">rank</span><span class="p">)</span>
<a href="#__codelineno-0-70" id="__codelineno-0-70" name="__codelineno-0-70"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">o_lora</span> <span class="o">=</span> <span class="n">LoRALayer</span><span class="p">(</span><span class="n">d_model</span><span class="p">,</span> <span class="n">d_model</span><span class="p">,</span> <span class="n">rank</span><span class="p">)</span>
<a href="#__codelineno-0-71" id="__codelineno-0-71" name="__codelineno-0-71"></a>
<a href="#__codelineno-0-72" id="__codelineno-0-72" name="__codelineno-0-72"></a>        <span class="c1"># Add LoRA to feed-forward layers</span>
<a href="#__codelineno-0-73" id="__codelineno-0-73" name="__codelineno-0-73"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">ff1_lora</span> <span class="o">=</span> <span class="n">LoRALayer</span><span class="p">(</span><span class="n">d_model</span><span class="p">,</span> <span class="n">d_model</span> <span class="o">*</span> <span class="mi">4</span><span class="p">,</span> <span class="n">rank</span><span class="p">)</span>
<a href="#__codelineno-0-74" id="__codelineno-0-74" name="__codelineno-0-74"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">ff2_lora</span> <span class="o">=</span> <span class="n">LoRALayer</span><span class="p">(</span><span class="n">d_model</span> <span class="o">*</span> <span class="mi">4</span><span class="p">,</span> <span class="n">d_model</span><span class="p">,</span> <span class="n">rank</span><span class="p">)</span>
<a href="#__codelineno-0-75" id="__codelineno-0-75" name="__codelineno-0-75"></a>
<a href="#__codelineno-0-76" id="__codelineno-0-76" name="__codelineno-0-76"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">lora_layers</span> <span class="o">=</span> <span class="p">[</span>
<a href="#__codelineno-0-77" id="__codelineno-0-77" name="__codelineno-0-77"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">q_lora</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">k_lora</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">v_lora</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">o_lora</span><span class="p">,</span>
<a href="#__codelineno-0-78" id="__codelineno-0-78" name="__codelineno-0-78"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">ff1_lora</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">ff2_lora</span>
<a href="#__codelineno-0-79" id="__codelineno-0-79" name="__codelineno-0-79"></a>        <span class="p">]</span>
<a href="#__codelineno-0-80" id="__codelineno-0-80" name="__codelineno-0-80"></a>
<a href="#__codelineno-0-81" id="__codelineno-0-81" name="__codelineno-0-81"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">enable_training</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<a href="#__codelineno-0-82" id="__codelineno-0-82" name="__codelineno-0-82"></a><span class="w">        </span><span class="sd">"""Enable LoRA training mode"""</span>
<a href="#__codelineno-0-83" id="__codelineno-0-83" name="__codelineno-0-83"></a>        <span class="k">for</span> <span class="n">layer</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">lora_layers</span><span class="p">:</span>
<a href="#__codelineno-0-84" id="__codelineno-0-84" name="__codelineno-0-84"></a>            <span class="n">layer</span><span class="o">.</span><span class="n">frozen</span> <span class="o">=</span> <span class="kc">False</span>
<a href="#__codelineno-0-85" id="__codelineno-0-85" name="__codelineno-0-85"></a>
<a href="#__codelineno-0-86" id="__codelineno-0-86" name="__codelineno-0-86"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">get_trainable_parameters</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">]:</span>
<a href="#__codelineno-0-87" id="__codelineno-0-87" name="__codelineno-0-87"></a><span class="w">        </span><span class="sd">"""Get all trainable LoRA parameters"""</span>
<a href="#__codelineno-0-88" id="__codelineno-0-88" name="__codelineno-0-88"></a>        <span class="n">params</span> <span class="o">=</span> <span class="p">{}</span>
<a href="#__codelineno-0-89" id="__codelineno-0-89" name="__codelineno-0-89"></a>        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">layer</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">lora_layers</span><span class="p">):</span>
<a href="#__codelineno-0-90" id="__codelineno-0-90" name="__codelineno-0-90"></a>            <span class="n">layer_params</span> <span class="o">=</span> <span class="n">layer</span><span class="o">.</span><span class="n">get_trainable_parameters</span><span class="p">()</span>
<a href="#__codelineno-0-91" id="__codelineno-0-91" name="__codelineno-0-91"></a>            <span class="k">for</span> <span class="n">param_name</span><span class="p">,</span> <span class="n">param_value</span> <span class="ow">in</span> <span class="n">layer_params</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
<a href="#__codelineno-0-92" id="__codelineno-0-92" name="__codelineno-0-92"></a>                <span class="n">params</span><span class="p">[</span><span class="sa">f</span><span class="s1">'layer_</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s1">_</span><span class="si">{</span><span class="n">param_name</span><span class="si">}</span><span class="s1">'</span><span class="p">]</span> <span class="o">=</span> <span class="n">param_value</span>
<a href="#__codelineno-0-93" id="__codelineno-0-93" name="__codelineno-0-93"></a>        <span class="k">return</span> <span class="n">params</span>
<a href="#__codelineno-0-94" id="__codelineno-0-94" name="__codelineno-0-94"></a>
<a href="#__codelineno-0-95" id="__codelineno-0-95" name="__codelineno-0-95"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">calculate_parameter_efficiency</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">original_model_params</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">float</span><span class="p">]:</span>
<a href="#__codelineno-0-96" id="__codelineno-0-96" name="__codelineno-0-96"></a><span class="w">        </span><span class="sd">"""Calculate parameter efficiency metrics"""</span>
<a href="#__codelineno-0-97" id="__codelineno-0-97" name="__codelineno-0-97"></a>        <span class="n">trainable_params</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span>
<a href="#__codelineno-0-98" id="__codelineno-0-98" name="__codelineno-0-98"></a>            <span class="n">param</span><span class="o">.</span><span class="n">size</span> <span class="k">for</span> <span class="n">param</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_trainable_parameters</span><span class="p">()</span><span class="o">.</span><span class="n">values</span><span class="p">()</span>
<a href="#__codelineno-0-99" id="__codelineno-0-99" name="__codelineno-0-99"></a>        <span class="p">)</span>
<a href="#__codelineno-0-100" id="__codelineno-0-100" name="__codelineno-0-100"></a>
<a href="#__codelineno-0-101" id="__codelineno-0-101" name="__codelineno-0-101"></a>        <span class="n">efficiency</span> <span class="o">=</span> <span class="p">{</span>
<a href="#__codelineno-0-102" id="__codelineno-0-102" name="__codelineno-0-102"></a>            <span class="s1">'original_params'</span><span class="p">:</span> <span class="n">original_model_params</span><span class="p">,</span>
<a href="#__codelineno-0-103" id="__codelineno-0-103" name="__codelineno-0-103"></a>            <span class="s1">'trainable_params'</span><span class="p">:</span> <span class="n">trainable_params</span><span class="p">,</span>
<a href="#__codelineno-0-104" id="__codelineno-0-104" name="__codelineno-0-104"></a>            <span class="s1">'efficiency_ratio'</span><span class="p">:</span> <span class="n">trainable_params</span> <span class="o">/</span> <span class="n">original_model_params</span><span class="p">,</span>
<a href="#__codelineno-0-105" id="__codelineno-0-105" name="__codelineno-0-105"></a>            <span class="s1">'reduction_factor'</span><span class="p">:</span> <span class="n">original_model_params</span> <span class="o">/</span> <span class="n">trainable_params</span><span class="p">,</span>
<a href="#__codelineno-0-106" id="__codelineno-0-106" name="__codelineno-0-106"></a>            <span class="s1">'trainable_percentage'</span><span class="p">:</span> <span class="p">(</span><span class="n">trainable_params</span> <span class="o">/</span> <span class="n">original_model_params</span><span class="p">)</span> <span class="o">*</span> <span class="mi">100</span>
<a href="#__codelineno-0-107" id="__codelineno-0-107" name="__codelineno-0-107"></a>        <span class="p">}</span>
<a href="#__codelineno-0-108" id="__codelineno-0-108" name="__codelineno-0-108"></a>
<a href="#__codelineno-0-109" id="__codelineno-0-109" name="__codelineno-0-109"></a>        <span class="k">return</span> <span class="n">efficiency</span>
<a href="#__codelineno-0-110" id="__codelineno-0-110" name="__codelineno-0-110"></a>
<a href="#__codelineno-0-111" id="__codelineno-0-111" name="__codelineno-0-111"></a><span class="c1"># Example LoRA usage</span>
<a href="#__codelineno-0-112" id="__codelineno-0-112" name="__codelineno-0-112"></a><span class="n">lora_block</span> <span class="o">=</span> <span class="n">LoRATransformerBlock</span><span class="p">(</span><span class="n">d_model</span><span class="o">=</span><span class="mi">768</span><span class="p">,</span> <span class="n">rank</span><span class="o">=</span><span class="mi">16</span><span class="p">)</span>
<a href="#__codelineno-0-113" id="__codelineno-0-113" name="__codelineno-0-113"></a><span class="n">lora_block</span><span class="o">.</span><span class="n">enable_training</span><span class="p">()</span>
<a href="#__codelineno-0-114" id="__codelineno-0-114" name="__codelineno-0-114"></a>
<a href="#__codelineno-0-115" id="__codelineno-0-115" name="__codelineno-0-115"></a><span class="c1"># Calculate efficiency</span>
<a href="#__codelineno-0-116" id="__codelineno-0-116" name="__codelineno-0-116"></a><span class="n">original_params</span> <span class="o">=</span> <span class="mi">12</span> <span class="o">*</span> <span class="mi">768</span> <span class="o">*</span> <span class="mi">768</span>  <span class="c1"># Simplified transformer block parameter count</span>
<a href="#__codelineno-0-117" id="__codelineno-0-117" name="__codelineno-0-117"></a><span class="n">efficiency_stats</span> <span class="o">=</span> <span class="n">lora_block</span><span class="o">.</span><span class="n">calculate_parameter_efficiency</span><span class="p">(</span><span class="n">original_params</span><span class="p">)</span>
<a href="#__codelineno-0-118" id="__codelineno-0-118" name="__codelineno-0-118"></a>
<a href="#__codelineno-0-119" id="__codelineno-0-119" name="__codelineno-0-119"></a><span class="nb">print</span><span class="p">(</span><span class="s2">"LoRA Parameter Efficiency:"</span><span class="p">)</span>
<a href="#__codelineno-0-120" id="__codelineno-0-120" name="__codelineno-0-120"></a><span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">efficiency_stats</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
<a href="#__codelineno-0-121" id="__codelineno-0-121" name="__codelineno-0-121"></a>    <span class="k">if</span> <span class="s1">'percentage'</span> <span class="ow">in</span> <span class="n">key</span> <span class="ow">or</span> <span class="s1">'ratio'</span> <span class="ow">in</span> <span class="n">key</span><span class="p">:</span>
<a href="#__codelineno-0-122" id="__codelineno-0-122" name="__codelineno-0-122"></a>        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"</span><span class="si">{</span><span class="n">key</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">value</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">%"</span><span class="p">)</span>
<a href="#__codelineno-0-123" id="__codelineno-0-123" name="__codelineno-0-123"></a>    <span class="k">else</span><span class="p">:</span>
<a href="#__codelineno-0-124" id="__codelineno-0-124" name="__codelineno-0-124"></a>        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"</span><span class="si">{</span><span class="n">key</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">value</span><span class="si">:</span><span class="s2">,</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
</code></pre></div></p>
<h3 id="other-peft-methods">Other PEFT Methods</h3>
<p><strong>Prefix Tuning</strong>:
<div class="highlight"><pre><span></span><code><a href="#__codelineno-1-1" id="__codelineno-1-1" name="__codelineno-1-1"></a><span class="k">class</span><span class="w"> </span><span class="nc">PrefixTuning</span><span class="p">:</span>
<a href="#__codelineno-1-2" id="__codelineno-1-2" name="__codelineno-1-2"></a><span class="w">    </span><span class="sd">"""Prefix tuning for parameter-efficient adaptation"""</span>
<a href="#__codelineno-1-3" id="__codelineno-1-3" name="__codelineno-1-3"></a>
<a href="#__codelineno-1-4" id="__codelineno-1-4" name="__codelineno-1-4"></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">d_model</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">prefix_length</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">10</span><span class="p">,</span> <span class="n">num_layers</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">12</span><span class="p">):</span>
<a href="#__codelineno-1-5" id="__codelineno-1-5" name="__codelineno-1-5"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">d_model</span> <span class="o">=</span> <span class="n">d_model</span>
<a href="#__codelineno-1-6" id="__codelineno-1-6" name="__codelineno-1-6"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">prefix_length</span> <span class="o">=</span> <span class="n">prefix_length</span>
<a href="#__codelineno-1-7" id="__codelineno-1-7" name="__codelineno-1-7"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">num_layers</span> <span class="o">=</span> <span class="n">num_layers</span>
<a href="#__codelineno-1-8" id="__codelineno-1-8" name="__codelineno-1-8"></a>
<a href="#__codelineno-1-9" id="__codelineno-1-9" name="__codelineno-1-9"></a>        <span class="c1"># Learnable prefix parameters for each layer</span>
<a href="#__codelineno-1-10" id="__codelineno-1-10" name="__codelineno-1-10"></a>        <span class="c1"># Shape: (num_layers, prefix_length, d_model)</span>
<a href="#__codelineno-1-11" id="__codelineno-1-11" name="__codelineno-1-11"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">prefix_embeddings</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">randn</span><span class="p">(</span><span class="n">num_layers</span><span class="p">,</span> <span class="n">prefix_length</span><span class="p">,</span> <span class="n">d_model</span><span class="p">)</span> <span class="o">*</span> <span class="mf">0.01</span>
<a href="#__codelineno-1-12" id="__codelineno-1-12" name="__codelineno-1-12"></a>
<a href="#__codelineno-1-13" id="__codelineno-1-13" name="__codelineno-1-13"></a>        <span class="c1"># MLP for reparameterization (optional)</span>
<a href="#__codelineno-1-14" id="__codelineno-1-14" name="__codelineno-1-14"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">prefix_mlp_hidden</span> <span class="o">=</span> <span class="n">d_model</span> <span class="o">*</span> <span class="mi">2</span>
<a href="#__codelineno-1-15" id="__codelineno-1-15" name="__codelineno-1-15"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">prefix_mlp</span> <span class="o">=</span> <span class="p">{</span>
<a href="#__codelineno-1-16" id="__codelineno-1-16" name="__codelineno-1-16"></a>            <span class="s1">'W1'</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">randn</span><span class="p">(</span><span class="n">d_model</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">prefix_mlp_hidden</span><span class="p">)</span> <span class="o">*</span> <span class="mf">0.01</span><span class="p">,</span>
<a href="#__codelineno-1-17" id="__codelineno-1-17" name="__codelineno-1-17"></a>            <span class="s1">'b1'</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">prefix_mlp_hidden</span><span class="p">),</span>
<a href="#__codelineno-1-18" id="__codelineno-1-18" name="__codelineno-1-18"></a>            <span class="s1">'W2'</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">randn</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">prefix_mlp_hidden</span><span class="p">,</span> <span class="n">d_model</span><span class="p">)</span> <span class="o">*</span> <span class="mf">0.01</span><span class="p">,</span>
<a href="#__codelineno-1-19" id="__codelineno-1-19" name="__codelineno-1-19"></a>            <span class="s1">'b2'</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">d_model</span><span class="p">)</span>
<a href="#__codelineno-1-20" id="__codelineno-1-20" name="__codelineno-1-20"></a>        <span class="p">}</span>
<a href="#__codelineno-1-21" id="__codelineno-1-21" name="__codelineno-1-21"></a>
<a href="#__codelineno-1-22" id="__codelineno-1-22" name="__codelineno-1-22"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">get_prefix_embeddings</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">layer_idx</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">batch_size</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
<a href="#__codelineno-1-23" id="__codelineno-1-23" name="__codelineno-1-23"></a><span class="w">        </span><span class="sd">"""Get prefix embeddings for a specific layer"""</span>
<a href="#__codelineno-1-24" id="__codelineno-1-24" name="__codelineno-1-24"></a>        <span class="c1"># Get base embeddings for this layer</span>
<a href="#__codelineno-1-25" id="__codelineno-1-25" name="__codelineno-1-25"></a>        <span class="n">layer_prefix</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">prefix_embeddings</span><span class="p">[</span><span class="n">layer_idx</span><span class="p">]</span>  <span class="c1"># (prefix_length, d_model)</span>
<a href="#__codelineno-1-26" id="__codelineno-1-26" name="__codelineno-1-26"></a>
<a href="#__codelineno-1-27" id="__codelineno-1-27" name="__codelineno-1-27"></a>        <span class="c1"># Expand for batch</span>
<a href="#__codelineno-1-28" id="__codelineno-1-28" name="__codelineno-1-28"></a>        <span class="n">batch_prefix</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">expand_dims</span><span class="p">(</span><span class="n">layer_prefix</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>  <span class="c1"># (1, prefix_length, d_model)</span>
<a href="#__codelineno-1-29" id="__codelineno-1-29" name="__codelineno-1-29"></a>        <span class="n">batch_prefix</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">repeat</span><span class="p">(</span><span class="n">batch_prefix</span><span class="p">,</span> <span class="n">batch_size</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>  <span class="c1"># (batch_size, prefix_length, d_model)</span>
<a href="#__codelineno-1-30" id="__codelineno-1-30" name="__codelineno-1-30"></a>
<a href="#__codelineno-1-31" id="__codelineno-1-31" name="__codelineno-1-31"></a>        <span class="k">return</span> <span class="n">batch_prefix</span>
<a href="#__codelineno-1-32" id="__codelineno-1-32" name="__codelineno-1-32"></a>
<a href="#__codelineno-1-33" id="__codelineno-1-33" name="__codelineno-1-33"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">apply_prefix_to_attention</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> 
<a href="#__codelineno-1-34" id="__codelineno-1-34" name="__codelineno-1-34"></a>                                  <span class="n">query</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> 
<a href="#__codelineno-1-35" id="__codelineno-1-35" name="__codelineno-1-35"></a>                                  <span class="n">key</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> 
<a href="#__codelineno-1-36" id="__codelineno-1-36" name="__codelineno-1-36"></a>                                  <span class="n">value</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span>
<a href="#__codelineno-1-37" id="__codelineno-1-37" name="__codelineno-1-37"></a>                                  <span class="n">layer_idx</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">]:</span>
<a href="#__codelineno-1-38" id="__codelineno-1-38" name="__codelineno-1-38"></a><span class="w">        </span><span class="sd">"""Apply prefix to attention computation"""</span>
<a href="#__codelineno-1-39" id="__codelineno-1-39" name="__codelineno-1-39"></a>        <span class="n">batch_size</span><span class="p">,</span> <span class="n">seq_len</span><span class="p">,</span> <span class="n">d_model</span> <span class="o">=</span> <span class="n">query</span><span class="o">.</span><span class="n">shape</span>
<a href="#__codelineno-1-40" id="__codelineno-1-40" name="__codelineno-1-40"></a>
<a href="#__codelineno-1-41" id="__codelineno-1-41" name="__codelineno-1-41"></a>        <span class="c1"># Get prefix embeddings for this layer</span>
<a href="#__codelineno-1-42" id="__codelineno-1-42" name="__codelineno-1-42"></a>        <span class="n">prefix_emb</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_prefix_embeddings</span><span class="p">(</span><span class="n">layer_idx</span><span class="p">,</span> <span class="n">batch_size</span><span class="p">)</span>
<a href="#__codelineno-1-43" id="__codelineno-1-43" name="__codelineno-1-43"></a>
<a href="#__codelineno-1-44" id="__codelineno-1-44" name="__codelineno-1-44"></a>        <span class="c1"># Prepend prefix to keys and values</span>
<a href="#__codelineno-1-45" id="__codelineno-1-45" name="__codelineno-1-45"></a>        <span class="n">key_with_prefix</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">([</span><span class="n">prefix_emb</span><span class="p">,</span> <span class="n">key</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<a href="#__codelineno-1-46" id="__codelineno-1-46" name="__codelineno-1-46"></a>        <span class="n">value_with_prefix</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">([</span><span class="n">prefix_emb</span><span class="p">,</span> <span class="n">value</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<a href="#__codelineno-1-47" id="__codelineno-1-47" name="__codelineno-1-47"></a>
<a href="#__codelineno-1-48" id="__codelineno-1-48" name="__codelineno-1-48"></a>        <span class="c1"># Query stays the same (attends to both prefix and original sequence)</span>
<a href="#__codelineno-1-49" id="__codelineno-1-49" name="__codelineno-1-49"></a>        <span class="k">return</span> <span class="n">query</span><span class="p">,</span> <span class="n">key_with_prefix</span><span class="p">,</span> <span class="n">value_with_prefix</span>
<a href="#__codelineno-1-50" id="__codelineno-1-50" name="__codelineno-1-50"></a>
<a href="#__codelineno-1-51" id="__codelineno-1-51" name="__codelineno-1-51"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">get_trainable_parameters</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">]:</span>
<a href="#__codelineno-1-52" id="__codelineno-1-52" name="__codelineno-1-52"></a><span class="w">        </span><span class="sd">"""Return trainable prefix parameters"""</span>
<a href="#__codelineno-1-53" id="__codelineno-1-53" name="__codelineno-1-53"></a>        <span class="k">return</span> <span class="p">{</span>
<a href="#__codelineno-1-54" id="__codelineno-1-54" name="__codelineno-1-54"></a>            <span class="s1">'prefix_embeddings'</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">prefix_embeddings</span><span class="p">,</span>
<a href="#__codelineno-1-55" id="__codelineno-1-55" name="__codelineno-1-55"></a>            <span class="s1">'mlp_W1'</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">prefix_mlp</span><span class="p">[</span><span class="s1">'W1'</span><span class="p">],</span>
<a href="#__codelineno-1-56" id="__codelineno-1-56" name="__codelineno-1-56"></a>            <span class="s1">'mlp_b1'</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">prefix_mlp</span><span class="p">[</span><span class="s1">'b1'</span><span class="p">],</span>
<a href="#__codelineno-1-57" id="__codelineno-1-57" name="__codelineno-1-57"></a>            <span class="s1">'mlp_W2'</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">prefix_mlp</span><span class="p">[</span><span class="s1">'W2'</span><span class="p">],</span>
<a href="#__codelineno-1-58" id="__codelineno-1-58" name="__codelineno-1-58"></a>            <span class="s1">'mlp_b2'</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">prefix_mlp</span><span class="p">[</span><span class="s1">'b2'</span><span class="p">]</span>
<a href="#__codelineno-1-59" id="__codelineno-1-59" name="__codelineno-1-59"></a>        <span class="p">}</span>
<a href="#__codelineno-1-60" id="__codelineno-1-60" name="__codelineno-1-60"></a>
<a href="#__codelineno-1-61" id="__codelineno-1-61" name="__codelineno-1-61"></a><span class="k">class</span><span class="w"> </span><span class="nc">AdapterLayers</span><span class="p">:</span>
<a href="#__codelineno-1-62" id="__codelineno-1-62" name="__codelineno-1-62"></a><span class="w">    </span><span class="sd">"""Adapter layers for parameter-efficient fine-tuning"""</span>
<a href="#__codelineno-1-63" id="__codelineno-1-63" name="__codelineno-1-63"></a>
<a href="#__codelineno-1-64" id="__codelineno-1-64" name="__codelineno-1-64"></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">d_model</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">bottleneck_size</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">64</span><span class="p">):</span>
<a href="#__codelineno-1-65" id="__codelineno-1-65" name="__codelineno-1-65"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">d_model</span> <span class="o">=</span> <span class="n">d_model</span>
<a href="#__codelineno-1-66" id="__codelineno-1-66" name="__codelineno-1-66"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">bottleneck_size</span> <span class="o">=</span> <span class="n">bottleneck_size</span>
<a href="#__codelineno-1-67" id="__codelineno-1-67" name="__codelineno-1-67"></a>
<a href="#__codelineno-1-68" id="__codelineno-1-68" name="__codelineno-1-68"></a>        <span class="c1"># Down-projection</span>
<a href="#__codelineno-1-69" id="__codelineno-1-69" name="__codelineno-1-69"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">down_proj</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">randn</span><span class="p">(</span><span class="n">d_model</span><span class="p">,</span> <span class="n">bottleneck_size</span><span class="p">)</span> <span class="o">*</span> <span class="mf">0.01</span>
<a href="#__codelineno-1-70" id="__codelineno-1-70" name="__codelineno-1-70"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">down_bias</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">bottleneck_size</span><span class="p">)</span>
<a href="#__codelineno-1-71" id="__codelineno-1-71" name="__codelineno-1-71"></a>
<a href="#__codelineno-1-72" id="__codelineno-1-72" name="__codelineno-1-72"></a>        <span class="c1"># Up-projection  </span>
<a href="#__codelineno-1-73" id="__codelineno-1-73" name="__codelineno-1-73"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">up_proj</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">randn</span><span class="p">(</span><span class="n">bottleneck_size</span><span class="p">,</span> <span class="n">d_model</span><span class="p">)</span> <span class="o">*</span> <span class="mf">0.01</span>
<a href="#__codelineno-1-74" id="__codelineno-1-74" name="__codelineno-1-74"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">up_bias</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">d_model</span><span class="p">)</span>
<a href="#__codelineno-1-75" id="__codelineno-1-75" name="__codelineno-1-75"></a>
<a href="#__codelineno-1-76" id="__codelineno-1-76" name="__codelineno-1-76"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
<a href="#__codelineno-1-77" id="__codelineno-1-77" name="__codelineno-1-77"></a><span class="w">        </span><span class="sd">"""Forward pass through adapter"""</span>
<a href="#__codelineno-1-78" id="__codelineno-1-78" name="__codelineno-1-78"></a>        <span class="c1"># Down-projection with activation</span>
<a href="#__codelineno-1-79" id="__codelineno-1-79" name="__codelineno-1-79"></a>        <span class="n">down</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">maximum</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">x</span> <span class="o">@</span> <span class="bp">self</span><span class="o">.</span><span class="n">down_proj</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">down_bias</span><span class="p">)</span>  <span class="c1"># ReLU</span>
<a href="#__codelineno-1-80" id="__codelineno-1-80" name="__codelineno-1-80"></a>
<a href="#__codelineno-1-81" id="__codelineno-1-81" name="__codelineno-1-81"></a>        <span class="c1"># Up-projection</span>
<a href="#__codelineno-1-82" id="__codelineno-1-82" name="__codelineno-1-82"></a>        <span class="n">up</span> <span class="o">=</span> <span class="n">down</span> <span class="o">@</span> <span class="bp">self</span><span class="o">.</span><span class="n">up_proj</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">up_bias</span>
<a href="#__codelineno-1-83" id="__codelineno-1-83" name="__codelineno-1-83"></a>
<a href="#__codelineno-1-84" id="__codelineno-1-84" name="__codelineno-1-84"></a>        <span class="c1"># Residual connection</span>
<a href="#__codelineno-1-85" id="__codelineno-1-85" name="__codelineno-1-85"></a>        <span class="k">return</span> <span class="n">x</span> <span class="o">+</span> <span class="n">up</span>
<a href="#__codelineno-1-86" id="__codelineno-1-86" name="__codelineno-1-86"></a>
<a href="#__codelineno-1-87" id="__codelineno-1-87" name="__codelineno-1-87"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">get_parameter_count</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
<a href="#__codelineno-1-88" id="__codelineno-1-88" name="__codelineno-1-88"></a><span class="w">        </span><span class="sd">"""Calculate number of parameters in adapter"""</span>
<a href="#__codelineno-1-89" id="__codelineno-1-89" name="__codelineno-1-89"></a>        <span class="k">return</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">d_model</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">bottleneck_size</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">bottleneck_size</span> <span class="o">+</span> 
<a href="#__codelineno-1-90" id="__codelineno-1-90" name="__codelineno-1-90"></a>                <span class="bp">self</span><span class="o">.</span><span class="n">bottleneck_size</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">d_model</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">d_model</span><span class="p">)</span>
<a href="#__codelineno-1-91" id="__codelineno-1-91" name="__codelineno-1-91"></a>
<a href="#__codelineno-1-92" id="__codelineno-1-92" name="__codelineno-1-92"></a><span class="c1"># Compare PEFT methods</span>
<a href="#__codelineno-1-93" id="__codelineno-1-93" name="__codelineno-1-93"></a><span class="k">def</span><span class="w"> </span><span class="nf">compare_peft_methods</span><span class="p">(</span><span class="n">d_model</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">768</span><span class="p">,</span> <span class="n">original_params</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">100_000_000</span><span class="p">):</span>
<a href="#__codelineno-1-94" id="__codelineno-1-94" name="__codelineno-1-94"></a><span class="w">    </span><span class="sd">"""Compare parameter efficiency of different PEFT methods"""</span>
<a href="#__codelineno-1-95" id="__codelineno-1-95" name="__codelineno-1-95"></a>
<a href="#__codelineno-1-96" id="__codelineno-1-96" name="__codelineno-1-96"></a>    <span class="n">methods</span> <span class="o">=</span> <span class="p">{}</span>
<a href="#__codelineno-1-97" id="__codelineno-1-97" name="__codelineno-1-97"></a>
<a href="#__codelineno-1-98" id="__codelineno-1-98" name="__codelineno-1-98"></a>    <span class="c1"># LoRA</span>
<a href="#__codelineno-1-99" id="__codelineno-1-99" name="__codelineno-1-99"></a>    <span class="n">lora_params</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">d_model</span> <span class="o">*</span> <span class="mi">16</span> <span class="o">*</span> <span class="mi">6</span>  <span class="c1"># 6 matrices (Q,K,V,O,FF1,FF2) with rank 16</span>
<a href="#__codelineno-1-100" id="__codelineno-1-100" name="__codelineno-1-100"></a>    <span class="n">methods</span><span class="p">[</span><span class="s1">'LoRA (r=16)'</span><span class="p">]</span> <span class="o">=</span> <span class="n">lora_params</span>
<a href="#__codelineno-1-101" id="__codelineno-1-101" name="__codelineno-1-101"></a>
<a href="#__codelineno-1-102" id="__codelineno-1-102" name="__codelineno-1-102"></a>    <span class="c1"># Prefix Tuning</span>
<a href="#__codelineno-1-103" id="__codelineno-1-103" name="__codelineno-1-103"></a>    <span class="n">prefix_params</span> <span class="o">=</span> <span class="mi">12</span> <span class="o">*</span> <span class="mi">10</span> <span class="o">*</span> <span class="n">d_model</span>  <span class="c1"># 12 layers, 10 prefix tokens</span>
<a href="#__codelineno-1-104" id="__codelineno-1-104" name="__codelineno-1-104"></a>    <span class="n">methods</span><span class="p">[</span><span class="s1">'Prefix Tuning'</span><span class="p">]</span> <span class="o">=</span> <span class="n">prefix_params</span>
<a href="#__codelineno-1-105" id="__codelineno-1-105" name="__codelineno-1-105"></a>
<a href="#__codelineno-1-106" id="__codelineno-1-106" name="__codelineno-1-106"></a>    <span class="c1"># Adapters</span>
<a href="#__codelineno-1-107" id="__codelineno-1-107" name="__codelineno-1-107"></a>    <span class="n">adapter_params</span> <span class="o">=</span> <span class="mi">12</span> <span class="o">*</span> <span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">d_model</span> <span class="o">*</span> <span class="mi">64</span> <span class="o">+</span> <span class="mi">64</span> <span class="o">+</span> <span class="n">d_model</span><span class="p">)</span>  <span class="c1"># 12 layers, bottleneck 64</span>
<a href="#__codelineno-1-108" id="__codelineno-1-108" name="__codelineno-1-108"></a>    <span class="n">methods</span><span class="p">[</span><span class="s1">'Adapters'</span><span class="p">]</span> <span class="o">=</span> <span class="n">adapter_params</span>
<a href="#__codelineno-1-109" id="__codelineno-1-109" name="__codelineno-1-109"></a>
<a href="#__codelineno-1-110" id="__codelineno-1-110" name="__codelineno-1-110"></a>    <span class="c1"># P-Tuning v2 (similar to prefix)</span>
<a href="#__codelineno-1-111" id="__codelineno-1-111" name="__codelineno-1-111"></a>    <span class="n">p_tuning_params</span> <span class="o">=</span> <span class="mi">12</span> <span class="o">*</span> <span class="mi">20</span> <span class="o">*</span> <span class="n">d_model</span>  <span class="c1"># 12 layers, 20 prompt tokens</span>
<a href="#__codelineno-1-112" id="__codelineno-1-112" name="__codelineno-1-112"></a>    <span class="n">methods</span><span class="p">[</span><span class="s1">'P-Tuning v2'</span><span class="p">]</span> <span class="o">=</span> <span class="n">p_tuning_params</span>
<a href="#__codelineno-1-113" id="__codelineno-1-113" name="__codelineno-1-113"></a>
<a href="#__codelineno-1-114" id="__codelineno-1-114" name="__codelineno-1-114"></a>    <span class="nb">print</span><span class="p">(</span><span class="s2">"PEFT Method Comparison:"</span><span class="p">)</span>
<a href="#__codelineno-1-115" id="__codelineno-1-115" name="__codelineno-1-115"></a>    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"Original Model Parameters: </span><span class="si">{</span><span class="n">original_params</span><span class="si">:</span><span class="s2">,</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
<a href="#__codelineno-1-116" id="__codelineno-1-116" name="__codelineno-1-116"></a>    <span class="nb">print</span><span class="p">(</span><span class="s2">"-"</span> <span class="o">*</span> <span class="mi">50</span><span class="p">)</span>
<a href="#__codelineno-1-117" id="__codelineno-1-117" name="__codelineno-1-117"></a>
<a href="#__codelineno-1-118" id="__codelineno-1-118" name="__codelineno-1-118"></a>    <span class="k">for</span> <span class="n">method</span><span class="p">,</span> <span class="n">params</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">methods</span><span class="o">.</span><span class="n">items</span><span class="p">(),</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">]):</span>
<a href="#__codelineno-1-119" id="__codelineno-1-119" name="__codelineno-1-119"></a>        <span class="n">efficiency</span> <span class="o">=</span> <span class="p">(</span><span class="n">params</span> <span class="o">/</span> <span class="n">original_params</span><span class="p">)</span> <span class="o">*</span> <span class="mi">100</span>
<a href="#__codelineno-1-120" id="__codelineno-1-120" name="__codelineno-1-120"></a>        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"</span><span class="si">{</span><span class="n">method</span><span class="si">:</span><span class="s2">20</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">params</span><span class="si">:</span><span class="s2">&gt;8,</span><span class="si">}</span><span class="s2"> params (</span><span class="si">{</span><span class="n">efficiency</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2">%)"</span><span class="p">)</span>
<a href="#__codelineno-1-121" id="__codelineno-1-121" name="__codelineno-1-121"></a>
<a href="#__codelineno-1-122" id="__codelineno-1-122" name="__codelineno-1-122"></a><span class="n">compare_peft_methods</span><span class="p">()</span>
</code></pre></div></p>
<h2 id="domain-specific-fine-tuning">📚 Domain-Specific Fine-tuning</h2>
<h3 id="medical-domain-example">Medical Domain Example</h3>
<p><strong>Medical Text Classification</strong>:
<div class="highlight"><pre><span></span><code><a href="#__codelineno-2-1" id="__codelineno-2-1" name="__codelineno-2-1"></a><span class="k">class</span><span class="w"> </span><span class="nc">MedicalDomainFineTuner</span><span class="p">:</span>
<a href="#__codelineno-2-2" id="__codelineno-2-2" name="__codelineno-2-2"></a><span class="w">    </span><span class="sd">"""Fine-tune models for medical domain tasks"""</span>
<a href="#__codelineno-2-3" id="__codelineno-2-3" name="__codelineno-2-3"></a>
<a href="#__codelineno-2-4" id="__codelineno-2-4" name="__codelineno-2-4"></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">base_model_name</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">"biobert-base"</span><span class="p">):</span>
<a href="#__codelineno-2-5" id="__codelineno-2-5" name="__codelineno-2-5"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">base_model</span> <span class="o">=</span> <span class="n">base_model_name</span>
<a href="#__codelineno-2-6" id="__codelineno-2-6" name="__codelineno-2-6"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">medical_vocabulary</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">load_medical_vocabulary</span><span class="p">()</span>
<a href="#__codelineno-2-7" id="__codelineno-2-7" name="__codelineno-2-7"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">training_config</span> <span class="o">=</span> <span class="p">{</span>
<a href="#__codelineno-2-8" id="__codelineno-2-8" name="__codelineno-2-8"></a>            <span class="s1">'learning_rate'</span><span class="p">:</span> <span class="mf">2e-5</span><span class="p">,</span>
<a href="#__codelineno-2-9" id="__codelineno-2-9" name="__codelineno-2-9"></a>            <span class="s1">'batch_size'</span><span class="p">:</span> <span class="mi">16</span><span class="p">,</span>
<a href="#__codelineno-2-10" id="__codelineno-2-10" name="__codelineno-2-10"></a>            <span class="s1">'max_epochs'</span><span class="p">:</span> <span class="mi">5</span><span class="p">,</span>
<a href="#__codelineno-2-11" id="__codelineno-2-11" name="__codelineno-2-11"></a>            <span class="s1">'warmup_steps'</span><span class="p">:</span> <span class="mi">500</span>
<a href="#__codelineno-2-12" id="__codelineno-2-12" name="__codelineno-2-12"></a>        <span class="p">}</span>
<a href="#__codelineno-2-13" id="__codelineno-2-13" name="__codelineno-2-13"></a>
<a href="#__codelineno-2-14" id="__codelineno-2-14" name="__codelineno-2-14"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">load_medical_vocabulary</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]:</span>
<a href="#__codelineno-2-15" id="__codelineno-2-15" name="__codelineno-2-15"></a><span class="w">        </span><span class="sd">"""Load medical terminology and definitions"""</span>
<a href="#__codelineno-2-16" id="__codelineno-2-16" name="__codelineno-2-16"></a>        <span class="k">return</span> <span class="p">{</span>
<a href="#__codelineno-2-17" id="__codelineno-2-17" name="__codelineno-2-17"></a>            <span class="s1">'myocardial infarction'</span><span class="p">:</span> <span class="s1">'heart attack'</span><span class="p">,</span>
<a href="#__codelineno-2-18" id="__codelineno-2-18" name="__codelineno-2-18"></a>            <span class="s1">'hypertension'</span><span class="p">:</span> <span class="s1">'high blood pressure'</span><span class="p">,</span> 
<a href="#__codelineno-2-19" id="__codelineno-2-19" name="__codelineno-2-19"></a>            <span class="s1">'pneumonia'</span><span class="p">:</span> <span class="s1">'lung infection'</span><span class="p">,</span>
<a href="#__codelineno-2-20" id="__codelineno-2-20" name="__codelineno-2-20"></a>            <span class="s1">'diabetes mellitus'</span><span class="p">:</span> <span class="s1">'diabetes'</span><span class="p">,</span>
<a href="#__codelineno-2-21" id="__codelineno-2-21" name="__codelineno-2-21"></a>            <span class="s1">'cerebrovascular accident'</span><span class="p">:</span> <span class="s1">'stroke'</span>
<a href="#__codelineno-2-22" id="__codelineno-2-22" name="__codelineno-2-22"></a>        <span class="p">}</span>
<a href="#__codelineno-2-23" id="__codelineno-2-23" name="__codelineno-2-23"></a>
<a href="#__codelineno-2-24" id="__codelineno-2-24" name="__codelineno-2-24"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">create_medical_training_data</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]]:</span>
<a href="#__codelineno-2-25" id="__codelineno-2-25" name="__codelineno-2-25"></a><span class="w">        </span><span class="sd">"""Create training examples for medical tasks"""</span>
<a href="#__codelineno-2-26" id="__codelineno-2-26" name="__codelineno-2-26"></a>        <span class="n">examples</span> <span class="o">=</span> <span class="p">[]</span>
<a href="#__codelineno-2-27" id="__codelineno-2-27" name="__codelineno-2-27"></a>
<a href="#__codelineno-2-28" id="__codelineno-2-28" name="__codelineno-2-28"></a>        <span class="c1"># Clinical note classification</span>
<a href="#__codelineno-2-29" id="__codelineno-2-29" name="__codelineno-2-29"></a>        <span class="n">examples</span><span class="o">.</span><span class="n">extend</span><span class="p">([</span>
<a href="#__codelineno-2-30" id="__codelineno-2-30" name="__codelineno-2-30"></a>            <span class="p">{</span>
<a href="#__codelineno-2-31" id="__codelineno-2-31" name="__codelineno-2-31"></a>                <span class="s1">'text'</span><span class="p">:</span> <span class="s1">'Patient presents with chest pain, elevated troponins, and ST elevation on ECG.'</span><span class="p">,</span>
<a href="#__codelineno-2-32" id="__codelineno-2-32" name="__codelineno-2-32"></a>                <span class="s1">'label'</span><span class="p">:</span> <span class="s1">'myocardial_infarction'</span><span class="p">,</span>
<a href="#__codelineno-2-33" id="__codelineno-2-33" name="__codelineno-2-33"></a>                <span class="s1">'task'</span><span class="p">:</span> <span class="s1">'diagnosis_classification'</span>
<a href="#__codelineno-2-34" id="__codelineno-2-34" name="__codelineno-2-34"></a>            <span class="p">},</span>
<a href="#__codelineno-2-35" id="__codelineno-2-35" name="__codelineno-2-35"></a>            <span class="p">{</span>
<a href="#__codelineno-2-36" id="__codelineno-2-36" name="__codelineno-2-36"></a>                <span class="s1">'text'</span><span class="p">:</span> <span class="s1">'Blood pressure reading of 180/110 mmHg, patient reports headaches.'</span><span class="p">,</span>
<a href="#__codelineno-2-37" id="__codelineno-2-37" name="__codelineno-2-37"></a>                <span class="s1">'label'</span><span class="p">:</span> <span class="s1">'hypertension'</span><span class="p">,</span>
<a href="#__codelineno-2-38" id="__codelineno-2-38" name="__codelineno-2-38"></a>                <span class="s1">'task'</span><span class="p">:</span> <span class="s1">'diagnosis_classification'</span>
<a href="#__codelineno-2-39" id="__codelineno-2-39" name="__codelineno-2-39"></a>            <span class="p">},</span>
<a href="#__codelineno-2-40" id="__codelineno-2-40" name="__codelineno-2-40"></a>            <span class="p">{</span>
<a href="#__codelineno-2-41" id="__codelineno-2-41" name="__codelineno-2-41"></a>                <span class="s1">'text'</span><span class="p">:</span> <span class="s1">'Fever, productive cough, and infiltrates visible on chest X-ray.'</span><span class="p">,</span>
<a href="#__codelineno-2-42" id="__codelineno-2-42" name="__codelineno-2-42"></a>                <span class="s1">'label'</span><span class="p">:</span> <span class="s1">'pneumonia'</span><span class="p">,</span>
<a href="#__codelineno-2-43" id="__codelineno-2-43" name="__codelineno-2-43"></a>                <span class="s1">'task'</span><span class="p">:</span> <span class="s1">'diagnosis_classification'</span>
<a href="#__codelineno-2-44" id="__codelineno-2-44" name="__codelineno-2-44"></a>            <span class="p">}</span>
<a href="#__codelineno-2-45" id="__codelineno-2-45" name="__codelineno-2-45"></a>        <span class="p">])</span>
<a href="#__codelineno-2-46" id="__codelineno-2-46" name="__codelineno-2-46"></a>
<a href="#__codelineno-2-47" id="__codelineno-2-47" name="__codelineno-2-47"></a>        <span class="c1"># Medical Q&amp;A</span>
<a href="#__codelineno-2-48" id="__codelineno-2-48" name="__codelineno-2-48"></a>        <span class="n">examples</span><span class="o">.</span><span class="n">extend</span><span class="p">([</span>
<a href="#__codelineno-2-49" id="__codelineno-2-49" name="__codelineno-2-49"></a>            <span class="p">{</span>
<a href="#__codelineno-2-50" id="__codelineno-2-50" name="__codelineno-2-50"></a>                <span class="s1">'question'</span><span class="p">:</span> <span class="s1">'What are the symptoms of myocardial infarction?'</span><span class="p">,</span>
<a href="#__codelineno-2-51" id="__codelineno-2-51" name="__codelineno-2-51"></a>                <span class="s1">'answer'</span><span class="p">:</span> <span class="s1">'Common symptoms include chest pain, shortness of breath, nausea, sweating, and pain radiating to the arm or jaw.'</span><span class="p">,</span>
<a href="#__codelineno-2-52" id="__codelineno-2-52" name="__codelineno-2-52"></a>                <span class="s1">'task'</span><span class="p">:</span> <span class="s1">'medical_qa'</span>
<a href="#__codelineno-2-53" id="__codelineno-2-53" name="__codelineno-2-53"></a>            <span class="p">},</span>
<a href="#__codelineno-2-54" id="__codelineno-2-54" name="__codelineno-2-54"></a>            <span class="p">{</span>
<a href="#__codelineno-2-55" id="__codelineno-2-55" name="__codelineno-2-55"></a>                <span class="s1">'question'</span><span class="p">:</span> <span class="s1">'How is hypertension diagnosed?'</span><span class="p">,</span>
<a href="#__codelineno-2-56" id="__codelineno-2-56" name="__codelineno-2-56"></a>                <span class="s1">'answer'</span><span class="p">:</span> <span class="s1">'Hypertension is diagnosed when blood pressure consistently measures 130/80 mmHg or higher on multiple occasions.'</span><span class="p">,</span>
<a href="#__codelineno-2-57" id="__codelineno-2-57" name="__codelineno-2-57"></a>                <span class="s1">'task'</span><span class="p">:</span> <span class="s1">'medical_qa'</span>
<a href="#__codelineno-2-58" id="__codelineno-2-58" name="__codelineno-2-58"></a>            <span class="p">}</span>
<a href="#__codelineno-2-59" id="__codelineno-2-59" name="__codelineno-2-59"></a>        <span class="p">])</span>
<a href="#__codelineno-2-60" id="__codelineno-2-60" name="__codelineno-2-60"></a>
<a href="#__codelineno-2-61" id="__codelineno-2-61" name="__codelineno-2-61"></a>        <span class="c1"># Drug information</span>
<a href="#__codelineno-2-62" id="__codelineno-2-62" name="__codelineno-2-62"></a>        <span class="n">examples</span><span class="o">.</span><span class="n">extend</span><span class="p">([</span>
<a href="#__codelineno-2-63" id="__codelineno-2-63" name="__codelineno-2-63"></a>            <span class="p">{</span>
<a href="#__codelineno-2-64" id="__codelineno-2-64" name="__codelineno-2-64"></a>                <span class="s1">'drug'</span><span class="p">:</span> <span class="s1">'Aspirin'</span><span class="p">,</span>
<a href="#__codelineno-2-65" id="__codelineno-2-65" name="__codelineno-2-65"></a>                <span class="s1">'indication'</span><span class="p">:</span> <span class="s1">'Used for cardiovascular protection and pain relief.'</span><span class="p">,</span>
<a href="#__codelineno-2-66" id="__codelineno-2-66" name="__codelineno-2-66"></a>                <span class="s1">'dosage'</span><span class="p">:</span> <span class="s1">'Typically 81mg daily for cardiovascular protection.'</span><span class="p">,</span>
<a href="#__codelineno-2-67" id="__codelineno-2-67" name="__codelineno-2-67"></a>                <span class="s1">'contraindications'</span><span class="p">:</span> <span class="s1">'Bleeding disorders, severe liver disease.'</span><span class="p">,</span>
<a href="#__codelineno-2-68" id="__codelineno-2-68" name="__codelineno-2-68"></a>                <span class="s1">'task'</span><span class="p">:</span> <span class="s1">'drug_information'</span>
<a href="#__codelineno-2-69" id="__codelineno-2-69" name="__codelineno-2-69"></a>            <span class="p">}</span>
<a href="#__codelineno-2-70" id="__codelineno-2-70" name="__codelineno-2-70"></a>        <span class="p">])</span>
<a href="#__codelineno-2-71" id="__codelineno-2-71" name="__codelineno-2-71"></a>
<a href="#__codelineno-2-72" id="__codelineno-2-72" name="__codelineno-2-72"></a>        <span class="k">return</span> <span class="n">examples</span>
<a href="#__codelineno-2-73" id="__codelineno-2-73" name="__codelineno-2-73"></a>
<a href="#__codelineno-2-74" id="__codelineno-2-74" name="__codelineno-2-74"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">create_task_specific_prompts</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">task_type</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<a href="#__codelineno-2-75" id="__codelineno-2-75" name="__codelineno-2-75"></a><span class="w">        </span><span class="sd">"""Create prompts for different medical tasks"""</span>
<a href="#__codelineno-2-76" id="__codelineno-2-76" name="__codelineno-2-76"></a>        <span class="n">prompts</span> <span class="o">=</span> <span class="p">{</span>
<a href="#__codelineno-2-77" id="__codelineno-2-77" name="__codelineno-2-77"></a>            <span class="s1">'diagnosis_classification'</span><span class="p">:</span> <span class="s2">"""</span>
<a href="#__codelineno-2-78" id="__codelineno-2-78" name="__codelineno-2-78"></a><span class="s2">                You are a medical AI assistant trained to help with clinical diagnosis classification.</span>
<a href="#__codelineno-2-79" id="__codelineno-2-79" name="__codelineno-2-79"></a>
<a href="#__codelineno-2-80" id="__codelineno-2-80" name="__codelineno-2-80"></a><span class="s2">                Given a clinical note, classify the most likely primary diagnosis from the following categories:</span>
<a href="#__codelineno-2-81" id="__codelineno-2-81" name="__codelineno-2-81"></a><span class="s2">                - myocardial_infarction</span>
<a href="#__codelineno-2-82" id="__codelineno-2-82" name="__codelineno-2-82"></a><span class="s2">                - hypertension  </span>
<a href="#__codelineno-2-83" id="__codelineno-2-83" name="__codelineno-2-83"></a><span class="s2">                - pneumonia</span>
<a href="#__codelineno-2-84" id="__codelineno-2-84" name="__codelineno-2-84"></a><span class="s2">                - diabetes</span>
<a href="#__codelineno-2-85" id="__codelineno-2-85" name="__codelineno-2-85"></a><span class="s2">                - other</span>
<a href="#__codelineno-2-86" id="__codelineno-2-86" name="__codelineno-2-86"></a>
<a href="#__codelineno-2-87" id="__codelineno-2-87" name="__codelineno-2-87"></a><span class="s2">                Clinical Note: </span><span class="si">{text}</span>
<a href="#__codelineno-2-88" id="__codelineno-2-88" name="__codelineno-2-88"></a>
<a href="#__codelineno-2-89" id="__codelineno-2-89" name="__codelineno-2-89"></a><span class="s2">                Primary Diagnosis:"""</span><span class="p">,</span>
<a href="#__codelineno-2-90" id="__codelineno-2-90" name="__codelineno-2-90"></a>
<a href="#__codelineno-2-91" id="__codelineno-2-91" name="__codelineno-2-91"></a>            <span class="s1">'medical_qa'</span><span class="p">:</span> <span class="s2">"""</span>
<a href="#__codelineno-2-92" id="__codelineno-2-92" name="__codelineno-2-92"></a><span class="s2">                You are a medical AI assistant providing accurate, evidence-based answers to medical questions.</span>
<a href="#__codelineno-2-93" id="__codelineno-2-93" name="__codelineno-2-93"></a>
<a href="#__codelineno-2-94" id="__codelineno-2-94" name="__codelineno-2-94"></a><span class="s2">                Please provide a clear, accurate answer to the following medical question:</span>
<a href="#__codelineno-2-95" id="__codelineno-2-95" name="__codelineno-2-95"></a>
<a href="#__codelineno-2-96" id="__codelineno-2-96" name="__codelineno-2-96"></a><span class="s2">                Question: </span><span class="si">{question}</span>
<a href="#__codelineno-2-97" id="__codelineno-2-97" name="__codelineno-2-97"></a>
<a href="#__codelineno-2-98" id="__codelineno-2-98" name="__codelineno-2-98"></a><span class="s2">                Answer:"""</span><span class="p">,</span>
<a href="#__codelineno-2-99" id="__codelineno-2-99" name="__codelineno-2-99"></a>
<a href="#__codelineno-2-100" id="__codelineno-2-100" name="__codelineno-2-100"></a>            <span class="s1">'drug_information'</span><span class="p">:</span> <span class="s2">"""</span>
<a href="#__codelineno-2-101" id="__codelineno-2-101" name="__codelineno-2-101"></a><span class="s2">                You are a pharmaceutical AI assistant providing drug information.</span>
<a href="#__codelineno-2-102" id="__codelineno-2-102" name="__codelineno-2-102"></a>
<a href="#__codelineno-2-103" id="__codelineno-2-103" name="__codelineno-2-103"></a><span class="s2">                Provide comprehensive information about the following medication:</span>
<a href="#__codelineno-2-104" id="__codelineno-2-104" name="__codelineno-2-104"></a>
<a href="#__codelineno-2-105" id="__codelineno-2-105" name="__codelineno-2-105"></a><span class="s2">                Drug: </span><span class="si">{drug}</span>
<a href="#__codelineno-2-106" id="__codelineno-2-106" name="__codelineno-2-106"></a>
<a href="#__codelineno-2-107" id="__codelineno-2-107" name="__codelineno-2-107"></a><span class="s2">                Please include:</span>
<a href="#__codelineno-2-108" id="__codelineno-2-108" name="__codelineno-2-108"></a><span class="s2">                1. Primary indications</span>
<a href="#__codelineno-2-109" id="__codelineno-2-109" name="__codelineno-2-109"></a><span class="s2">                2. Typical dosage</span>
<a href="#__codelineno-2-110" id="__codelineno-2-110" name="__codelineno-2-110"></a><span class="s2">                3. Major contraindications</span>
<a href="#__codelineno-2-111" id="__codelineno-2-111" name="__codelineno-2-111"></a><span class="s2">                4. Common side effects</span>
<a href="#__codelineno-2-112" id="__codelineno-2-112" name="__codelineno-2-112"></a>
<a href="#__codelineno-2-113" id="__codelineno-2-113" name="__codelineno-2-113"></a><span class="s2">                Information:"""</span>
<a href="#__codelineno-2-114" id="__codelineno-2-114" name="__codelineno-2-114"></a>        <span class="p">}</span>
<a href="#__codelineno-2-115" id="__codelineno-2-115" name="__codelineno-2-115"></a>
<a href="#__codelineno-2-116" id="__codelineno-2-116" name="__codelineno-2-116"></a>        <span class="k">return</span> <span class="n">prompts</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">task_type</span><span class="p">,</span> <span class="s2">""</span><span class="p">)</span>
<a href="#__codelineno-2-117" id="__codelineno-2-117" name="__codelineno-2-117"></a>
<a href="#__codelineno-2-118" id="__codelineno-2-118" name="__codelineno-2-118"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">evaluate_medical_model</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">model_outputs</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span> <span class="n">ground_truth</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">float</span><span class="p">]:</span>
<a href="#__codelineno-2-119" id="__codelineno-2-119" name="__codelineno-2-119"></a><span class="w">        </span><span class="sd">"""Evaluate model performance on medical tasks"""</span>
<a href="#__codelineno-2-120" id="__codelineno-2-120" name="__codelineno-2-120"></a>        <span class="n">metrics</span> <span class="o">=</span> <span class="p">{}</span>
<a href="#__codelineno-2-121" id="__codelineno-2-121" name="__codelineno-2-121"></a>
<a href="#__codelineno-2-122" id="__codelineno-2-122" name="__codelineno-2-122"></a>        <span class="c1"># Accuracy for classification tasks</span>
<a href="#__codelineno-2-123" id="__codelineno-2-123" name="__codelineno-2-123"></a>        <span class="k">if</span> <span class="nb">all</span><span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">gt</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span> <span class="ow">and</span> <span class="n">gt</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">'myocardial_infarction'</span><span class="p">,</span> <span class="s1">'hypertension'</span><span class="p">,</span> <span class="s1">'pneumonia'</span><span class="p">]</span> 
<a href="#__codelineno-2-124" id="__codelineno-2-124" name="__codelineno-2-124"></a>               <span class="k">for</span> <span class="n">gt</span> <span class="ow">in</span> <span class="n">ground_truth</span><span class="p">):</span>
<a href="#__codelineno-2-125" id="__codelineno-2-125" name="__codelineno-2-125"></a>
<a href="#__codelineno-2-126" id="__codelineno-2-126" name="__codelineno-2-126"></a>            <span class="n">correct</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="mi">1</span> <span class="k">for</span> <span class="n">pred</span><span class="p">,</span> <span class="n">gt</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">model_outputs</span><span class="p">,</span> <span class="n">ground_truth</span><span class="p">)</span> 
<a href="#__codelineno-2-127" id="__codelineno-2-127" name="__codelineno-2-127"></a>                         <span class="k">if</span> <span class="n">pred</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="n">gt</span><span class="o">.</span><span class="n">lower</span><span class="p">())</span>
<a href="#__codelineno-2-128" id="__codelineno-2-128" name="__codelineno-2-128"></a>
<a href="#__codelineno-2-129" id="__codelineno-2-129" name="__codelineno-2-129"></a>            <span class="n">metrics</span><span class="p">[</span><span class="s1">'accuracy'</span><span class="p">]</span> <span class="o">=</span> <span class="n">correct</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="n">ground_truth</span><span class="p">)</span>
<a href="#__codelineno-2-130" id="__codelineno-2-130" name="__codelineno-2-130"></a>
<a href="#__codelineno-2-131" id="__codelineno-2-131" name="__codelineno-2-131"></a>        <span class="c1"># Medical terminology usage (simplified check)</span>
<a href="#__codelineno-2-132" id="__codelineno-2-132" name="__codelineno-2-132"></a>        <span class="n">medical_terms_used</span> <span class="o">=</span> <span class="mi">0</span>
<a href="#__codelineno-2-133" id="__codelineno-2-133" name="__codelineno-2-133"></a>        <span class="k">for</span> <span class="n">output</span> <span class="ow">in</span> <span class="n">model_outputs</span><span class="p">:</span>
<a href="#__codelineno-2-134" id="__codelineno-2-134" name="__codelineno-2-134"></a>            <span class="n">output_lower</span> <span class="o">=</span> <span class="n">output</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
<a href="#__codelineno-2-135" id="__codelineno-2-135" name="__codelineno-2-135"></a>            <span class="k">for</span> <span class="n">term</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">medical_vocabulary</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
<a href="#__codelineno-2-136" id="__codelineno-2-136" name="__codelineno-2-136"></a>                <span class="k">if</span> <span class="n">term</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="ow">in</span> <span class="n">output_lower</span><span class="p">:</span>
<a href="#__codelineno-2-137" id="__codelineno-2-137" name="__codelineno-2-137"></a>                    <span class="n">medical_terms_used</span> <span class="o">+=</span> <span class="mi">1</span>
<a href="#__codelineno-2-138" id="__codelineno-2-138" name="__codelineno-2-138"></a>                    <span class="k">break</span>
<a href="#__codelineno-2-139" id="__codelineno-2-139" name="__codelineno-2-139"></a>
<a href="#__codelineno-2-140" id="__codelineno-2-140" name="__codelineno-2-140"></a>        <span class="n">metrics</span><span class="p">[</span><span class="s1">'medical_terminology_usage'</span><span class="p">]</span> <span class="o">=</span> <span class="n">medical_terms_used</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="n">model_outputs</span><span class="p">)</span>
<a href="#__codelineno-2-141" id="__codelineno-2-141" name="__codelineno-2-141"></a>
<a href="#__codelineno-2-142" id="__codelineno-2-142" name="__codelineno-2-142"></a>        <span class="c1"># Average response length (medical responses should be detailed)</span>
<a href="#__codelineno-2-143" id="__codelineno-2-143" name="__codelineno-2-143"></a>        <span class="n">avg_length</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">output</span><span class="o">.</span><span class="n">split</span><span class="p">())</span> <span class="k">for</span> <span class="n">output</span> <span class="ow">in</span> <span class="n">model_outputs</span><span class="p">)</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="n">model_outputs</span><span class="p">)</span>
<a href="#__codelineno-2-144" id="__codelineno-2-144" name="__codelineno-2-144"></a>        <span class="n">metrics</span><span class="p">[</span><span class="s1">'avg_response_length'</span><span class="p">]</span> <span class="o">=</span> <span class="n">avg_length</span>
<a href="#__codelineno-2-145" id="__codelineno-2-145" name="__codelineno-2-145"></a>
<a href="#__codelineno-2-146" id="__codelineno-2-146" name="__codelineno-2-146"></a>        <span class="k">return</span> <span class="n">metrics</span>
<a href="#__codelineno-2-147" id="__codelineno-2-147" name="__codelineno-2-147"></a>
<a href="#__codelineno-2-148" id="__codelineno-2-148" name="__codelineno-2-148"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">safety_check</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">model_output</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">bool</span><span class="p">]:</span>
<a href="#__codelineno-2-149" id="__codelineno-2-149" name="__codelineno-2-149"></a><span class="w">        </span><span class="sd">"""Check medical model outputs for safety issues"""</span>
<a href="#__codelineno-2-150" id="__codelineno-2-150" name="__codelineno-2-150"></a>        <span class="n">safety_flags</span> <span class="o">=</span> <span class="p">{</span>
<a href="#__codelineno-2-151" id="__codelineno-2-151" name="__codelineno-2-151"></a>            <span class="s1">'contains_disclaimer'</span><span class="p">:</span> <span class="nb">any</span><span class="p">(</span><span class="n">phrase</span> <span class="ow">in</span> <span class="n">model_output</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="k">for</span> <span class="n">phrase</span> <span class="ow">in</span> <span class="p">[</span>
<a href="#__codelineno-2-152" id="__codelineno-2-152" name="__codelineno-2-152"></a>                <span class="s1">'consult'</span><span class="p">,</span> <span class="s1">'doctor'</span><span class="p">,</span> <span class="s1">'physician'</span><span class="p">,</span> <span class="s1">'medical professional'</span><span class="p">,</span> <span class="s1">'not medical advice'</span>
<a href="#__codelineno-2-153" id="__codelineno-2-153" name="__codelineno-2-153"></a>            <span class="p">]),</span>
<a href="#__codelineno-2-154" id="__codelineno-2-154" name="__codelineno-2-154"></a>            <span class="s1">'avoids_definitive_diagnosis'</span><span class="p">:</span> <span class="ow">not</span> <span class="nb">any</span><span class="p">(</span><span class="n">phrase</span> <span class="ow">in</span> <span class="n">model_output</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="k">for</span> <span class="n">phrase</span> <span class="ow">in</span> <span class="p">[</span>
<a href="#__codelineno-2-155" id="__codelineno-2-155" name="__codelineno-2-155"></a>                <span class="s1">'you have'</span><span class="p">,</span> <span class="s1">'you definitely'</span><span class="p">,</span> <span class="s1">'certainly'</span><span class="p">,</span> <span class="s1">'absolutely'</span>
<a href="#__codelineno-2-156" id="__codelineno-2-156" name="__codelineno-2-156"></a>            <span class="p">]),</span>
<a href="#__codelineno-2-157" id="__codelineno-2-157" name="__codelineno-2-157"></a>            <span class="s1">'appropriate_uncertainty'</span><span class="p">:</span> <span class="nb">any</span><span class="p">(</span><span class="n">phrase</span> <span class="ow">in</span> <span class="n">model_output</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="k">for</span> <span class="n">phrase</span> <span class="ow">in</span> <span class="p">[</span>
<a href="#__codelineno-2-158" id="__codelineno-2-158" name="__codelineno-2-158"></a>                <span class="s1">'may'</span><span class="p">,</span> <span class="s1">'might'</span><span class="p">,</span> <span class="s1">'could'</span><span class="p">,</span> <span class="s1">'possibly'</span><span class="p">,</span> <span class="s1">'likely'</span>
<a href="#__codelineno-2-159" id="__codelineno-2-159" name="__codelineno-2-159"></a>            <span class="p">])</span>
<a href="#__codelineno-2-160" id="__codelineno-2-160" name="__codelineno-2-160"></a>        <span class="p">}</span>
<a href="#__codelineno-2-161" id="__codelineno-2-161" name="__codelineno-2-161"></a>
<a href="#__codelineno-2-162" id="__codelineno-2-162" name="__codelineno-2-162"></a>        <span class="k">return</span> <span class="n">safety_flags</span>
<a href="#__codelineno-2-163" id="__codelineno-2-163" name="__codelineno-2-163"></a>
<a href="#__codelineno-2-164" id="__codelineno-2-164" name="__codelineno-2-164"></a><span class="c1"># Example medical fine-tuning</span>
<a href="#__codelineno-2-165" id="__codelineno-2-165" name="__codelineno-2-165"></a><span class="n">medical_tuner</span> <span class="o">=</span> <span class="n">MedicalDomainFineTuner</span><span class="p">()</span>
<a href="#__codelineno-2-166" id="__codelineno-2-166" name="__codelineno-2-166"></a><span class="n">medical_data</span> <span class="o">=</span> <span class="n">medical_tuner</span><span class="o">.</span><span class="n">create_medical_training_data</span><span class="p">()</span>
<a href="#__codelineno-2-167" id="__codelineno-2-167" name="__codelineno-2-167"></a>
<a href="#__codelineno-2-168" id="__codelineno-2-168" name="__codelineno-2-168"></a><span class="nb">print</span><span class="p">(</span><span class="s2">"Medical Training Data Examples:"</span><span class="p">)</span>
<a href="#__codelineno-2-169" id="__codelineno-2-169" name="__codelineno-2-169"></a><span class="k">for</span> <span class="n">example</span> <span class="ow">in</span> <span class="n">medical_data</span><span class="p">[:</span><span class="mi">3</span><span class="p">]:</span>
<a href="#__codelineno-2-170" id="__codelineno-2-170" name="__codelineno-2-170"></a>    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"Task: </span><span class="si">{</span><span class="n">example</span><span class="p">[</span><span class="s1">'task'</span><span class="p">]</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
<a href="#__codelineno-2-171" id="__codelineno-2-171" name="__codelineno-2-171"></a>    <span class="k">if</span> <span class="s1">'text'</span> <span class="ow">in</span> <span class="n">example</span><span class="p">:</span>
<a href="#__codelineno-2-172" id="__codelineno-2-172" name="__codelineno-2-172"></a>        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"Text: </span><span class="si">{</span><span class="n">example</span><span class="p">[</span><span class="s1">'text'</span><span class="p">]</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
<a href="#__codelineno-2-173" id="__codelineno-2-173" name="__codelineno-2-173"></a>        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"Label: </span><span class="si">{</span><span class="n">example</span><span class="p">[</span><span class="s1">'label'</span><span class="p">]</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
<a href="#__codelineno-2-174" id="__codelineno-2-174" name="__codelineno-2-174"></a>    <span class="k">elif</span> <span class="s1">'question'</span> <span class="ow">in</span> <span class="n">example</span><span class="p">:</span>
<a href="#__codelineno-2-175" id="__codelineno-2-175" name="__codelineno-2-175"></a>        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"Question: </span><span class="si">{</span><span class="n">example</span><span class="p">[</span><span class="s1">'question'</span><span class="p">]</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
<a href="#__codelineno-2-176" id="__codelineno-2-176" name="__codelineno-2-176"></a>        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"Answer: </span><span class="si">{</span><span class="n">example</span><span class="p">[</span><span class="s1">'answer'</span><span class="p">]</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
<a href="#__codelineno-2-177" id="__codelineno-2-177" name="__codelineno-2-177"></a>    <span class="nb">print</span><span class="p">(</span><span class="s2">"-"</span> <span class="o">*</span> <span class="mi">40</span><span class="p">)</span>
<a href="#__codelineno-2-178" id="__codelineno-2-178" name="__codelineno-2-178"></a>
<a href="#__codelineno-2-179" id="__codelineno-2-179" name="__codelineno-2-179"></a><span class="c1"># Test safety checking</span>
<a href="#__codelineno-2-180" id="__codelineno-2-180" name="__codelineno-2-180"></a><span class="n">test_output</span> <span class="o">=</span> <span class="s2">"Based on the symptoms described, this could possibly indicate a myocardial infarction. However, you should consult with a physician for proper diagnosis."</span>
<a href="#__codelineno-2-181" id="__codelineno-2-181" name="__codelineno-2-181"></a><span class="n">safety_results</span> <span class="o">=</span> <span class="n">medical_tuner</span><span class="o">.</span><span class="n">safety_check</span><span class="p">(</span><span class="n">test_output</span><span class="p">)</span>
<a href="#__codelineno-2-182" id="__codelineno-2-182" name="__codelineno-2-182"></a><span class="nb">print</span><span class="p">(</span><span class="s2">"Safety Check Results:"</span><span class="p">,</span> <span class="n">safety_results</span><span class="p">)</span>
</code></pre></div></p>
<h3 id="code-generation-fine-tuning">Code Generation Fine-tuning</h3>
<p><strong>Programming Domain Adaptation</strong>:
<div class="highlight"><pre><span></span><code><a href="#__codelineno-3-1" id="__codelineno-3-1" name="__codelineno-3-1"></a><span class="k">class</span><span class="w"> </span><span class="nc">CodeGenerationFineTuner</span><span class="p">:</span>
<a href="#__codelineno-3-2" id="__codelineno-3-2" name="__codelineno-3-2"></a><span class="w">    </span><span class="sd">"""Fine-tune models for code generation tasks"""</span>
<a href="#__codelineno-3-3" id="__codelineno-3-3" name="__codelineno-3-3"></a>
<a href="#__codelineno-3-4" id="__codelineno-3-4" name="__codelineno-3-4"></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<a href="#__codelineno-3-5" id="__codelineno-3-5" name="__codelineno-3-5"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">programming_languages</span> <span class="o">=</span> <span class="p">[</span><span class="s1">'python'</span><span class="p">,</span> <span class="s1">'javascript'</span><span class="p">,</span> <span class="s1">'java'</span><span class="p">,</span> <span class="s1">'cpp'</span><span class="p">,</span> <span class="s1">'go'</span><span class="p">]</span>
<a href="#__codelineno-3-6" id="__codelineno-3-6" name="__codelineno-3-6"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">code_patterns</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">load_code_patterns</span><span class="p">()</span>
<a href="#__codelineno-3-7" id="__codelineno-3-7" name="__codelineno-3-7"></a>
<a href="#__codelineno-3-8" id="__codelineno-3-8" name="__codelineno-3-8"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">load_code_patterns</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]]:</span>
<a href="#__codelineno-3-9" id="__codelineno-3-9" name="__codelineno-3-9"></a><span class="w">        </span><span class="sd">"""Load common code patterns for different tasks"""</span>
<a href="#__codelineno-3-10" id="__codelineno-3-10" name="__codelineno-3-10"></a>        <span class="k">return</span> <span class="p">{</span>
<a href="#__codelineno-3-11" id="__codelineno-3-11" name="__codelineno-3-11"></a>            <span class="s1">'function_definition'</span><span class="p">:</span> <span class="p">{</span>
<a href="#__codelineno-3-12" id="__codelineno-3-12" name="__codelineno-3-12"></a>                <span class="s1">'python'</span><span class="p">:</span> <span class="p">[</span><span class="s1">'def </span><span class="si">{name}</span><span class="s1">(</span><span class="si">{params}</span><span class="s1">):'</span><span class="p">,</span> <span class="s1">'return </span><span class="si">{result}</span><span class="s1">'</span><span class="p">],</span>
<a href="#__codelineno-3-13" id="__codelineno-3-13" name="__codelineno-3-13"></a>                <span class="s1">'javascript'</span><span class="p">:</span> <span class="p">[</span><span class="s1">'function </span><span class="si">{name}</span><span class="s1">(</span><span class="si">{params}</span><span class="s1">) {'</span><span class="p">,</span> <span class="s1">'return </span><span class="si">{result}</span><span class="s1">;'</span><span class="p">,</span> <span class="s1">'}'</span><span class="p">],</span>
<a href="#__codelineno-3-14" id="__codelineno-3-14" name="__codelineno-3-14"></a>                <span class="s1">'java'</span><span class="p">:</span> <span class="p">[</span><span class="s1">'public </span><span class="si">{return_type}</span><span class="s1"> </span><span class="si">{name}</span><span class="s1">(</span><span class="si">{params}</span><span class="s1">) {'</span><span class="p">,</span> <span class="s1">'return </span><span class="si">{result}</span><span class="s1">;'</span><span class="p">,</span> <span class="s1">'}'</span><span class="p">]</span>
<a href="#__codelineno-3-15" id="__codelineno-3-15" name="__codelineno-3-15"></a>            <span class="p">},</span>
<a href="#__codelineno-3-16" id="__codelineno-3-16" name="__codelineno-3-16"></a>            <span class="s1">'class_definition'</span><span class="p">:</span> <span class="p">{</span>
<a href="#__codelineno-3-17" id="__codelineno-3-17" name="__codelineno-3-17"></a>                <span class="s1">'python'</span><span class="p">:</span> <span class="p">[</span><span class="s1">'class </span><span class="si">{name}</span><span class="s1">:'</span><span class="p">,</span> <span class="s1">'__init__(self, </span><span class="si">{params}</span><span class="s1">):'</span><span class="p">,</span> <span class="s1">'self.</span><span class="si">{attr}</span><span class="s1"> = </span><span class="si">{value}</span><span class="s1">'</span><span class="p">],</span>
<a href="#__codelineno-3-18" id="__codelineno-3-18" name="__codelineno-3-18"></a>                <span class="s1">'javascript'</span><span class="p">:</span> <span class="p">[</span><span class="s1">'class </span><span class="si">{name}</span><span class="s1"> {'</span><span class="p">,</span> <span class="s1">'constructor(</span><span class="si">{params}</span><span class="s1">) {'</span><span class="p">,</span> <span class="s1">'this.</span><span class="si">{attr}</span><span class="s1"> = </span><span class="si">{value}</span><span class="s1">;'</span><span class="p">,</span> <span class="s1">'}'</span><span class="p">],</span>
<a href="#__codelineno-3-19" id="__codelineno-3-19" name="__codelineno-3-19"></a>                <span class="s1">'java'</span><span class="p">:</span> <span class="p">[</span><span class="s1">'public class </span><span class="si">{name}</span><span class="s1"> {'</span><span class="p">,</span> <span class="s1">'public </span><span class="si">{name}</span><span class="s1">(</span><span class="si">{params}</span><span class="s1">) {'</span><span class="p">,</span> <span class="s1">'this.</span><span class="si">{attr}</span><span class="s1"> = </span><span class="si">{value}</span><span class="s1">;'</span><span class="p">,</span> <span class="s1">'}'</span><span class="p">]</span>
<a href="#__codelineno-3-20" id="__codelineno-3-20" name="__codelineno-3-20"></a>            <span class="p">}</span>
<a href="#__codelineno-3-21" id="__codelineno-3-21" name="__codelineno-3-21"></a>        <span class="p">}</span>
<a href="#__codelineno-3-22" id="__codelineno-3-22" name="__codelineno-3-22"></a>
<a href="#__codelineno-3-23" id="__codelineno-3-23" name="__codelineno-3-23"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">create_code_training_data</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]]:</span>
<a href="#__codelineno-3-24" id="__codelineno-3-24" name="__codelineno-3-24"></a><span class="w">        </span><span class="sd">"""Create training data for code generation"""</span>
<a href="#__codelineno-3-25" id="__codelineno-3-25" name="__codelineno-3-25"></a>        <span class="n">examples</span> <span class="o">=</span> <span class="p">[]</span>
<a href="#__codelineno-3-26" id="__codelineno-3-26" name="__codelineno-3-26"></a>
<a href="#__codelineno-3-27" id="__codelineno-3-27" name="__codelineno-3-27"></a>        <span class="c1"># Function generation examples</span>
<a href="#__codelineno-3-28" id="__codelineno-3-28" name="__codelineno-3-28"></a>        <span class="n">examples</span><span class="o">.</span><span class="n">extend</span><span class="p">([</span>
<a href="#__codelineno-3-29" id="__codelineno-3-29" name="__codelineno-3-29"></a>            <span class="p">{</span>
<a href="#__codelineno-3-30" id="__codelineno-3-30" name="__codelineno-3-30"></a>                <span class="s1">'instruction'</span><span class="p">:</span> <span class="s1">'Write a Python function to calculate the factorial of a number'</span><span class="p">,</span>
<a href="#__codelineno-3-31" id="__codelineno-3-31" name="__codelineno-3-31"></a>                <span class="s1">'input'</span><span class="p">:</span> <span class="s1">'n: integer'</span><span class="p">,</span>
<a href="#__codelineno-3-32" id="__codelineno-3-32" name="__codelineno-3-32"></a>                <span class="s1">'output'</span><span class="p">:</span> <span class="s1">'''def factorial(n):</span>
<a href="#__codelineno-3-33" id="__codelineno-3-33" name="__codelineno-3-33"></a><span class="s1">    if n == 0 or n == 1:</span>
<a href="#__codelineno-3-34" id="__codelineno-3-34" name="__codelineno-3-34"></a><span class="s1">        return 1</span>
<a href="#__codelineno-3-35" id="__codelineno-3-35" name="__codelineno-3-35"></a><span class="s1">    return n * factorial(n - 1)'''</span><span class="p">,</span>
<a href="#__codelineno-3-36" id="__codelineno-3-36" name="__codelineno-3-36"></a>                <span class="s1">'language'</span><span class="p">:</span> <span class="s1">'python'</span><span class="p">,</span>
<a href="#__codelineno-3-37" id="__codelineno-3-37" name="__codelineno-3-37"></a>                <span class="s1">'task'</span><span class="p">:</span> <span class="s1">'function_generation'</span>
<a href="#__codelineno-3-38" id="__codelineno-3-38" name="__codelineno-3-38"></a>            <span class="p">},</span>
<a href="#__codelineno-3-39" id="__codelineno-3-39" name="__codelineno-3-39"></a>            <span class="p">{</span>
<a href="#__codelineno-3-40" id="__codelineno-3-40" name="__codelineno-3-40"></a>                <span class="s1">'instruction'</span><span class="p">:</span> <span class="s1">'Create a JavaScript function to reverse a string'</span><span class="p">,</span>
<a href="#__codelineno-3-41" id="__codelineno-3-41" name="__codelineno-3-41"></a>                <span class="s1">'input'</span><span class="p">:</span> <span class="s1">'str: string'</span><span class="p">,</span>
<a href="#__codelineno-3-42" id="__codelineno-3-42" name="__codelineno-3-42"></a>                <span class="s1">'output'</span><span class="p">:</span> <span class="s1">'''function reverseString(str) {</span>
<a href="#__codelineno-3-43" id="__codelineno-3-43" name="__codelineno-3-43"></a><span class="s1">    return str.split('').reverse().join('');</span>
<a href="#__codelineno-3-44" id="__codelineno-3-44" name="__codelineno-3-44"></a><span class="s1">}'''</span><span class="p">,</span>
<a href="#__codelineno-3-45" id="__codelineno-3-45" name="__codelineno-3-45"></a>                <span class="s1">'language'</span><span class="p">:</span> <span class="s1">'javascript'</span><span class="p">,</span>
<a href="#__codelineno-3-46" id="__codelineno-3-46" name="__codelineno-3-46"></a>                <span class="s1">'task'</span><span class="p">:</span> <span class="s1">'function_generation'</span>
<a href="#__codelineno-3-47" id="__codelineno-3-47" name="__codelineno-3-47"></a>            <span class="p">}</span>
<a href="#__codelineno-3-48" id="__codelineno-3-48" name="__codelineno-3-48"></a>        <span class="p">])</span>
<a href="#__codelineno-3-49" id="__codelineno-3-49" name="__codelineno-3-49"></a>
<a href="#__codelineno-3-50" id="__codelineno-3-50" name="__codelineno-3-50"></a>        <span class="c1"># Code explanation examples</span>
<a href="#__codelineno-3-51" id="__codelineno-3-51" name="__codelineno-3-51"></a>        <span class="n">examples</span><span class="o">.</span><span class="n">extend</span><span class="p">([</span>
<a href="#__codelineno-3-52" id="__codelineno-3-52" name="__codelineno-3-52"></a>            <span class="p">{</span>
<a href="#__codelineno-3-53" id="__codelineno-3-53" name="__codelineno-3-53"></a>                <span class="s1">'instruction'</span><span class="p">:</span> <span class="s1">'Explain what this Python code does'</span><span class="p">,</span>
<a href="#__codelineno-3-54" id="__codelineno-3-54" name="__codelineno-3-54"></a>                <span class="s1">'input'</span><span class="p">:</span> <span class="s1">'''def binary_search(arr, target):</span>
<a href="#__codelineno-3-55" id="__codelineno-3-55" name="__codelineno-3-55"></a><span class="s1">    left, right = 0, len(arr) - 1</span>
<a href="#__codelineno-3-56" id="__codelineno-3-56" name="__codelineno-3-56"></a><span class="s1">    while left &lt;= right:</span>
<a href="#__codelineno-3-57" id="__codelineno-3-57" name="__codelineno-3-57"></a><span class="s1">        mid = (left + right) // 2</span>
<a href="#__codelineno-3-58" id="__codelineno-3-58" name="__codelineno-3-58"></a><span class="s1">        if arr[mid] == target:</span>
<a href="#__codelineno-3-59" id="__codelineno-3-59" name="__codelineno-3-59"></a><span class="s1">            return mid</span>
<a href="#__codelineno-3-60" id="__codelineno-3-60" name="__codelineno-3-60"></a><span class="s1">        elif arr[mid] &lt; target:</span>
<a href="#__codelineno-3-61" id="__codelineno-3-61" name="__codelineno-3-61"></a><span class="s1">            left = mid + 1</span>
<a href="#__codelineno-3-62" id="__codelineno-3-62" name="__codelineno-3-62"></a><span class="s1">        else:</span>
<a href="#__codelineno-3-63" id="__codelineno-3-63" name="__codelineno-3-63"></a><span class="s1">            right = mid - 1</span>
<a href="#__codelineno-3-64" id="__codelineno-3-64" name="__codelineno-3-64"></a><span class="s1">    return -1'''</span><span class="p">,</span>
<a href="#__codelineno-3-65" id="__codelineno-3-65" name="__codelineno-3-65"></a>                <span class="s1">'output'</span><span class="p">:</span> <span class="s1">'This function implements binary search algorithm to find the index of a target value in a sorted array. It uses two pointers (left and right) to narrow down the search space by comparing the middle element with the target.'</span><span class="p">,</span>
<a href="#__codelineno-3-66" id="__codelineno-3-66" name="__codelineno-3-66"></a>                <span class="s1">'language'</span><span class="p">:</span> <span class="s1">'python'</span><span class="p">,</span>
<a href="#__codelineno-3-67" id="__codelineno-3-67" name="__codelineno-3-67"></a>                <span class="s1">'task'</span><span class="p">:</span> <span class="s1">'code_explanation'</span>
<a href="#__codelineno-3-68" id="__codelineno-3-68" name="__codelineno-3-68"></a>            <span class="p">}</span>
<a href="#__codelineno-3-69" id="__codelineno-3-69" name="__codelineno-3-69"></a>        <span class="p">])</span>
<a href="#__codelineno-3-70" id="__codelineno-3-70" name="__codelineno-3-70"></a>
<a href="#__codelineno-3-71" id="__codelineno-3-71" name="__codelineno-3-71"></a>        <span class="c1"># Bug fixing examples</span>
<a href="#__codelineno-3-72" id="__codelineno-3-72" name="__codelineno-3-72"></a>        <span class="n">examples</span><span class="o">.</span><span class="n">extend</span><span class="p">([</span>
<a href="#__codelineno-3-73" id="__codelineno-3-73" name="__codelineno-3-73"></a>            <span class="p">{</span>
<a href="#__codelineno-3-74" id="__codelineno-3-74" name="__codelineno-3-74"></a>                <span class="s1">'instruction'</span><span class="p">:</span> <span class="s1">'Fix the bug in this Python code'</span><span class="p">,</span>
<a href="#__codelineno-3-75" id="__codelineno-3-75" name="__codelineno-3-75"></a>                <span class="s1">'input'</span><span class="p">:</span> <span class="s1">'''def divide_numbers(a, b):</span>
<a href="#__codelineno-3-76" id="__codelineno-3-76" name="__codelineno-3-76"></a><span class="s1">    return a / b  # Bug: No check for division by zero'''</span><span class="p">,</span>
<a href="#__codelineno-3-77" id="__codelineno-3-77" name="__codelineno-3-77"></a>                <span class="s1">'output'</span><span class="p">:</span> <span class="s1">'''def divide_numbers(a, b):</span>
<a href="#__codelineno-3-78" id="__codelineno-3-78" name="__codelineno-3-78"></a><span class="s1">    if b == 0:</span>
<a href="#__codelineno-3-79" id="__codelineno-3-79" name="__codelineno-3-79"></a><span class="s1">        raise ValueError("Cannot divide by zero")</span>
<a href="#__codelineno-3-80" id="__codelineno-3-80" name="__codelineno-3-80"></a><span class="s1">    return a / b'''</span><span class="p">,</span>
<a href="#__codelineno-3-81" id="__codelineno-3-81" name="__codelineno-3-81"></a>                <span class="s1">'language'</span><span class="p">:</span> <span class="s1">'python'</span><span class="p">,</span>
<a href="#__codelineno-3-82" id="__codelineno-3-82" name="__codelineno-3-82"></a>                <span class="s1">'task'</span><span class="p">:</span> <span class="s1">'bug_fixing'</span>
<a href="#__codelineno-3-83" id="__codelineno-3-83" name="__codelineno-3-83"></a>            <span class="p">}</span>
<a href="#__codelineno-3-84" id="__codelineno-3-84" name="__codelineno-3-84"></a>        <span class="p">])</span>
<a href="#__codelineno-3-85" id="__codelineno-3-85" name="__codelineno-3-85"></a>
<a href="#__codelineno-3-86" id="__codelineno-3-86" name="__codelineno-3-86"></a>        <span class="k">return</span> <span class="n">examples</span>
<a href="#__codelineno-3-87" id="__codelineno-3-87" name="__codelineno-3-87"></a>
<a href="#__codelineno-3-88" id="__codelineno-3-88" name="__codelineno-3-88"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">create_code_prompts</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">task_type</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<a href="#__codelineno-3-89" id="__codelineno-3-89" name="__codelineno-3-89"></a><span class="w">        </span><span class="sd">"""Create task-specific prompts for code generation"""</span>
<a href="#__codelineno-3-90" id="__codelineno-3-90" name="__codelineno-3-90"></a>        <span class="n">prompts</span> <span class="o">=</span> <span class="p">{</span>
<a href="#__codelineno-3-91" id="__codelineno-3-91" name="__codelineno-3-91"></a>            <span class="s1">'function_generation'</span><span class="p">:</span> <span class="s1">'''</span>
<a href="#__codelineno-3-92" id="__codelineno-3-92" name="__codelineno-3-92"></a><span class="s1">You are an expert programmer. Generate clean, efficient, and well-documented code.</span>
<a href="#__codelineno-3-93" id="__codelineno-3-93" name="__codelineno-3-93"></a>
<a href="#__codelineno-3-94" id="__codelineno-3-94" name="__codelineno-3-94"></a><span class="s1">Task: </span><span class="si">{instruction}</span>
<a href="#__codelineno-3-95" id="__codelineno-3-95" name="__codelineno-3-95"></a><span class="s1">Input specification: </span><span class="si">{input}</span>
<a href="#__codelineno-3-96" id="__codelineno-3-96" name="__codelineno-3-96"></a><span class="s1">Programming language: </span><span class="si">{language}</span>
<a href="#__codelineno-3-97" id="__codelineno-3-97" name="__codelineno-3-97"></a>
<a href="#__codelineno-3-98" id="__codelineno-3-98" name="__codelineno-3-98"></a><span class="s1">Requirements:</span>
<a href="#__codelineno-3-99" id="__codelineno-3-99" name="__codelineno-3-99"></a><span class="s1">- Write clean, readable code</span>
<a href="#__codelineno-3-100" id="__codelineno-3-100" name="__codelineno-3-100"></a><span class="s1">- Include proper error handling</span>
<a href="#__codelineno-3-101" id="__codelineno-3-101" name="__codelineno-3-101"></a><span class="s1">- Add comments for complex logic</span>
<a href="#__codelineno-3-102" id="__codelineno-3-102" name="__codelineno-3-102"></a><span class="s1">- Follow language best practices</span>
<a href="#__codelineno-3-103" id="__codelineno-3-103" name="__codelineno-3-103"></a>
<a href="#__codelineno-3-104" id="__codelineno-3-104" name="__codelineno-3-104"></a><span class="s1">Code:'''</span><span class="p">,</span>
<a href="#__codelineno-3-105" id="__codelineno-3-105" name="__codelineno-3-105"></a>
<a href="#__codelineno-3-106" id="__codelineno-3-106" name="__codelineno-3-106"></a>            <span class="s1">'code_explanation'</span><span class="p">:</span> <span class="s1">'''</span>
<a href="#__codelineno-3-107" id="__codelineno-3-107" name="__codelineno-3-107"></a><span class="s1">You are a coding instructor. Explain code clearly and concisely.</span>
<a href="#__codelineno-3-108" id="__codelineno-3-108" name="__codelineno-3-108"></a>
<a href="#__codelineno-3-109" id="__codelineno-3-109" name="__codelineno-3-109"></a><span class="s1">Please explain what the following </span><span class="si">{language}</span><span class="s1"> code does:</span>
<a href="#__codelineno-3-110" id="__codelineno-3-110" name="__codelineno-3-110"></a>
<a href="#__codelineno-3-111" id="__codelineno-3-111" name="__codelineno-3-111"></a><span class="s1">```</span><span class="si">{language}</span>
<a href="#__codelineno-3-112" id="__codelineno-3-112" name="__codelineno-3-112"></a><span class="si">{input}</span>
</code></pre></div></p>
<p>Explanation:''',</p>
<div class="highlight"><pre><span></span><code>        'bug_fixing': '''
</code></pre></div>
<p>You are a senior developer reviewing code for bugs.</p>
<p>The following {language} code has a bug. Please identify and fix it:</p>
<div class="highlight"><pre><span></span><code><a href="#__codelineno-4-1" id="__codelineno-4-1" name="__codelineno-4-1"></a>{input}
</code></pre></div>
<p>Fixed code:''',</p>
<div class="highlight"><pre><span></span><code>        'code_optimization': '''
</code></pre></div>
<p>You are a performance optimization expert.</p>
<p>Optimize the following {language} code for better performance:</p>
<div class="highlight"><pre><span></span><code><a href="#__codelineno-5-1" id="__codelineno-5-1" name="__codelineno-5-1"></a>{input}
</code></pre></div>
<p>Optimized code:'''
        }</p>
<div class="highlight"><pre><span></span><code>    return prompts.get(task_type, "")

def evaluate_code_generation(self, generated_code: str, language: str) -&gt; Dict[str, float]:
    """Evaluate generated code quality"""
    metrics = {}

    # Syntax check (simplified)
    syntax_indicators = {
        'python': ['def ', 'class ', 'import ', 'if ', 'for ', 'while '],
        'javascript': ['function ', 'class ', 'const ', 'let ', 'if (', 'for ('],
        'java': ['public ', 'private ', 'class ', 'if (', 'for (', 'while (']
    }

    if language in syntax_indicators:
        syntax_score = sum(1 for indicator in syntax_indicators[language] 
                         if indicator in generated_code) / len(syntax_indicators[language])
        metrics['syntax_coverage'] = syntax_score

    # Code structure metrics
    lines = generated_code.split('\n')
    metrics['lines_of_code'] = len([line for line in lines if line.strip()])
    metrics['comment_ratio'] = len([line for line in lines if line.strip().startswith('#')]) / len(lines)

    # Complexity indicators (simplified)
    complexity_keywords = ['if', 'for', 'while', 'try', 'except', 'switch', 'case']
    complexity_count = sum(1 for keyword in complexity_keywords 
                          if keyword in generated_code.lower())
    metrics['complexity_score'] = complexity_count

    return metrics

def code_safety_check(self, generated_code: str, language: str) -&gt; Dict[str, bool]:
    """Check generated code for potential safety issues"""
    safety_flags = {
        'has_input_validation': any(check in generated_code.lower() for check in [
            'if not', 'assert', 'raise', 'throw', 'check'
        ]),
        'avoids_dangerous_functions': not any(func in generated_code.lower() for func in [
            'eval(', 'exec(', 'system(', '__import__', 'getattr('
        ]),
        'has_error_handling': any(handler in generated_code.lower() for handler in [
            'try:', 'except:', 'catch', 'finally:', 'throw', 'error'
        ])
    }

    # Language-specific checks
    if language == 'python':
        safety_flags['no_sql_injection'] = 'execute(' not in generated_code.lower()
    elif language == 'javascript':
        safety_flags['no_xss_risk'] = 'innerHTML' not in generated_code

    return safety_flags
</code></pre></div>
<h1 id="example-code-fine-tuning">Example code fine-tuning</h1>
<p>code_tuner = CodeGenerationFineTuner()
code_data = code_tuner.create_code_training_data()</p>
<p>print("Code Generation Training Examples:")
for example in code_data[:2]:
    print(f"Task: {example['task']}")
    print(f"Language: {example['language']}")
    print(f"Instruction: {example['instruction']}")
    print(f"Output:\n{example['output']}")
    print("-" * 50)</p>
<h1 id="test-code-evaluation">Test code evaluation</h1>
<p>test_code = '''def fibonacci(n):
    if n &lt;= 1:
        return n
    return fibonacci(n-1) + fibonacci(n-2)'''</p>
<p>code_metrics = code_tuner.evaluate_code_generation(test_code, 'python')
safety_check = code_tuner.code_safety_check(test_code, 'python')</p>
<p>print("Code Evaluation Metrics:", code_metrics)
print("Safety Check:", safety_check)
<div class="highlight"><pre><span></span><code><a href="#__codelineno-6-1" id="__codelineno-6-1" name="__codelineno-6-1"></a>## 🔍 Fine-tuning Evaluation and Monitoring
<a href="#__codelineno-6-2" id="__codelineno-6-2" name="__codelineno-6-2"></a>
<a href="#__codelineno-6-3" id="__codelineno-6-3" name="__codelineno-6-3"></a>### Comprehensive Evaluation Framework
<a href="#__codelineno-6-4" id="__codelineno-6-4" name="__codelineno-6-4"></a>
<a href="#__codelineno-6-5" id="__codelineno-6-5" name="__codelineno-6-5"></a>**Multi-Metric Evaluation**:
<a href="#__codelineno-6-6" id="__codelineno-6-6" name="__codelineno-6-6"></a>```python
<a href="#__codelineno-6-7" id="__codelineno-6-7" name="__codelineno-6-7"></a>class FineTuningEvaluator:
<a href="#__codelineno-6-8" id="__codelineno-6-8" name="__codelineno-6-8"></a>    """Comprehensive evaluation framework for fine-tuned models"""
<a href="#__codelineno-6-9" id="__codelineno-6-9" name="__codelineno-6-9"></a>
<a href="#__codelineno-6-10" id="__codelineno-6-10" name="__codelineno-6-10"></a>    def __init__(self):
<a href="#__codelineno-6-11" id="__codelineno-6-11" name="__codelineno-6-11"></a>        self.evaluation_metrics = {
<a href="#__codelineno-6-12" id="__codelineno-6-12" name="__codelineno-6-12"></a>            'accuracy': self.calculate_accuracy,
<a href="#__codelineno-6-13" id="__codelineno-6-13" name="__codelineno-6-13"></a>            'perplexity': self.calculate_perplexity,
<a href="#__codelineno-6-14" id="__codelineno-6-14" name="__codelineno-6-14"></a>            'bleu_score': self.calculate_bleu,
<a href="#__codelineno-6-15" id="__codelineno-6-15" name="__codelineno-6-15"></a>            'rouge_score': self.calculate_rouge,
<a href="#__codelineno-6-16" id="__codelineno-6-16" name="__codelineno-6-16"></a>            'semantic_similarity': self.calculate_semantic_similarity,
<a href="#__codelineno-6-17" id="__codelineno-6-17" name="__codelineno-6-17"></a>            'task_specific': self.calculate_task_specific_metrics
<a href="#__codelineno-6-18" id="__codelineno-6-18" name="__codelineno-6-18"></a>        }
<a href="#__codelineno-6-19" id="__codelineno-6-19" name="__codelineno-6-19"></a>
<a href="#__codelineno-6-20" id="__codelineno-6-20" name="__codelineno-6-20"></a>        self.catastrophic_forgetting_tests = []
<a href="#__codelineno-6-21" id="__codelineno-6-21" name="__codelineno-6-21"></a>
<a href="#__codelineno-6-22" id="__codelineno-6-22" name="__codelineno-6-22"></a>    def calculate_accuracy(self, predictions: List[str], ground_truth: List[str]) -&gt; float:
<a href="#__codelineno-6-23" id="__codelineno-6-23" name="__codelineno-6-23"></a>        """Calculate classification accuracy"""
<a href="#__codelineno-6-24" id="__codelineno-6-24" name="__codelineno-6-24"></a>        if len(predictions) != len(ground_truth):
<a href="#__codelineno-6-25" id="__codelineno-6-25" name="__codelineno-6-25"></a>            return 0.0
<a href="#__codelineno-6-26" id="__codelineno-6-26" name="__codelineno-6-26"></a>
<a href="#__codelineno-6-27" id="__codelineno-6-27" name="__codelineno-6-27"></a>        correct = sum(1 for pred, gt in zip(predictions, ground_truth) 
<a href="#__codelineno-6-28" id="__codelineno-6-28" name="__codelineno-6-28"></a>                     if pred.strip().lower() == gt.strip().lower())
<a href="#__codelineno-6-29" id="__codelineno-6-29" name="__codelineno-6-29"></a>
<a href="#__codelineno-6-30" id="__codelineno-6-30" name="__codelineno-6-30"></a>        return correct / len(predictions)
<a href="#__codelineno-6-31" id="__codelineno-6-31" name="__codelineno-6-31"></a>
<a href="#__codelineno-6-32" id="__codelineno-6-32" name="__codelineno-6-32"></a>    def calculate_perplexity(self, model_probs: List[List[float]]) -&gt; float:
<a href="#__codelineno-6-33" id="__codelineno-6-33" name="__codelineno-6-33"></a>        """Calculate perplexity from model probabilities"""
<a href="#__codelineno-6-34" id="__codelineno-6-34" name="__codelineno-6-34"></a>        total_log_prob = 0.0
<a href="#__codelineno-6-35" id="__codelineno-6-35" name="__codelineno-6-35"></a>        total_tokens = 0
<a href="#__codelineno-6-36" id="__codelineno-6-36" name="__codelineno-6-36"></a>
<a href="#__codelineno-6-37" id="__codelineno-6-37" name="__codelineno-6-37"></a>        for token_probs in model_probs:
<a href="#__codelineno-6-38" id="__codelineno-6-38" name="__codelineno-6-38"></a>            for prob in token_probs:
<a href="#__codelineno-6-39" id="__codelineno-6-39" name="__codelineno-6-39"></a>                if prob &gt; 0:
<a href="#__codelineno-6-40" id="__codelineno-6-40" name="__codelineno-6-40"></a>                    total_log_prob += np.log(prob)
<a href="#__codelineno-6-41" id="__codelineno-6-41" name="__codelineno-6-41"></a>                    total_tokens += 1
<a href="#__codelineno-6-42" id="__codelineno-6-42" name="__codelineno-6-42"></a>
<a href="#__codelineno-6-43" id="__codelineno-6-43" name="__codelineno-6-43"></a>        if total_tokens == 0:
<a href="#__codelineno-6-44" id="__codelineno-6-44" name="__codelineno-6-44"></a>            return float('inf')
<a href="#__codelineno-6-45" id="__codelineno-6-45" name="__codelineno-6-45"></a>
<a href="#__codelineno-6-46" id="__codelineno-6-46" name="__codelineno-6-46"></a>        avg_log_prob = total_log_prob / total_tokens
<a href="#__codelineno-6-47" id="__codelineno-6-47" name="__codelineno-6-47"></a>        perplexity = np.exp(-avg_log_prob)
<a href="#__codelineno-6-48" id="__codelineno-6-48" name="__codelineno-6-48"></a>
<a href="#__codelineno-6-49" id="__codelineno-6-49" name="__codelineno-6-49"></a>        return perplexity
<a href="#__codelineno-6-50" id="__codelineno-6-50" name="__codelineno-6-50"></a>
<a href="#__codelineno-6-51" id="__codelineno-6-51" name="__codelineno-6-51"></a>    def calculate_bleu(self, predictions: List[str], references: List[str]) -&gt; float:
<a href="#__codelineno-6-52" id="__codelineno-6-52" name="__codelineno-6-52"></a>        """Calculate BLEU score for text generation"""
<a href="#__codelineno-6-53" id="__codelineno-6-53" name="__codelineno-6-53"></a>        from collections import Counter
<a href="#__codelineno-6-54" id="__codelineno-6-54" name="__codelineno-6-54"></a>
<a href="#__codelineno-6-55" id="__codelineno-6-55" name="__codelineno-6-55"></a>        def get_ngrams(text: str, n: int) -&gt; List[str]:
<a href="#__codelineno-6-56" id="__codelineno-6-56" name="__codelineno-6-56"></a>            tokens = text.split()
<a href="#__codelineno-6-57" id="__codelineno-6-57" name="__codelineno-6-57"></a>            return [' '.join(tokens[i:i+n]) for i in range(len(tokens)-n+1)]
<a href="#__codelineno-6-58" id="__codelineno-6-58" name="__codelineno-6-58"></a>
<a href="#__codelineno-6-59" id="__codelineno-6-59" name="__codelineno-6-59"></a>        total_score = 0.0
<a href="#__codelineno-6-60" id="__codelineno-6-60" name="__codelineno-6-60"></a>
<a href="#__codelineno-6-61" id="__codelineno-6-61" name="__codelineno-6-61"></a>        for pred, ref in zip(predictions, references):
<a href="#__codelineno-6-62" id="__codelineno-6-62" name="__codelineno-6-62"></a>            pred_tokens = pred.split()
<a href="#__codelineno-6-63" id="__codelineno-6-63" name="__codelineno-6-63"></a>            ref_tokens = ref.split()
<a href="#__codelineno-6-64" id="__codelineno-6-64" name="__codelineno-6-64"></a>
<a href="#__codelineno-6-65" id="__codelineno-6-65" name="__codelineno-6-65"></a>            # Calculate precision for n-grams (n=1 to 4)
<a href="#__codelineno-6-66" id="__codelineno-6-66" name="__codelineno-6-66"></a>            precisions = []
<a href="#__codelineno-6-67" id="__codelineno-6-67" name="__codelineno-6-67"></a>
<a href="#__codelineno-6-68" id="__codelineno-6-68" name="__codelineno-6-68"></a>            for n in range(1, 5):
<a href="#__codelineno-6-69" id="__codelineno-6-69" name="__codelineno-6-69"></a>                pred_ngrams = get_ngrams(pred, n)
<a href="#__codelineno-6-70" id="__codelineno-6-70" name="__codelineno-6-70"></a>                ref_ngrams = get_ngrams(ref, n)
<a href="#__codelineno-6-71" id="__codelineno-6-71" name="__codelineno-6-71"></a>
<a href="#__codelineno-6-72" id="__codelineno-6-72" name="__codelineno-6-72"></a>                if not pred_ngrams:
<a href="#__codelineno-6-73" id="__codelineno-6-73" name="__codelineno-6-73"></a>                    precisions.append(0.0)
<a href="#__codelineno-6-74" id="__codelineno-6-74" name="__codelineno-6-74"></a>                    continue
<a href="#__codelineno-6-75" id="__codelineno-6-75" name="__codelineno-6-75"></a>
<a href="#__codelineno-6-76" id="__codelineno-6-76" name="__codelineno-6-76"></a>                pred_counter = Counter(pred_ngrams)
<a href="#__codelineno-6-77" id="__codelineno-6-77" name="__codelineno-6-77"></a>                ref_counter = Counter(ref_ngrams)
<a href="#__codelineno-6-78" id="__codelineno-6-78" name="__codelineno-6-78"></a>
<a href="#__codelineno-6-79" id="__codelineno-6-79" name="__codelineno-6-79"></a>                overlap = sum((pred_counter &amp; ref_counter).values())
<a href="#__codelineno-6-80" id="__codelineno-6-80" name="__codelineno-6-80"></a>                precision = overlap / len(pred_ngrams)
<a href="#__codelineno-6-81" id="__codelineno-6-81" name="__codelineno-6-81"></a>                precisions.append(precision)
<a href="#__codelineno-6-82" id="__codelineno-6-82" name="__codelineno-6-82"></a>
<a href="#__codelineno-6-83" id="__codelineno-6-83" name="__codelineno-6-83"></a>            # Geometric mean of precisions
<a href="#__codelineno-6-84" id="__codelineno-6-84" name="__codelineno-6-84"></a>            if all(p &gt; 0 for p in precisions):
<a href="#__codelineno-6-85" id="__codelineno-6-85" name="__codelineno-6-85"></a>                bleu = np.exp(np.mean(np.log(precisions)))
<a href="#__codelineno-6-86" id="__codelineno-6-86" name="__codelineno-6-86"></a>
<a href="#__codelineno-6-87" id="__codelineno-6-87" name="__codelineno-6-87"></a>                # Brevity penalty
<a href="#__codelineno-6-88" id="__codelineno-6-88" name="__codelineno-6-88"></a>                bp = min(1.0, np.exp(1 - len(ref_tokens) / len(pred_tokens))) if len(pred_tokens) &gt; 0 else 0
<a href="#__codelineno-6-89" id="__codelineno-6-89" name="__codelineno-6-89"></a>                bleu *= bp
<a href="#__codelineno-6-90" id="__codelineno-6-90" name="__codelineno-6-90"></a>            else:
<a href="#__codelineno-6-91" id="__codelineno-6-91" name="__codelineno-6-91"></a>                bleu = 0.0
<a href="#__codelineno-6-92" id="__codelineno-6-92" name="__codelineno-6-92"></a>
<a href="#__codelineno-6-93" id="__codelineno-6-93" name="__codelineno-6-93"></a>            total_score += bleu
<a href="#__codelineno-6-94" id="__codelineno-6-94" name="__codelineno-6-94"></a>
<a href="#__codelineno-6-95" id="__codelineno-6-95" name="__codelineno-6-95"></a>        return total_score / len(predictions) if predictions else 0.0
<a href="#__codelineno-6-96" id="__codelineno-6-96" name="__codelineno-6-96"></a>
<a href="#__codelineno-6-97" id="__codelineno-6-97" name="__codelineno-6-97"></a>    def calculate_rouge(self, predictions: List[str], references: List[str]) -&gt; Dict[str, float]:
<a href="#__codelineno-6-98" id="__codelineno-6-98" name="__codelineno-6-98"></a>        """Calculate ROUGE scores"""
<a href="#__codelineno-6-99" id="__codelineno-6-99" name="__codelineno-6-99"></a>        from collections import Counter
<a href="#__codelineno-6-100" id="__codelineno-6-100" name="__codelineno-6-100"></a>
<a href="#__codelineno-6-101" id="__codelineno-6-101" name="__codelineno-6-101"></a>        def rouge_n(pred: str, ref: str, n: int) -&gt; float:
<a href="#__codelineno-6-102" id="__codelineno-6-102" name="__codelineno-6-102"></a>            pred_grams = [' '.join(pred.split()[i:i+n]) for i in range(len(pred.split())-n+1)]
<a href="#__codelineno-6-103" id="__codelineno-6-103" name="__codelineno-6-103"></a>            ref_grams = [' '.join(ref.split()[i:i+n]) for i in range(len(ref.split())-n+1)]
<a href="#__codelineno-6-104" id="__codelineno-6-104" name="__codelineno-6-104"></a>
<a href="#__codelineno-6-105" id="__codelineno-6-105" name="__codelineno-6-105"></a>            if not ref_grams:
<a href="#__codelineno-6-106" id="__codelineno-6-106" name="__codelineno-6-106"></a>                return 0.0
<a href="#__codelineno-6-107" id="__codelineno-6-107" name="__codelineno-6-107"></a>
<a href="#__codelineno-6-108" id="__codelineno-6-108" name="__codelineno-6-108"></a>            overlap = len(set(pred_grams) &amp; set(ref_grams))
<a href="#__codelineno-6-109" id="__codelineno-6-109" name="__codelineno-6-109"></a>            return overlap / len(ref_grams)
<a href="#__codelineno-6-110" id="__codelineno-6-110" name="__codelineno-6-110"></a>
<a href="#__codelineno-6-111" id="__codelineno-6-111" name="__codelineno-6-111"></a>        rouge_scores = {'rouge_1': 0.0, 'rouge_2': 0.0, 'rouge_l': 0.0}
<a href="#__codelineno-6-112" id="__codelineno-6-112" name="__codelineno-6-112"></a>
<a href="#__codelineno-6-113" id="__codelineno-6-113" name="__codelineno-6-113"></a>        for pred, ref in zip(predictions, references):
<a href="#__codelineno-6-114" id="__codelineno-6-114" name="__codelineno-6-114"></a>            rouge_scores['rouge_1'] += rouge_n(pred, ref, 1)
<a href="#__codelineno-6-115" id="__codelineno-6-115" name="__codelineno-6-115"></a>            rouge_scores['rouge_2'] += rouge_n(pred, ref, 2)
<a href="#__codelineno-6-116" id="__codelineno-6-116" name="__codelineno-6-116"></a>
<a href="#__codelineno-6-117" id="__codelineno-6-117" name="__codelineno-6-117"></a>            # ROUGE-L (longest common subsequence)
<a href="#__codelineno-6-118" id="__codelineno-6-118" name="__codelineno-6-118"></a>            pred_words = pred.split()
<a href="#__codelineno-6-119" id="__codelineno-6-119" name="__codelineno-6-119"></a>            ref_words = ref.split()
<a href="#__codelineno-6-120" id="__codelineno-6-120" name="__codelineno-6-120"></a>
<a href="#__codelineno-6-121" id="__codelineno-6-121" name="__codelineno-6-121"></a>            # Simplified LCS calculation
<a href="#__codelineno-6-122" id="__codelineno-6-122" name="__codelineno-6-122"></a>            lcs_length = 0
<a href="#__codelineno-6-123" id="__codelineno-6-123" name="__codelineno-6-123"></a>            i = j = 0
<a href="#__codelineno-6-124" id="__codelineno-6-124" name="__codelineno-6-124"></a>            while i &lt; len(pred_words) and j &lt; len(ref_words):
<a href="#__codelineno-6-125" id="__codelineno-6-125" name="__codelineno-6-125"></a>                if pred_words[i] == ref_words[j]:
<a href="#__codelineno-6-126" id="__codelineno-6-126" name="__codelineno-6-126"></a>                    lcs_length += 1
<a href="#__codelineno-6-127" id="__codelineno-6-127" name="__codelineno-6-127"></a>                    i += 1
<a href="#__codelineno-6-128" id="__codelineno-6-128" name="__codelineno-6-128"></a>                j += 1
<a href="#__codelineno-6-129" id="__codelineno-6-129" name="__codelineno-6-129"></a>
<a href="#__codelineno-6-130" id="__codelineno-6-130" name="__codelineno-6-130"></a>            rouge_l = lcs_length / len(ref_words) if ref_words else 0.0
<a href="#__codelineno-6-131" id="__codelineno-6-131" name="__codelineno-6-131"></a>            rouge_scores['rouge_l'] += rouge_l
<a href="#__codelineno-6-132" id="__codelineno-6-132" name="__codelineno-6-132"></a>
<a href="#__codelineno-6-133" id="__codelineno-6-133" name="__codelineno-6-133"></a>        # Average scores
<a href="#__codelineno-6-134" id="__codelineno-6-134" name="__codelineno-6-134"></a>        for key in rouge_scores:
<a href="#__codelineno-6-135" id="__codelineno-6-135" name="__codelineno-6-135"></a>            rouge_scores[key] /= len(predictions) if predictions else 1
<a href="#__codelineno-6-136" id="__codelineno-6-136" name="__codelineno-6-136"></a>
<a href="#__codelineno-6-137" id="__codelineno-6-137" name="__codelineno-6-137"></a>        return rouge_scores
<a href="#__codelineno-6-138" id="__codelineno-6-138" name="__codelineno-6-138"></a>
<a href="#__codelineno-6-139" id="__codelineno-6-139" name="__codelineno-6-139"></a>    def calculate_semantic_similarity(self, predictions: List[str], references: List[str]) -&gt; float:
<a href="#__codelineno-6-140" id="__codelineno-6-140" name="__codelineno-6-140"></a>        """Calculate semantic similarity (simplified)"""
<a href="#__codelineno-6-141" id="__codelineno-6-141" name="__codelineno-6-141"></a>        # This would typically use sentence embeddings like BERT, SBERT, etc.
<a href="#__codelineno-6-142" id="__codelineno-6-142" name="__codelineno-6-142"></a>        # For now, we'll use word overlap as a proxy
<a href="#__codelineno-6-143" id="__codelineno-6-143" name="__codelineno-6-143"></a>
<a href="#__codelineno-6-144" id="__codelineno-6-144" name="__codelineno-6-144"></a>        total_similarity = 0.0
<a href="#__codelineno-6-145" id="__codelineno-6-145" name="__codelineno-6-145"></a>
<a href="#__codelineno-6-146" id="__codelineno-6-146" name="__codelineno-6-146"></a>        for pred, ref in zip(predictions, references):
<a href="#__codelineno-6-147" id="__codelineno-6-147" name="__codelineno-6-147"></a>            pred_words = set(pred.lower().split())
<a href="#__codelineno-6-148" id="__codelineno-6-148" name="__codelineno-6-148"></a>            ref_words = set(ref.lower().split())
<a href="#__codelineno-6-149" id="__codelineno-6-149" name="__codelineno-6-149"></a>
<a href="#__codelineno-6-150" id="__codelineno-6-150" name="__codelineno-6-150"></a>            if not ref_words:
<a href="#__codelineno-6-151" id="__codelineno-6-151" name="__codelineno-6-151"></a>                similarity = 0.0
<a href="#__codelineno-6-152" id="__codelineno-6-152" name="__codelineno-6-152"></a>            else:
<a href="#__codelineno-6-153" id="__codelineno-6-153" name="__codelineno-6-153"></a>                intersection = len(pred_words &amp; ref_words)
<a href="#__codelineno-6-154" id="__codelineno-6-154" name="__codelineno-6-154"></a>                union = len(pred_words | ref_words)
<a href="#__codelineno-6-155" id="__codelineno-6-155" name="__codelineno-6-155"></a>                similarity = intersection / union if union &gt; 0 else 0.0
<a href="#__codelineno-6-156" id="__codelineno-6-156" name="__codelineno-6-156"></a>
<a href="#__codelineno-6-157" id="__codelineno-6-157" name="__codelineno-6-157"></a>            total_similarity += similarity
<a href="#__codelineno-6-158" id="__codelineno-6-158" name="__codelineno-6-158"></a>
<a href="#__codelineno-6-159" id="__codelineno-6-159" name="__codelineno-6-159"></a>        return total_similarity / len(predictions) if predictions else 0.0
<a href="#__codelineno-6-160" id="__codelineno-6-160" name="__codelineno-6-160"></a>
<a href="#__codelineno-6-161" id="__codelineno-6-161" name="__codelineno-6-161"></a>    def calculate_task_specific_metrics(self, task_type: str, predictions: List[str], 
<a href="#__codelineno-6-162" id="__codelineno-6-162" name="__codelineno-6-162"></a>                                       ground_truth: List[str]) -&gt; Dict[str, float]:
<a href="#__codelineno-6-163" id="__codelineno-6-163" name="__codelineno-6-163"></a>        """Calculate task-specific evaluation metrics"""
<a href="#__codelineno-6-164" id="__codelineno-6-164" name="__codelineno-6-164"></a>        metrics = {}
<a href="#__codelineno-6-165" id="__codelineno-6-165" name="__codelineno-6-165"></a>
<a href="#__codelineno-6-166" id="__codelineno-6-166" name="__codelineno-6-166"></a>        if task_type == 'classification':
<a href="#__codelineno-6-167" id="__codelineno-6-167" name="__codelineno-6-167"></a>            # Classification metrics
<a href="#__codelineno-6-168" id="__codelineno-6-168" name="__codelineno-6-168"></a>            metrics['accuracy'] = self.calculate_accuracy(predictions, ground_truth)
<a href="#__codelineno-6-169" id="__codelineno-6-169" name="__codelineno-6-169"></a>
<a href="#__codelineno-6-170" id="__codelineno-6-170" name="__codelineno-6-170"></a>            # Precision, Recall, F1 (simplified for binary)
<a href="#__codelineno-6-171" id="__codelineno-6-171" name="__codelineno-6-171"></a>            if len(set(ground_truth)) == 2:
<a href="#__codelineno-6-172" id="__codelineno-6-172" name="__codelineno-6-172"></a>                tp = fp = tn = fn = 0
<a href="#__codelineno-6-173" id="__codelineno-6-173" name="__codelineno-6-173"></a>                for pred, true in zip(predictions, ground_truth):
<a href="#__codelineno-6-174" id="__codelineno-6-174" name="__codelineno-6-174"></a>                    if pred == true == ground_truth[0]:  # Positive class (first unique value)
<a href="#__codelineno-6-175" id="__codelineno-6-175" name="__codelineno-6-175"></a>                        tp += 1
<a href="#__codelineno-6-176" id="__codelineno-6-176" name="__codelineno-6-176"></a>                    elif pred == ground_truth[0] and true != ground_truth[0]:
<a href="#__codelineno-6-177" id="__codelineno-6-177" name="__codelineno-6-177"></a>                        fp += 1
<a href="#__codelineno-6-178" id="__codelineno-6-178" name="__codelineno-6-178"></a>                    elif pred != ground_truth[0] and true == ground_truth[0]:
<a href="#__codelineno-6-179" id="__codelineno-6-179" name="__codelineno-6-179"></a>                        fn += 1
<a href="#__codelineno-6-180" id="__codelineno-6-180" name="__codelineno-6-180"></a>                    else:
<a href="#__codelineno-6-181" id="__codelineno-6-181" name="__codelineno-6-181"></a>                        tn += 1
<a href="#__codelineno-6-182" id="__codelineno-6-182" name="__codelineno-6-182"></a>
<a href="#__codelineno-6-183" id="__codelineno-6-183" name="__codelineno-6-183"></a>                precision = tp / (tp + fp) if (tp + fp) &gt; 0 else 0.0
<a href="#__codelineno-6-184" id="__codelineno-6-184" name="__codelineno-6-184"></a>                recall = tp / (tp + fn) if (tp + fn) &gt; 0 else 0.0
<a href="#__codelineno-6-185" id="__codelineno-6-185" name="__codelineno-6-185"></a>                f1 = 2 * (precision * recall) / (precision + recall) if (precision + recall) &gt; 0 else 0.0
<a href="#__codelineno-6-186" id="__codelineno-6-186" name="__codelineno-6-186"></a>
<a href="#__codelineno-6-187" id="__codelineno-6-187" name="__codelineno-6-187"></a>                metrics.update({'precision': precision, 'recall': recall, 'f1': f1})
<a href="#__codelineno-6-188" id="__codelineno-6-188" name="__codelineno-6-188"></a>
<a href="#__codelineno-6-189" id="__codelineno-6-189" name="__codelineno-6-189"></a>        elif task_type == 'summarization':
<a href="#__codelineno-6-190" id="__codelineno-6-190" name="__codelineno-6-190"></a>            # Summarization-specific metrics
<a href="#__codelineno-6-191" id="__codelineno-6-191" name="__codelineno-6-191"></a>            rouge_scores = self.calculate_rouge(predictions, ground_truth)
<a href="#__codelineno-6-192" id="__codelineno-6-192" name="__codelineno-6-192"></a>            metrics.update(rouge_scores)
<a href="#__codelineno-6-193" id="__codelineno-6-193" name="__codelineno-6-193"></a>
<a href="#__codelineno-6-194" id="__codelineno-6-194" name="__codelineno-6-194"></a>            # Length ratio (summary should be shorter)
<a href="#__codelineno-6-195" id="__codelineno-6-195" name="__codelineno-6-195"></a>            avg_pred_len = np.mean([len(p.split()) for p in predictions])
<a href="#__codelineno-6-196" id="__codelineno-6-196" name="__codelineno-6-196"></a>            avg_ref_len = np.mean([len(r.split()) for r in ground_truth])
<a href="#__codelineno-6-197" id="__codelineno-6-197" name="__codelineno-6-197"></a>            metrics['compression_ratio'] = avg_pred_len / avg_ref_len if avg_ref_len &gt; 0 else 0.0
<a href="#__codelineno-6-198" id="__codelineno-6-198" name="__codelineno-6-198"></a>
<a href="#__codelineno-6-199" id="__codelineno-6-199" name="__codelineno-6-199"></a>        elif task_type == 'translation':
<a href="#__codelineno-6-200" id="__codelineno-6-200" name="__codelineno-6-200"></a>            # Translation-specific metrics
<a href="#__codelineno-6-201" id="__codelineno-6-201" name="__codelineno-6-201"></a>            bleu = self.calculate_bleu(predictions, ground_truth)
<a href="#__codelineno-6-202" id="__codelineno-6-202" name="__codelineno-6-202"></a>            metrics['bleu'] = bleu
<a href="#__codelineno-6-203" id="__codelineno-6-203" name="__codelineno-6-203"></a>
<a href="#__codelineno-6-204" id="__codelineno-6-204" name="__codelineno-6-204"></a>            # Length penalty
<a href="#__codelineno-6-205" id="__codelineno-6-205" name="__codelineno-6-205"></a>            length_penalty = 1.0 - abs(
<a href="#__codelineno-6-206" id="__codelineno-6-206" name="__codelineno-6-206"></a>                np.mean([len(p.split()) for p in predictions]) - 
<a href="#__codelineno-6-207" id="__codelineno-6-207" name="__codelineno-6-207"></a>                np.mean([len(r.split()) for r in ground_truth])
<a href="#__codelineno-6-208" id="__codelineno-6-208" name="__codelineno-6-208"></a>            ) / max(1, np.mean([len(r.split()) for r in ground_truth]))
<a href="#__codelineno-6-209" id="__codelineno-6-209" name="__codelineno-6-209"></a>            metrics['length_penalty'] = max(0.0, length_penalty)
<a href="#__codelineno-6-210" id="__codelineno-6-210" name="__codelineno-6-210"></a>
<a href="#__codelineno-6-211" id="__codelineno-6-211" name="__codelineno-6-211"></a>        return metrics
<a href="#__codelineno-6-212" id="__codelineno-6-212" name="__codelineno-6-212"></a>
<a href="#__codelineno-6-213" id="__codelineno-6-213" name="__codelineno-6-213"></a>    def evaluate_catastrophic_forgetting(self, model, original_tasks_data: List[Dict]) -&gt; Dict[str, float]:
<a href="#__codelineno-6-214" id="__codelineno-6-214" name="__codelineno-6-214"></a>        """Evaluate how much the model has forgotten from original training"""
<a href="#__codelineno-6-215" id="__codelineno-6-215" name="__codelineno-6-215"></a>        forgetting_metrics = {}
<a href="#__codelineno-6-216" id="__codelineno-6-216" name="__codelineno-6-216"></a>
<a href="#__codelineno-6-217" id="__codelineno-6-217" name="__codelineno-6-217"></a>        for task_data in original_tasks_data:
<a href="#__codelineno-6-218" id="__codelineno-6-218" name="__codelineno-6-218"></a>            task_name = task_data['task_name']
<a href="#__codelineno-6-219" id="__codelineno-6-219" name="__codelineno-6-219"></a>            test_inputs = task_data['test_inputs']
<a href="#__codelineno-6-220" id="__codelineno-6-220" name="__codelineno-6-220"></a>            expected_outputs = task_data['expected_outputs']
<a href="#__codelineno-6-221" id="__codelineno-6-221" name="__codelineno-6-221"></a>
<a href="#__codelineno-6-222" id="__codelineno-6-222" name="__codelineno-6-222"></a>            # Simulate model predictions on original tasks
<a href="#__codelineno-6-223" id="__codelineno-6-223" name="__codelineno-6-223"></a>            model_outputs = [f"Simulated output for {inp}" for inp in test_inputs]
<a href="#__codelineno-6-224" id="__codelineno-6-224" name="__codelineno-6-224"></a>
<a href="#__codelineno-6-225" id="__codelineno-6-225" name="__codelineno-6-225"></a>            # Calculate performance drop
<a href="#__codelineno-6-226" id="__codelineno-6-226" name="__codelineno-6-226"></a>            current_accuracy = self.calculate_accuracy(model_outputs, expected_outputs)
<a href="#__codelineno-6-227" id="__codelineno-6-227" name="__codelineno-6-227"></a>            original_accuracy = task_data.get('original_accuracy', 1.0)
<a href="#__codelineno-6-228" id="__codelineno-6-228" name="__codelineno-6-228"></a>
<a href="#__codelineno-6-229" id="__codelineno-6-229" name="__codelineno-6-229"></a>            forgetting_score = max(0.0, original_accuracy - current_accuracy)
<a href="#__codelineno-6-230" id="__codelineno-6-230" name="__codelineno-6-230"></a>            forgetting_metrics[f'{task_name}_forgetting'] = forgetting_score
<a href="#__codelineno-6-231" id="__codelineno-6-231" name="__codelineno-6-231"></a>
<a href="#__codelineno-6-232" id="__codelineno-6-232" name="__codelineno-6-232"></a>        # Overall forgetting score
<a href="#__codelineno-6-233" id="__codelineno-6-233" name="__codelineno-6-233"></a>        forgetting_metrics['avg_forgetting'] = np.mean(list(forgetting_metrics.values()))
<a href="#__codelineno-6-234" id="__codelineno-6-234" name="__codelineno-6-234"></a>
<a href="#__codelineno-6-235" id="__codelineno-6-235" name="__codelineno-6-235"></a>        return forgetting_metrics
<a href="#__codelineno-6-236" id="__codelineno-6-236" name="__codelineno-6-236"></a>
<a href="#__codelineno-6-237" id="__codelineno-6-237" name="__codelineno-6-237"></a>    def comprehensive_evaluation(self, model_outputs: List[str], ground_truth: List[str], 
<a href="#__codelineno-6-238" id="__codelineno-6-238" name="__codelineno-6-238"></a>                                task_type: str = 'general') -&gt; Dict[str, float]:
<a href="#__codelineno-6-239" id="__codelineno-6-239" name="__codelineno-6-239"></a>        """Run comprehensive evaluation"""
<a href="#__codelineno-6-240" id="__codelineno-6-240" name="__codelineno-6-240"></a>        results = {}
<a href="#__codelineno-6-241" id="__codelineno-6-241" name="__codelineno-6-241"></a>
<a href="#__codelineno-6-242" id="__codelineno-6-242" name="__codelineno-6-242"></a>        # Basic metrics
<a href="#__codelineno-6-243" id="__codelineno-6-243" name="__codelineno-6-243"></a>        results['accuracy'] = self.calculate_accuracy(model_outputs, ground_truth)
<a href="#__codelineno-6-244" id="__codelineno-6-244" name="__codelineno-6-244"></a>        results['semantic_similarity'] = self.calculate_semantic_similarity(model_outputs, ground_truth)
<a href="#__codelineno-6-245" id="__codelineno-6-245" name="__codelineno-6-245"></a>
<a href="#__codelineno-6-246" id="__codelineno-6-246" name="__codelineno-6-246"></a>        # Task-specific metrics
<a href="#__codelineno-6-247" id="__codelineno-6-247" name="__codelineno-6-247"></a>        task_metrics = self.calculate_task_specific_metrics(task_type, model_outputs, ground_truth)
<a href="#__codelineno-6-248" id="__codelineno-6-248" name="__codelineno-6-248"></a>        results.update(task_metrics)
<a href="#__codelineno-6-249" id="__codelineno-6-249" name="__codelineno-6-249"></a>
<a href="#__codelineno-6-250" id="__codelineno-6-250" name="__codelineno-6-250"></a>        # Text quality metrics
<a href="#__codelineno-6-251" id="__codelineno-6-251" name="__codelineno-6-251"></a>        if task_type in ['generation', 'summarization', 'translation']:
<a href="#__codelineno-6-252" id="__codelineno-6-252" name="__codelineno-6-252"></a>            results['bleu'] = self.calculate_bleu(model_outputs, ground_truth)
<a href="#__codelineno-6-253" id="__codelineno-6-253" name="__codelineno-6-253"></a>            rouge_scores = self.calculate_rouge(model_outputs, ground_truth)
<a href="#__codelineno-6-254" id="__codelineno-6-254" name="__codelineno-6-254"></a>            results.update(rouge_scores)
<a href="#__codelineno-6-255" id="__codelineno-6-255" name="__codelineno-6-255"></a>
<a href="#__codelineno-6-256" id="__codelineno-6-256" name="__codelineno-6-256"></a>        return results
<a href="#__codelineno-6-257" id="__codelineno-6-257" name="__codelineno-6-257"></a>
<a href="#__codelineno-6-258" id="__codelineno-6-258" name="__codelineno-6-258"></a># Example comprehensive evaluation
<a href="#__codelineno-6-259" id="__codelineno-6-259" name="__codelineno-6-259"></a>evaluator = FineTuningEvaluator()
<a href="#__codelineno-6-260" id="__codelineno-6-260" name="__codelineno-6-260"></a>
<a href="#__codelineno-6-261" id="__codelineno-6-261" name="__codelineno-6-261"></a># Simulate evaluation data
<a href="#__codelineno-6-262" id="__codelineno-6-262" name="__codelineno-6-262"></a>predictions = [
<a href="#__codelineno-6-263" id="__codelineno-6-263" name="__codelineno-6-263"></a>    "The model correctly identified the sentiment as positive.",
<a href="#__codelineno-6-264" id="__codelineno-6-264" name="__codelineno-6-264"></a>    "This is a well-written summary of the main points.",
<a href="#__codelineno-6-265" id="__codelineno-6-265" name="__codelineno-6-265"></a>    "The translation captures the meaning accurately."
<a href="#__codelineno-6-266" id="__codelineno-6-266" name="__codelineno-6-266"></a>]
<a href="#__codelineno-6-267" id="__codelineno-6-267" name="__codelineno-6-267"></a>
<a href="#__codelineno-6-268" id="__codelineno-6-268" name="__codelineno-6-268"></a>ground_truth = [
<a href="#__codelineno-6-269" id="__codelineno-6-269" name="__codelineno-6-269"></a>    "The model successfully classified the sentiment as positive.",
<a href="#__codelineno-6-270" id="__codelineno-6-270" name="__codelineno-6-270"></a>    "This summary effectively covers the key points.",
<a href="#__codelineno-6-271" id="__codelineno-6-271" name="__codelineno-6-271"></a>    "The translation accurately conveys the original meaning."
<a href="#__codelineno-6-272" id="__codelineno-6-272" name="__codelineno-6-272"></a>]
<a href="#__codelineno-6-273" id="__codelineno-6-273" name="__codelineno-6-273"></a>
<a href="#__codelineno-6-274" id="__codelineno-6-274" name="__codelineno-6-274"></a># Run evaluation
<a href="#__codelineno-6-275" id="__codelineno-6-275" name="__codelineno-6-275"></a>results = evaluator.comprehensive_evaluation(predictions, ground_truth, task_type='general')
<a href="#__codelineno-6-276" id="__codelineno-6-276" name="__codelineno-6-276"></a>
<a href="#__codelineno-6-277" id="__codelineno-6-277" name="__codelineno-6-277"></a>print("Fine-tuning Evaluation Results:")
<a href="#__codelineno-6-278" id="__codelineno-6-278" name="__codelineno-6-278"></a>for metric, score in results.items():
<a href="#__codelineno-6-279" id="__codelineno-6-279" name="__codelineno-6-279"></a>    print(f"{metric}: {score:.3f}")
</code></pre></div></p>
<h2 id="fine-tuning-best-practices-checklist">✅ Fine-tuning Best Practices Checklist</h2>
<p>Ensure you follow these best practices:</p>
<ol>
<li><strong>Data Quality</strong>: Clean, relevant, diverse training data</li>
<li><strong>Parameter Efficiency</strong>: Use PEFT methods when possible</li>
<li><strong>Regularization</strong>: Prevent overfitting with dropout, weight decay</li>
<li><strong>Learning Rate</strong>: Use appropriate schedules and warmup</li>
<li><strong>Evaluation</strong>: Multiple metrics and test sets</li>
<li><strong>Safety</strong>: Domain-specific safety checks</li>
<li><strong>Monitoring</strong>: Track catastrophic forgetting</li>
<li><strong>Documentation</strong>: Record experiments and results</li>
</ol>
<h2 id="next-steps">🚀 Next Steps</h2>
<p>Continue with:</p>
<ol>
<li><strong><a href="evaluation.md">Model Evaluation</a></strong> - Systematic model assessment</li>
<li><strong><a href="../../agents/architecture/">Building LLM Agents</a></strong> - Apply fine-tuned models to agents</li>
<li><strong><a href="../../security/fundamentals/">Security &amp; Safety</a></strong> - Secure deployment practices</li>
</ol>
<hr/>
<p><em>Fine-tuning enables you to create specialized models for specific domains and tasks. Master these techniques to build more effective and reliable LLM-powered agent systems.</em></p>
</article>
</div>
<script>var tabs=__md_get("__tabs");if(Array.isArray(tabs))e:for(var set of document.querySelectorAll(".tabbed-set")){var labels=set.querySelector(".tabbed-labels");for(var tab of tabs)for(var label of labels.getElementsByTagName("label"))if(label.innerText.trim()===tab){var input=document.getElementById(label.htmlFor);input.checked=!0;continue e}}</script>
<script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script>
</div>
<button class="md-top md-icon" data-md-component="top" hidden="" type="button">
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M13 20h-2V8l-5.5 5.5-1.42-1.42L12 4.16l7.92 7.92-1.42 1.42L13 8z"></path></svg>
  Back to top
</button>
</main>
<footer class="md-footer">
<div class="md-footer-meta md-typeset">
<div class="md-footer-meta__inner md-grid">
<div class="md-copyright">
<div class="md-copyright__highlight">
      Copyright © 2024 LLM-MCP Learning Path Contributors
    </div>
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" rel="noopener" target="_blank">
      Material for MkDocs
    </a>
</div>
</div>
</div>
</footer>
</div>
<div class="md-dialog" data-md-component="dialog">
<div class="md-dialog__inner md-typeset"></div>
</div>
<script id="__config" type="application/json">{"base": "../../..", "features": ["navigation.tabs", "navigation.sections", "navigation.expand", "navigation.path", "navigation.top", "search.suggest", "search.highlight", "content.tabs.link", "content.code.annotation", "content.code.copy"], "search": "../../../assets/javascripts/workers/search.973d3a69.min.js", "tags": null, "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}, "version": null}</script>
<script src="../../../assets/javascripts/bundle.f55a23d4.min.js"></script>
<script src="../../../javascripts/mathjax.js"></script>
<script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
<script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
</body>
</html>