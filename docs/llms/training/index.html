
<!DOCTYPE html>

<html class="no-js" lang="en">
<head>
<meta charset="utf-8"/>
<meta content="width=device-width,initial-scale=1" name="viewport"/>
<meta content="A comprehensive learning module for understanding, building, securing, and measuring Large Language Model agents and Multi-Agent Collaboration Platforms" name="description"/>
<meta content="Learning Path Contributors" name="author"/>
<link href="https://example.com/docs/llms/training/" rel="canonical"/>
<link href="../../../assets/images/favicon.png" rel="icon"/>
<meta content="mkdocs-1.6.1, mkdocs-material-9.6.20" name="generator"/>
<title>LLM Training Process: From Raw Text to Language Understanding - LLM and Multi-Agent Collaboration Platforms - Learning Path</title>
<link href="../../../assets/stylesheets/main.e53b48f4.min.css" rel="stylesheet"/>
<link href="../../../assets/stylesheets/palette.06af60db.min.css" rel="stylesheet"/>
<link crossorigin="" href="https://fonts.gstatic.com" rel="preconnect"/>
<link href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&amp;display=fallback" rel="stylesheet"/>
<style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
<link href="../../../stylesheets/extra.css" rel="stylesheet"/>
<script>__md_scope=new URL("../../..",location),__md_hash=e=>[...e].reduce(((e,_)=>(e<<5)-e+_.charCodeAt(0)),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
</head>
<body data-md-color-accent="indigo" data-md-color-primary="indigo" data-md-color-scheme="default" dir="ltr">
<input autocomplete="off" class="md-toggle" data-md-toggle="drawer" id="__drawer" type="checkbox"/>
<input autocomplete="off" class="md-toggle" data-md-toggle="search" id="__search" type="checkbox"/>
<label class="md-overlay" for="__drawer"></label>
<div data-md-component="skip">
<a class="md-skip" href="#llm-training-process-from-raw-text-to-language-understanding">
          Skip to content
        </a>
</div>
<div data-md-component="announce">
</div>
<header class="md-header" data-md-component="header">
<nav aria-label="Header" class="md-header__inner md-grid">
<a aria-label="LLM and Multi-Agent Collaboration Platforms - Learning Path" class="md-header__button md-logo" data-md-component="logo" href="../../.." title="LLM and Multi-Agent Collaboration Platforms - Learning Path">
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54"></path></svg>
</a>
<label class="md-header__button md-icon" for="__drawer">
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M3 6h18v2H3zm0 5h18v2H3zm0 5h18v2H3z"></path></svg>
</label>
<div class="md-header__title" data-md-component="header-title">
<div class="md-header__ellipsis">
<div class="md-header__topic">
<span class="md-ellipsis">
            LLM and Multi-Agent Collaboration Platforms - Learning Path
          </span>
</div>
<div class="md-header__topic" data-md-component="header-topic">
<span class="md-ellipsis">
            
              LLM Training Process: From Raw Text to Language Understanding
            
          </span>
</div>
</div>
</div>
<form class="md-header__option" data-md-component="palette">
<input aria-label="Switch to dark mode" class="md-option" data-md-color-accent="indigo" data-md-color-media="" data-md-color-primary="indigo" data-md-color-scheme="default" id="__palette_0" name="__palette" type="radio"/>
<label class="md-header__button md-icon" for="__palette_1" hidden="" title="Switch to dark mode">
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M12 8a4 4 0 0 0-4 4 4 4 0 0 0 4 4 4 4 0 0 0 4-4 4 4 0 0 0-4-4m0 10a6 6 0 0 1-6-6 6 6 0 0 1 6-6 6 6 0 0 1 6 6 6 6 0 0 1-6 6m8-9.31V4h-4.69L12 .69 8.69 4H4v4.69L.69 12 4 15.31V20h4.69L12 23.31 15.31 20H20v-4.69L23.31 12z"></path></svg>
</label>
<input aria-label="Switch to light mode" class="md-option" data-md-color-accent="indigo" data-md-color-media="" data-md-color-primary="indigo" data-md-color-scheme="slate" id="__palette_1" name="__palette" type="radio"/>
<label class="md-header__button md-icon" for="__palette_0" hidden="" title="Switch to light mode">
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M12 18c-.89 0-1.74-.2-2.5-.55C11.56 16.5 13 14.42 13 12s-1.44-4.5-3.5-5.45C10.26 6.2 11.11 6 12 6a6 6 0 0 1 6 6 6 6 0 0 1-6 6m8-9.31V4h-4.69L12 .69 8.69 4H4v4.69L.69 12 4 15.31V20h4.69L12 23.31 15.31 20H20v-4.69L23.31 12z"></path></svg>
</label>
</form>
<script>var palette=__md_get("__palette");if(palette&&palette.color){if("(prefers-color-scheme)"===palette.color.media){var media=matchMedia("(prefers-color-scheme: light)"),input=document.querySelector(media.matches?"[data-md-color-media='(prefers-color-scheme: light)']":"[data-md-color-media='(prefers-color-scheme: dark)']");palette.color.media=input.getAttribute("data-md-color-media"),palette.color.scheme=input.getAttribute("data-md-color-scheme"),palette.color.primary=input.getAttribute("data-md-color-primary"),palette.color.accent=input.getAttribute("data-md-color-accent")}for(var[key,value]of Object.entries(palette.color))document.body.setAttribute("data-md-color-"+key,value)}</script>
<label class="md-header__button md-icon" for="__search">
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"></path></svg>
</label>
<div class="md-search" data-md-component="search" role="dialog">
<label class="md-search__overlay" for="__search"></label>
<div class="md-search__inner" role="search">
<form class="md-search__form" name="search">
<input aria-label="Search" autocapitalize="off" autocomplete="off" autocorrect="off" class="md-search__input" data-md-component="search-query" name="query" placeholder="Search" required="" spellcheck="false" type="text"/>
<label class="md-search__icon md-icon" for="__search">
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"></path></svg>
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"></path></svg>
</label>
<nav aria-label="Search" class="md-search__options">
<button aria-label="Clear" class="md-search__icon md-icon" tabindex="-1" title="Clear" type="reset">
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"></path></svg>
</button>
</nav>
<div class="md-search__suggest" data-md-component="search-suggest"></div>
</form>
<div class="md-search__output">
<div class="md-search__scrollwrap" data-md-scrollfix="" tabindex="0">
<div class="md-search-result" data-md-component="search-result">
<div class="md-search-result__meta">
            Initializing search
          </div>
<ol class="md-search-result__list" role="presentation"></ol>
</div>
</div>
</div>
</div>
</div>
<div class="md-header__source">
<a class="md-source" data-md-component="source" href="https://github.com/example/llm-mcp-learning-path" title="Go to repository">
<div class="md-source__icon md-icon">
<svg viewbox="0 0 448 512" xmlns="http://www.w3.org/2000/svg"><!--! Font Awesome Free 7.0.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path d="M439.6 236.1 244 40.5c-5.4-5.5-12.8-8.5-20.4-8.5s-15 3-20.4 8.4L162.5 81l51.5 51.5c27.1-9.1 52.7 16.8 43.4 43.7l49.7 49.7c34.2-11.8 61.2 31 35.5 56.7-26.5 26.5-70.2-2.9-56-37.3L240.3 199v121.9c25.3 12.5 22.3 41.8 9.1 55-6.4 6.4-15.2 10.1-24.3 10.1s-17.8-3.6-24.3-10.1c-17.6-17.6-11.1-46.9 11.2-56v-123c-20.8-8.5-24.6-30.7-18.6-45L142.6 101 8.5 235.1C3 240.6 0 247.9 0 255.5s3 15 8.5 20.4l195.6 195.7c5.4 5.4 12.7 8.4 20.4 8.4s15-3 20.4-8.4l194.7-194.7c5.4-5.4 8.4-12.8 8.4-20.4s-3-15-8.4-20.4"></path></svg>
</div>
<div class="md-source__repository">
    LLM-MCP-Learning-Path
  </div>
</a>
</div>
</nav>
</header>
<div class="md-container" data-md-component="container">
<nav aria-label="Tabs" class="md-tabs" data-md-component="tabs">
<div class="md-grid">
<ul class="md-tabs__list">
<li class="md-tabs__item">
<a class="md-tabs__link" href="../../../index.md">
        
  
  
    
  
  Home

      </a>
</li>
<li class="md-tabs__item">
<a class="md-tabs__link" href="../../../introduction/overview.md">
          
  
  
  Introduction

        </a>
</li>
<li class="md-tabs__item">
<a class="md-tabs__link" href="../../../foundations/ai-ml-fundamentals.md">
          
  
  
  Foundational Knowledge

        </a>
</li>
<li class="md-tabs__item">
<a class="md-tabs__link" href="../../../llms/architecture.md">
          
  
  
  Understanding LLMs

        </a>
</li>
<li class="md-tabs__item">
<a class="md-tabs__link" href="../../../agents/architecture.md">
          
  
  
  Building LLM Agents

        </a>
</li>
<li class="md-tabs__item">
<a class="md-tabs__link" href="../../../security/fundamentals.md">
          
  
  
  Security &amp; Safety

        </a>
</li>
<li class="md-tabs__item">
<a class="md-tabs__link" href="../../../performance/metrics.md">
          
  
  
  Performance Measurement

        </a>
</li>
<li class="md-tabs__item">
<a class="md-tabs__link" href="../../../mcp/fundamentals.md">
          
  
  
  Multi-Agent Platforms

        </a>
</li>
<li class="md-tabs__item">
<a class="md-tabs__link" href="../../../mcp-llm-connectivity/index.md">
          
  
  
  MCP-LLM Connectivity Patterns

        </a>
</li>
<li class="md-tabs__item">
<a class="md-tabs__link" href="../../../resources/learning.md">
          
  
  
  Resources

        </a>
</li>
<li class="md-tabs__item">
<a class="md-tabs__link" href="../../../capstone/overview.md">
          
  
  
  Capstone Project

        </a>
</li>
</ul>
</div>
</nav>
<main class="md-main" data-md-component="main">
<div class="md-main__inner md-grid">
<div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation">
<div class="md-sidebar__scrollwrap">
<div class="md-sidebar__inner">
<nav aria-label="Navigation" class="md-nav md-nav--primary md-nav--lifted" data-md-level="0">
<label class="md-nav__title" for="__drawer">
<a aria-label="LLM and Multi-Agent Collaboration Platforms - Learning Path" class="md-nav__button md-logo" data-md-component="logo" href="../../.." title="LLM and Multi-Agent Collaboration Platforms - Learning Path">
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54"></path></svg>
</a>
    LLM and Multi-Agent Collaboration Platforms - Learning Path
  </label>
<div class="md-nav__source">
<a class="md-source" data-md-component="source" href="https://github.com/example/llm-mcp-learning-path" title="Go to repository">
<div class="md-source__icon md-icon">
<svg viewbox="0 0 448 512" xmlns="http://www.w3.org/2000/svg"><!--! Font Awesome Free 7.0.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path d="M439.6 236.1 244 40.5c-5.4-5.5-12.8-8.5-20.4-8.5s-15 3-20.4 8.4L162.5 81l51.5 51.5c27.1-9.1 52.7 16.8 43.4 43.7l49.7 49.7c34.2-11.8 61.2 31 35.5 56.7-26.5 26.5-70.2-2.9-56-37.3L240.3 199v121.9c25.3 12.5 22.3 41.8 9.1 55-6.4 6.4-15.2 10.1-24.3 10.1s-17.8-3.6-24.3-10.1c-17.6-17.6-11.1-46.9 11.2-56v-123c-20.8-8.5-24.6-30.7-18.6-45L142.6 101 8.5 235.1C3 240.6 0 247.9 0 255.5s3 15 8.5 20.4l195.6 195.7c5.4 5.4 12.7 8.4 20.4 8.4s15-3 20.4-8.4l194.7-194.7c5.4-5.4 8.4-12.8 8.4-20.4s-3-15-8.4-20.4"></path></svg>
</div>
<div class="md-source__repository">
    LLM-MCP-Learning-Path
  </div>
</a>
</div>
<ul class="md-nav__list" data-md-scrollfix="">
<li class="md-nav__item">
<a class="md-nav__link" href="../../../index.md">
<span class="md-ellipsis">
    Home
    
  </span>
</a>
</li>
<li class="md-nav__item md-nav__item--nested">
<input class="md-nav__toggle md-toggle md-toggle--indeterminate" id="__nav_2" type="checkbox"/>
<label class="md-nav__link" for="__nav_2" id="__nav_2_label" tabindex="0">
<span class="md-ellipsis">
    Introduction
    
  </span>
<span class="md-nav__icon md-icon"></span>
</label>
<nav aria-expanded="false" aria-labelledby="__nav_2_label" class="md-nav" data-md-level="1">
<label class="md-nav__title" for="__nav_2">
<span class="md-nav__icon md-icon"></span>
            Introduction
          </label>
<ul class="md-nav__list" data-md-scrollfix="">
<li class="md-nav__item">
<a class="md-nav__link" href="../../../introduction/overview.md">
<span class="md-ellipsis">
    Overview
    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../../introduction/applications.md">
<span class="md-ellipsis">
    Applications
    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../../introduction/prerequisites.md">
<span class="md-ellipsis">
    Prerequisites
    
  </span>
</a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item md-nav__item--nested">
<input class="md-nav__toggle md-toggle md-toggle--indeterminate" id="__nav_3" type="checkbox"/>
<label class="md-nav__link" for="__nav_3" id="__nav_3_label" tabindex="0">
<span class="md-ellipsis">
    Foundational Knowledge
    
  </span>
<span class="md-nav__icon md-icon"></span>
</label>
<nav aria-expanded="false" aria-labelledby="__nav_3_label" class="md-nav" data-md-level="1">
<label class="md-nav__title" for="__nav_3">
<span class="md-nav__icon md-icon"></span>
            Foundational Knowledge
          </label>
<ul class="md-nav__list" data-md-scrollfix="">
<li class="md-nav__item">
<a class="md-nav__link" href="../../../foundations/ai-ml-fundamentals.md">
<span class="md-ellipsis">
    AI/ML Fundamentals
    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../../foundations/mathematics.md">
<span class="md-ellipsis">
    Mathematics for AI
    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../../foundations/programming.md">
<span class="md-ellipsis">
    Programming Essentials
    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../../foundations/deep-learning.md">
<span class="md-ellipsis">
    Deep Learning Basics
    
  </span>
</a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item md-nav__item--nested">
<input class="md-nav__toggle md-toggle md-toggle--indeterminate" id="__nav_4" type="checkbox"/>
<label class="md-nav__link" for="__nav_4" id="__nav_4_label" tabindex="0">
<span class="md-ellipsis">
    Understanding LLMs
    
  </span>
<span class="md-nav__icon md-icon"></span>
</label>
<nav aria-expanded="false" aria-labelledby="__nav_4_label" class="md-nav" data-md-level="1">
<label class="md-nav__title" for="__nav_4">
<span class="md-nav__icon md-icon"></span>
            Understanding LLMs
          </label>
<ul class="md-nav__list" data-md-scrollfix="">
<li class="md-nav__item">
<a class="md-nav__link" href="../../../llms/architecture.md">
<span class="md-ellipsis">
    LLM Architecture
    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../../llms/training.md">
<span class="md-ellipsis">
    Training Process
    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../../llms/fine-tuning.md">
<span class="md-ellipsis">
    Fine-tuning &amp; Adaptation
    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../../llms/prompt-engineering.md">
<span class="md-ellipsis">
    Prompt Engineering
    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../../llms/evaluation.md">
<span class="md-ellipsis">
    Model Evaluation
    
  </span>
</a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item md-nav__item--nested">
<input class="md-nav__toggle md-toggle md-toggle--indeterminate" id="__nav_5" type="checkbox"/>
<label class="md-nav__link" for="__nav_5" id="__nav_5_label" tabindex="0">
<span class="md-ellipsis">
    Building LLM Agents
    
  </span>
<span class="md-nav__icon md-icon"></span>
</label>
<nav aria-expanded="false" aria-labelledby="__nav_5_label" class="md-nav" data-md-level="1">
<label class="md-nav__title" for="__nav_5">
<span class="md-nav__icon md-icon"></span>
            Building LLM Agents
          </label>
<ul class="md-nav__list" data-md-scrollfix="">
<li class="md-nav__item">
<a class="md-nav__link" href="../../../agents/architecture.md">
<span class="md-ellipsis">
    Agent Architecture
    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../../agents/planning.md">
<span class="md-ellipsis">
    Planning &amp; Reasoning
    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../../agents/tools.md">
<span class="md-ellipsis">
    Tool Integration
    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../../agents/memory.md">
<span class="md-ellipsis">
    Memory Systems
    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../../agents/deployment.md">
<span class="md-ellipsis">
    Deployment Strategies
    
  </span>
</a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item md-nav__item--nested">
<input class="md-nav__toggle md-toggle md-toggle--indeterminate" id="__nav_6" type="checkbox"/>
<label class="md-nav__link" for="__nav_6" id="__nav_6_label" tabindex="0">
<span class="md-ellipsis">
    Security &amp; Safety
    
  </span>
<span class="md-nav__icon md-icon"></span>
</label>
<nav aria-expanded="false" aria-labelledby="__nav_6_label" class="md-nav" data-md-level="1">
<label class="md-nav__title" for="__nav_6">
<span class="md-nav__icon md-icon"></span>
            Security &amp; Safety
          </label>
<ul class="md-nav__list" data-md-scrollfix="">
<li class="md-nav__item">
<a class="md-nav__link" href="../../../security/fundamentals.md">
<span class="md-ellipsis">
    Security Fundamentals
    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../../security/vulnerabilities.md">
<span class="md-ellipsis">
    Common Vulnerabilities
    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../../security/alignment.md">
<span class="md-ellipsis">
    Safety Alignment
    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../../security/monitoring.md">
<span class="md-ellipsis">
    Monitoring &amp; Detection
    
  </span>
</a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item md-nav__item--nested">
<input class="md-nav__toggle md-toggle md-toggle--indeterminate" id="__nav_7" type="checkbox"/>
<label class="md-nav__link" for="__nav_7" id="__nav_7_label" tabindex="0">
<span class="md-ellipsis">
    Performance Measurement
    
  </span>
<span class="md-nav__icon md-icon"></span>
</label>
<nav aria-expanded="false" aria-labelledby="__nav_7_label" class="md-nav" data-md-level="1">
<label class="md-nav__title" for="__nav_7">
<span class="md-nav__icon md-icon"></span>
            Performance Measurement
          </label>
<ul class="md-nav__list" data-md-scrollfix="">
<li class="md-nav__item">
<a class="md-nav__link" href="../../../performance/metrics.md">
<span class="md-ellipsis">
    Evaluation Metrics
    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../../performance/benchmarking.md">
<span class="md-ellipsis">
    Benchmarking
    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../../performance/monitoring.md">
<span class="md-ellipsis">
    Monitoring Systems
    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../../performance/optimization.md">
<span class="md-ellipsis">
    Optimization Techniques
    
  </span>
</a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item md-nav__item--nested">
<input class="md-nav__toggle md-toggle md-toggle--indeterminate" id="__nav_8" type="checkbox"/>
<label class="md-nav__link" for="__nav_8" id="__nav_8_label" tabindex="0">
<span class="md-ellipsis">
    Multi-Agent Platforms
    
  </span>
<span class="md-nav__icon md-icon"></span>
</label>
<nav aria-expanded="false" aria-labelledby="__nav_8_label" class="md-nav" data-md-level="1">
<label class="md-nav__title" for="__nav_8">
<span class="md-nav__icon md-icon"></span>
            Multi-Agent Platforms
          </label>
<ul class="md-nav__list" data-md-scrollfix="">
<li class="md-nav__item">
<a class="md-nav__link" href="../../../mcp/fundamentals.md">
<span class="md-ellipsis">
    MCP Fundamentals
    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../../mcp/communication.md">
<span class="md-ellipsis">
    Agent Communication
    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../../mcp/coordination.md">
<span class="md-ellipsis">
    Coordination Strategies
    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../../mcp/frameworks.md">
<span class="md-ellipsis">
    Frameworks &amp; Tools
    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../../mcp/scaling.md">
<span class="md-ellipsis">
    Scaling Considerations
    
  </span>
</a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item md-nav__item--nested">
<input class="md-nav__toggle md-toggle md-toggle--indeterminate" id="__nav_9" type="checkbox"/>
<label class="md-nav__link" for="__nav_9" id="__nav_9_label" tabindex="0">
<span class="md-ellipsis">
    MCP-LLM Connectivity Patterns
    
  </span>
<span class="md-nav__icon md-icon"></span>
</label>
<nav aria-expanded="false" aria-labelledby="__nav_9_label" class="md-nav" data-md-level="1">
<label class="md-nav__title" for="__nav_9">
<span class="md-nav__icon md-icon"></span>
            MCP-LLM Connectivity Patterns
          </label>
<ul class="md-nav__list" data-md-scrollfix="">
<li class="md-nav__item">
<a class="md-nav__link" href="../../../mcp-llm-connectivity/index.md">
<span class="md-ellipsis">
    Overview
    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../../mcp-llm-connectivity/basic-flow.md">
<span class="md-ellipsis">
    Basic Communication Flow
    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../../mcp-llm-connectivity/tool-integration.md">
<span class="md-ellipsis">
    Tool Integration
    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../../mcp-llm-connectivity/multi-agent.md">
<span class="md-ellipsis">
    Multi-Agent Systems
    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../../mcp-llm-connectivity/enterprise-architecture.md">
<span class="md-ellipsis">
    Enterprise Architecture
    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../../mcp-llm-connectivity/real-time-streaming.md">
<span class="md-ellipsis">
    Real-Time Streaming
    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../../mcp-llm-connectivity/security-patterns.md">
<span class="md-ellipsis">
    Security Patterns
    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../../mcp-llm-connectivity/scaling-patterns.md">
<span class="md-ellipsis">
    Scaling Patterns
    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../../mcp-llm-connectivity/data-flow.md">
<span class="md-ellipsis">
    Data Flow Patterns
    
  </span>
</a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item md-nav__item--nested">
<input class="md-nav__toggle md-toggle md-toggle--indeterminate" id="__nav_10" type="checkbox"/>
<label class="md-nav__link" for="__nav_10" id="__nav_10_label" tabindex="0">
<span class="md-ellipsis">
    Resources
    
  </span>
<span class="md-nav__icon md-icon"></span>
</label>
<nav aria-expanded="false" aria-labelledby="__nav_10_label" class="md-nav" data-md-level="1">
<label class="md-nav__title" for="__nav_10">
<span class="md-nav__icon md-icon"></span>
            Resources
          </label>
<ul class="md-nav__list" data-md-scrollfix="">
<li class="md-nav__item">
<a class="md-nav__link" href="../../../resources/learning.md">
<span class="md-ellipsis">
    Learning Resources
    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../../resources/tools.md">
<span class="md-ellipsis">
    Tools &amp; Libraries
    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../../resources/communities.md">
<span class="md-ellipsis">
    Communities
    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../../resources/updates.md">
<span class="md-ellipsis">
    Staying Updated
    
  </span>
</a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item md-nav__item--nested">
<input class="md-nav__toggle md-toggle md-toggle--indeterminate" id="__nav_11" type="checkbox"/>
<label class="md-nav__link" for="__nav_11" id="__nav_11_label" tabindex="0">
<span class="md-ellipsis">
    Capstone Project
    
  </span>
<span class="md-nav__icon md-icon"></span>
</label>
<nav aria-expanded="false" aria-labelledby="__nav_11_label" class="md-nav" data-md-level="1">
<label class="md-nav__title" for="__nav_11">
<span class="md-nav__icon md-icon"></span>
            Capstone Project
          </label>
<ul class="md-nav__list" data-md-scrollfix="">
<li class="md-nav__item">
<a class="md-nav__link" href="../../../capstone/overview.md">
<span class="md-ellipsis">
    Project Overview
    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../../capstone/planning.md">
<span class="md-ellipsis">
    Planning Phase
    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../../capstone/implementation.md">
<span class="md-ellipsis">
    Implementation
    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../../capstone/evaluation.md">
<span class="md-ellipsis">
    Evaluation
    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../../capstone/documentation.md">
<span class="md-ellipsis">
    Documentation
    
  </span>
</a>
</li>
</ul>
</nav>
</li>
</ul>
</nav>
</div>
</div>
</div>
<div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc">
<div class="md-sidebar__scrollwrap">
<div class="md-sidebar__inner">
<nav aria-label="Table of contents" class="md-nav md-nav--secondary">
<label class="md-nav__title" for="__toc">
<span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
<ul class="md-nav__list" data-md-component="toc" data-md-scrollfix="">
<li class="md-nav__item">
<a class="md-nav__link" href="#training-pipeline-overview">
<span class="md-ellipsis">
      🔄 Training Pipeline Overview
    </span>
</a>
<nav aria-label="🔄 Training Pipeline Overview" class="md-nav">
<ul class="md-nav__list">
<li class="md-nav__item">
<a class="md-nav__link" href="#three-stage-training-process">
<span class="md-ellipsis">
      Three-Stage Training Process
    </span>
</a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#data-preprocessing">
<span class="md-ellipsis">
      📝 Data Preprocessing
    </span>
</a>
<nav aria-label="📝 Data Preprocessing" class="md-nav">
<ul class="md-nav__list">
<li class="md-nav__item">
<a class="md-nav__link" href="#data-collection-and-cleaning">
<span class="md-ellipsis">
      Data Collection and Cleaning
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#tokenization-strategies">
<span class="md-ellipsis">
      Tokenization Strategies
    </span>
</a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#pre-training-process">
<span class="md-ellipsis">
      🚀 Pre-training Process
    </span>
</a>
<nav aria-label="🚀 Pre-training Process" class="md-nav">
<ul class="md-nav__list">
<li class="md-nav__item">
<a class="md-nav__link" href="#distributed-training-setup">
<span class="md-ellipsis">
      Distributed Training Setup
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#training-objectives-and-loss-functions">
<span class="md-ellipsis">
      Training Objectives and Loss Functions
    </span>
</a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#supervised-fine-tuning-sft">
<span class="md-ellipsis">
      🎯 Supervised Fine-tuning (SFT)
    </span>
</a>
<nav aria-label="🎯 Supervised Fine-tuning (SFT)" class="md-nav">
<ul class="md-nav__list">
<li class="md-nav__item">
<a class="md-nav__link" href="#instruction-following-training">
<span class="md-ellipsis">
      Instruction Following Training
    </span>
</a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#reinforcement-learning-from-human-feedback-rlhf">
<span class="md-ellipsis">
      🔄 Reinforcement Learning from Human Feedback (RLHF)
    </span>
</a>
<nav aria-label="🔄 Reinforcement Learning from Human Feedback (RLHF)" class="md-nav">
<ul class="md-nav__list">
<li class="md-nav__item">
<a class="md-nav__link" href="#reward-model-training">
<span class="md-ellipsis">
      Reward Model Training
    </span>
</a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#training-metrics-and-evaluation">
<span class="md-ellipsis">
      📊 Training Metrics and Evaluation
    </span>
</a>
<nav aria-label="📊 Training Metrics and Evaluation" class="md-nav">
<ul class="md-nav__list">
<li class="md-nav__item">
<a class="md-nav__link" href="#key-training-metrics">
<span class="md-ellipsis">
      Key Training Metrics
    </span>
</a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#training-process-checklist">
<span class="md-ellipsis">
      ✅ Training Process Checklist
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#next-steps">
<span class="md-ellipsis">
      🚀 Next Steps
    </span>
</a>
</li>
</ul>
</nav>
</div>
</div>
</div>
<div class="md-content" data-md-component="content">
<article class="md-content__inner md-typeset">
<h1 id="llm-training-process-from-raw-text-to-language-understanding">LLM Training Process: From Raw Text to Language Understanding</h1>
<p>Training Large Language Models is a complex, multi-stage process involving massive datasets, distributed computing, and careful optimization. This section covers the complete training pipeline.</p>
<h2 id="training-pipeline-overview">🔄 Training Pipeline Overview</h2>
<h3 id="three-stage-training-process">Three-Stage Training Process</h3>
<pre class="mermaid"><code>graph TB
    A[Raw Text Data] --&gt; B[Data Preprocessing]
    B --&gt; C[Tokenization]
    C --&gt; D[Pre-training]
    D --&gt; E[Supervised Fine-tuning]
    E --&gt; F[Reinforcement Learning from Human Feedback]
    F --&gt; G[Production Model]

    D --&gt; H[Base Model]
    H --&gt; I[Instruction Following]
    I --&gt; J[Alignment &amp; Safety]</code></pre>
<p><strong>Stage 1: Pre-training</strong> - Learn language patterns from massive text
<strong>Stage 2: Supervised Fine-tuning (SFT)</strong> - Learn to follow instructions<br/>
<strong>Stage 3: RLHF</strong> - Align with human preferences</p>
<h2 id="data-preprocessing">📝 Data Preprocessing</h2>
<h3 id="data-collection-and-cleaning">Data Collection and Cleaning</h3>
<p><strong>Web Crawling and Sources</strong>:
<div class="highlight"><pre><span></span><code><a href="#__codelineno-0-1" id="__codelineno-0-1" name="__codelineno-0-1"></a><span class="kn">import</span><span class="w"> </span><span class="nn">requests</span>
<a href="#__codelineno-0-2" id="__codelineno-0-2" name="__codelineno-0-2"></a><span class="kn">from</span><span class="w"> </span><span class="nn">bs4</span><span class="w"> </span><span class="kn">import</span> <span class="n">BeautifulSoup</span>
<a href="#__codelineno-0-3" id="__codelineno-0-3" name="__codelineno-0-3"></a><span class="kn">import</span><span class="w"> </span><span class="nn">re</span>
<a href="#__codelineno-0-4" id="__codelineno-0-4" name="__codelineno-0-4"></a><span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">List</span><span class="p">,</span> <span class="n">Dict</span>
<a href="#__codelineno-0-5" id="__codelineno-0-5" name="__codelineno-0-5"></a><span class="kn">import</span><span class="w"> </span><span class="nn">json</span>
<a href="#__codelineno-0-6" id="__codelineno-0-6" name="__codelineno-0-6"></a>
<a href="#__codelineno-0-7" id="__codelineno-0-7" name="__codelineno-0-7"></a><span class="k">class</span><span class="w"> </span><span class="nc">DataCollector</span><span class="p">:</span>
<a href="#__codelineno-0-8" id="__codelineno-0-8" name="__codelineno-0-8"></a><span class="w">    </span><span class="sd">"""Collect and clean training data for LLMs"""</span>
<a href="#__codelineno-0-9" id="__codelineno-0-9" name="__codelineno-0-9"></a>
<a href="#__codelineno-0-10" id="__codelineno-0-10" name="__codelineno-0-10"></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<a href="#__codelineno-0-11" id="__codelineno-0-11" name="__codelineno-0-11"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">quality_filters</span> <span class="o">=</span> <span class="p">{</span>
<a href="#__codelineno-0-12" id="__codelineno-0-12" name="__codelineno-0-12"></a>            <span class="s1">'min_length'</span><span class="p">:</span> <span class="mi">100</span><span class="p">,</span>
<a href="#__codelineno-0-13" id="__codelineno-0-13" name="__codelineno-0-13"></a>            <span class="s1">'max_length'</span><span class="p">:</span> <span class="mi">100000</span><span class="p">,</span>
<a href="#__codelineno-0-14" id="__codelineno-0-14" name="__codelineno-0-14"></a>            <span class="s1">'min_words'</span><span class="p">:</span> <span class="mi">20</span><span class="p">,</span>
<a href="#__codelineno-0-15" id="__codelineno-0-15" name="__codelineno-0-15"></a>            <span class="s1">'language_threshold'</span><span class="p">:</span> <span class="mf">0.8</span>
<a href="#__codelineno-0-16" id="__codelineno-0-16" name="__codelineno-0-16"></a>        <span class="p">}</span>
<a href="#__codelineno-0-17" id="__codelineno-0-17" name="__codelineno-0-17"></a>
<a href="#__codelineno-0-18" id="__codelineno-0-18" name="__codelineno-0-18"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">clean_text</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">text</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<a href="#__codelineno-0-19" id="__codelineno-0-19" name="__codelineno-0-19"></a><span class="w">        </span><span class="sd">"""Clean raw text data"""</span>
<a href="#__codelineno-0-20" id="__codelineno-0-20" name="__codelineno-0-20"></a>        <span class="c1"># Remove excessive whitespace</span>
<a href="#__codelineno-0-21" id="__codelineno-0-21" name="__codelineno-0-21"></a>        <span class="n">text</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="sa">r</span><span class="s1">'\s+'</span><span class="p">,</span> <span class="s1">' '</span><span class="p">,</span> <span class="n">text</span><span class="p">)</span>
<a href="#__codelineno-0-22" id="__codelineno-0-22" name="__codelineno-0-22"></a>
<a href="#__codelineno-0-23" id="__codelineno-0-23" name="__codelineno-0-23"></a>        <span class="c1"># Remove HTML artifacts</span>
<a href="#__codelineno-0-24" id="__codelineno-0-24" name="__codelineno-0-24"></a>        <span class="n">text</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="sa">r</span><span class="s1">'&lt;[^&gt;]+&gt;'</span><span class="p">,</span> <span class="s1">''</span><span class="p">,</span> <span class="n">text</span><span class="p">)</span>
<a href="#__codelineno-0-25" id="__codelineno-0-25" name="__codelineno-0-25"></a>
<a href="#__codelineno-0-26" id="__codelineno-0-26" name="__codelineno-0-26"></a>        <span class="c1"># Fix common encoding issues</span>
<a href="#__codelineno-0-27" id="__codelineno-0-27" name="__codelineno-0-27"></a>        <span class="n">text</span> <span class="o">=</span> <span class="n">text</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">'â€™'</span><span class="p">,</span> <span class="s2">"'"</span><span class="p">)</span>
<a href="#__codelineno-0-28" id="__codelineno-0-28" name="__codelineno-0-28"></a>        <span class="n">text</span> <span class="o">=</span> <span class="n">text</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">'â€œ'</span><span class="p">,</span> <span class="s1">'"'</span><span class="p">)</span>
<a href="#__codelineno-0-29" id="__codelineno-0-29" name="__codelineno-0-29"></a>        <span class="n">text</span> <span class="o">=</span> <span class="n">text</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">'â€'</span><span class="p">,</span> <span class="s1">'"'</span><span class="p">)</span>
<a href="#__codelineno-0-30" id="__codelineno-0-30" name="__codelineno-0-30"></a>
<a href="#__codelineno-0-31" id="__codelineno-0-31" name="__codelineno-0-31"></a>        <span class="c1"># Remove URLs</span>
<a href="#__codelineno-0-32" id="__codelineno-0-32" name="__codelineno-0-32"></a>        <span class="n">text</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="sa">r</span><span class="s1">'http[s]?://(?:[a-zA-Z]|[0-9]|[$-_@.&amp;+]|[!*</span><span class="se">\\</span><span class="s1">(</span><span class="se">\\</span><span class="s1">),]|(?:%[0-9a-fA-F][0-9a-fA-F]))+'</span><span class="p">,</span> <span class="s1">''</span><span class="p">,</span> <span class="n">text</span><span class="p">)</span>
<a href="#__codelineno-0-33" id="__codelineno-0-33" name="__codelineno-0-33"></a>
<a href="#__codelineno-0-34" id="__codelineno-0-34" name="__codelineno-0-34"></a>        <span class="k">return</span> <span class="n">text</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
<a href="#__codelineno-0-35" id="__codelineno-0-35" name="__codelineno-0-35"></a>
<a href="#__codelineno-0-36" id="__codelineno-0-36" name="__codelineno-0-36"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">quality_filter</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">text</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<a href="#__codelineno-0-37" id="__codelineno-0-37" name="__codelineno-0-37"></a><span class="w">        </span><span class="sd">"""Filter low-quality text"""</span>
<a href="#__codelineno-0-38" id="__codelineno-0-38" name="__codelineno-0-38"></a>        <span class="c1"># Length filters</span>
<a href="#__codelineno-0-39" id="__codelineno-0-39" name="__codelineno-0-39"></a>        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">text</span><span class="p">)</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">quality_filters</span><span class="p">[</span><span class="s1">'min_length'</span><span class="p">]:</span>
<a href="#__codelineno-0-40" id="__codelineno-0-40" name="__codelineno-0-40"></a>            <span class="k">return</span> <span class="kc">False</span>
<a href="#__codelineno-0-41" id="__codelineno-0-41" name="__codelineno-0-41"></a>        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">text</span><span class="p">)</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">quality_filters</span><span class="p">[</span><span class="s1">'max_length'</span><span class="p">]:</span>
<a href="#__codelineno-0-42" id="__codelineno-0-42" name="__codelineno-0-42"></a>            <span class="k">return</span> <span class="kc">False</span>
<a href="#__codelineno-0-43" id="__codelineno-0-43" name="__codelineno-0-43"></a>
<a href="#__codelineno-0-44" id="__codelineno-0-44" name="__codelineno-0-44"></a>        <span class="c1"># Word count filter</span>
<a href="#__codelineno-0-45" id="__codelineno-0-45" name="__codelineno-0-45"></a>        <span class="n">words</span> <span class="o">=</span> <span class="n">text</span><span class="o">.</span><span class="n">split</span><span class="p">()</span>
<a href="#__codelineno-0-46" id="__codelineno-0-46" name="__codelineno-0-46"></a>        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">words</span><span class="p">)</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">quality_filters</span><span class="p">[</span><span class="s1">'min_words'</span><span class="p">]:</span>
<a href="#__codelineno-0-47" id="__codelineno-0-47" name="__codelineno-0-47"></a>            <span class="k">return</span> <span class="kc">False</span>
<a href="#__codelineno-0-48" id="__codelineno-0-48" name="__codelineno-0-48"></a>
<a href="#__codelineno-0-49" id="__codelineno-0-49" name="__codelineno-0-49"></a>        <span class="c1"># Language detection (simplified)</span>
<a href="#__codelineno-0-50" id="__codelineno-0-50" name="__codelineno-0-50"></a>        <span class="n">english_chars</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="mi">1</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">text</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="k">if</span> <span class="s1">'a'</span> <span class="o">&lt;=</span> <span class="n">c</span> <span class="o">&lt;=</span> <span class="s1">'z'</span><span class="p">)</span>
<a href="#__codelineno-0-51" id="__codelineno-0-51" name="__codelineno-0-51"></a>        <span class="n">total_chars</span> <span class="o">=</span> <span class="nb">len</span><span class="p">([</span><span class="n">c</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">text</span> <span class="k">if</span> <span class="n">c</span><span class="o">.</span><span class="n">isalpha</span><span class="p">()])</span>
<a href="#__codelineno-0-52" id="__codelineno-0-52" name="__codelineno-0-52"></a>
<a href="#__codelineno-0-53" id="__codelineno-0-53" name="__codelineno-0-53"></a>        <span class="k">if</span> <span class="n">total_chars</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">english_chars</span> <span class="o">/</span> <span class="n">total_chars</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">quality_filters</span><span class="p">[</span><span class="s1">'language_threshold'</span><span class="p">]:</span>
<a href="#__codelineno-0-54" id="__codelineno-0-54" name="__codelineno-0-54"></a>            <span class="k">return</span> <span class="kc">False</span>
<a href="#__codelineno-0-55" id="__codelineno-0-55" name="__codelineno-0-55"></a>
<a href="#__codelineno-0-56" id="__codelineno-0-56" name="__codelineno-0-56"></a>        <span class="c1"># Content quality heuristics</span>
<a href="#__codelineno-0-57" id="__codelineno-0-57" name="__codelineno-0-57"></a>        <span class="k">if</span> <span class="n">text</span><span class="o">.</span><span class="n">count</span><span class="p">(</span><span class="s1">'...'</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">10</span><span class="p">:</span>  <span class="c1"># Likely truncated</span>
<a href="#__codelineno-0-58" id="__codelineno-0-58" name="__codelineno-0-58"></a>            <span class="k">return</span> <span class="kc">False</span>
<a href="#__codelineno-0-59" id="__codelineno-0-59" name="__codelineno-0-59"></a>        <span class="k">if</span> <span class="n">text</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="o">.</span><span class="n">count</span><span class="p">(</span><span class="s1">'cookie'</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">5</span><span class="p">:</span>  <span class="c1"># Cookie notices</span>
<a href="#__codelineno-0-60" id="__codelineno-0-60" name="__codelineno-0-60"></a>            <span class="k">return</span> <span class="kc">False</span>
<a href="#__codelineno-0-61" id="__codelineno-0-61" name="__codelineno-0-61"></a>
<a href="#__codelineno-0-62" id="__codelineno-0-62" name="__codelineno-0-62"></a>        <span class="k">return</span> <span class="kc">True</span>
<a href="#__codelineno-0-63" id="__codelineno-0-63" name="__codelineno-0-63"></a>
<a href="#__codelineno-0-64" id="__codelineno-0-64" name="__codelineno-0-64"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">deduplication</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">texts</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span> <span class="n">threshold</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.85</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
<a href="#__codelineno-0-65" id="__codelineno-0-65" name="__codelineno-0-65"></a><span class="w">        </span><span class="sd">"""Remove near-duplicate texts"""</span>
<a href="#__codelineno-0-66" id="__codelineno-0-66" name="__codelineno-0-66"></a>        <span class="kn">from</span><span class="w"> </span><span class="nn">difflib</span><span class="w"> </span><span class="kn">import</span> <span class="n">SequenceMatcher</span>
<a href="#__codelineno-0-67" id="__codelineno-0-67" name="__codelineno-0-67"></a>
<a href="#__codelineno-0-68" id="__codelineno-0-68" name="__codelineno-0-68"></a>        <span class="n">unique_texts</span> <span class="o">=</span> <span class="p">[]</span>
<a href="#__codelineno-0-69" id="__codelineno-0-69" name="__codelineno-0-69"></a>
<a href="#__codelineno-0-70" id="__codelineno-0-70" name="__codelineno-0-70"></a>        <span class="k">for</span> <span class="n">text</span> <span class="ow">in</span> <span class="n">texts</span><span class="p">:</span>
<a href="#__codelineno-0-71" id="__codelineno-0-71" name="__codelineno-0-71"></a>            <span class="n">is_duplicate</span> <span class="o">=</span> <span class="kc">False</span>
<a href="#__codelineno-0-72" id="__codelineno-0-72" name="__codelineno-0-72"></a>
<a href="#__codelineno-0-73" id="__codelineno-0-73" name="__codelineno-0-73"></a>            <span class="k">for</span> <span class="n">unique_text</span> <span class="ow">in</span> <span class="n">unique_texts</span><span class="p">:</span>
<a href="#__codelineno-0-74" id="__codelineno-0-74" name="__codelineno-0-74"></a>                <span class="n">similarity</span> <span class="o">=</span> <span class="n">SequenceMatcher</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="n">text</span><span class="p">,</span> <span class="n">unique_text</span><span class="p">)</span><span class="o">.</span><span class="n">ratio</span><span class="p">()</span>
<a href="#__codelineno-0-75" id="__codelineno-0-75" name="__codelineno-0-75"></a>                <span class="k">if</span> <span class="n">similarity</span> <span class="o">&gt;</span> <span class="n">threshold</span><span class="p">:</span>
<a href="#__codelineno-0-76" id="__codelineno-0-76" name="__codelineno-0-76"></a>                    <span class="n">is_duplicate</span> <span class="o">=</span> <span class="kc">True</span>
<a href="#__codelineno-0-77" id="__codelineno-0-77" name="__codelineno-0-77"></a>                    <span class="k">break</span>
<a href="#__codelineno-0-78" id="__codelineno-0-78" name="__codelineno-0-78"></a>
<a href="#__codelineno-0-79" id="__codelineno-0-79" name="__codelineno-0-79"></a>            <span class="k">if</span> <span class="ow">not</span> <span class="n">is_duplicate</span><span class="p">:</span>
<a href="#__codelineno-0-80" id="__codelineno-0-80" name="__codelineno-0-80"></a>                <span class="n">unique_texts</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">text</span><span class="p">)</span>
<a href="#__codelineno-0-81" id="__codelineno-0-81" name="__codelineno-0-81"></a>
<a href="#__codelineno-0-82" id="__codelineno-0-82" name="__codelineno-0-82"></a>        <span class="k">return</span> <span class="n">unique_texts</span>
<a href="#__codelineno-0-83" id="__codelineno-0-83" name="__codelineno-0-83"></a>
<a href="#__codelineno-0-84" id="__codelineno-0-84" name="__codelineno-0-84"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">create_training_dataset</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sources</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">:</span>
<a href="#__codelineno-0-85" id="__codelineno-0-85" name="__codelineno-0-85"></a><span class="w">        </span><span class="sd">"""Create processed dataset from multiple sources"""</span>
<a href="#__codelineno-0-86" id="__codelineno-0-86" name="__codelineno-0-86"></a>        <span class="n">all_texts</span> <span class="o">=</span> <span class="p">[]</span>
<a href="#__codelineno-0-87" id="__codelineno-0-87" name="__codelineno-0-87"></a>
<a href="#__codelineno-0-88" id="__codelineno-0-88" name="__codelineno-0-88"></a>        <span class="c1"># Common Crawl data (simulated)</span>
<a href="#__codelineno-0-89" id="__codelineno-0-89" name="__codelineno-0-89"></a>        <span class="n">common_crawl</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">simulate_common_crawl</span><span class="p">()</span>
<a href="#__codelineno-0-90" id="__codelineno-0-90" name="__codelineno-0-90"></a>        <span class="n">all_texts</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">common_crawl</span><span class="p">)</span>
<a href="#__codelineno-0-91" id="__codelineno-0-91" name="__codelineno-0-91"></a>
<a href="#__codelineno-0-92" id="__codelineno-0-92" name="__codelineno-0-92"></a>        <span class="c1"># Books (simulated)</span>
<a href="#__codelineno-0-93" id="__codelineno-0-93" name="__codelineno-0-93"></a>        <span class="n">books_data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">simulate_books_data</span><span class="p">()</span>
<a href="#__codelineno-0-94" id="__codelineno-0-94" name="__codelineno-0-94"></a>        <span class="n">all_texts</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">books_data</span><span class="p">)</span>
<a href="#__codelineno-0-95" id="__codelineno-0-95" name="__codelineno-0-95"></a>
<a href="#__codelineno-0-96" id="__codelineno-0-96" name="__codelineno-0-96"></a>        <span class="c1"># Academic papers (simulated)  </span>
<a href="#__codelineno-0-97" id="__codelineno-0-97" name="__codelineno-0-97"></a>        <span class="n">papers_data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">simulate_papers_data</span><span class="p">()</span>
<a href="#__codelineno-0-98" id="__codelineno-0-98" name="__codelineno-0-98"></a>        <span class="n">all_texts</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">papers_data</span><span class="p">)</span>
<a href="#__codelineno-0-99" id="__codelineno-0-99" name="__codelineno-0-99"></a>
<a href="#__codelineno-0-100" id="__codelineno-0-100" name="__codelineno-0-100"></a>        <span class="c1"># Clean and filter</span>
<a href="#__codelineno-0-101" id="__codelineno-0-101" name="__codelineno-0-101"></a>        <span class="n">cleaned_texts</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">clean_text</span><span class="p">(</span><span class="n">text</span><span class="p">)</span> <span class="k">for</span> <span class="n">text</span> <span class="ow">in</span> <span class="n">all_texts</span><span class="p">]</span>
<a href="#__codelineno-0-102" id="__codelineno-0-102" name="__codelineno-0-102"></a>        <span class="n">filtered_texts</span> <span class="o">=</span> <span class="p">[</span><span class="n">text</span> <span class="k">for</span> <span class="n">text</span> <span class="ow">in</span> <span class="n">cleaned_texts</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">quality_filter</span><span class="p">(</span><span class="n">text</span><span class="p">)]</span>
<a href="#__codelineno-0-103" id="__codelineno-0-103" name="__codelineno-0-103"></a>
<a href="#__codelineno-0-104" id="__codelineno-0-104" name="__codelineno-0-104"></a>        <span class="c1"># Deduplication</span>
<a href="#__codelineno-0-105" id="__codelineno-0-105" name="__codelineno-0-105"></a>        <span class="n">final_texts</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">deduplication</span><span class="p">(</span><span class="n">filtered_texts</span><span class="p">)</span>
<a href="#__codelineno-0-106" id="__codelineno-0-106" name="__codelineno-0-106"></a>
<a href="#__codelineno-0-107" id="__codelineno-0-107" name="__codelineno-0-107"></a>        <span class="k">return</span> <span class="p">{</span>
<a href="#__codelineno-0-108" id="__codelineno-0-108" name="__codelineno-0-108"></a>            <span class="s1">'texts'</span><span class="p">:</span> <span class="n">final_texts</span><span class="p">,</span>
<a href="#__codelineno-0-109" id="__codelineno-0-109" name="__codelineno-0-109"></a>            <span class="s1">'total_documents'</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="n">final_texts</span><span class="p">),</span>
<a href="#__codelineno-0-110" id="__codelineno-0-110" name="__codelineno-0-110"></a>            <span class="s1">'total_tokens'</span><span class="p">:</span> <span class="nb">sum</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">text</span><span class="o">.</span><span class="n">split</span><span class="p">())</span> <span class="k">for</span> <span class="n">text</span> <span class="ow">in</span> <span class="n">final_texts</span><span class="p">),</span>
<a href="#__codelineno-0-111" id="__codelineno-0-111" name="__codelineno-0-111"></a>            <span class="s1">'sources'</span><span class="p">:</span> <span class="p">{</span>
<a href="#__codelineno-0-112" id="__codelineno-0-112" name="__codelineno-0-112"></a>                <span class="s1">'common_crawl'</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="n">common_crawl</span><span class="p">),</span>
<a href="#__codelineno-0-113" id="__codelineno-0-113" name="__codelineno-0-113"></a>                <span class="s1">'books'</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="n">books_data</span><span class="p">),</span>
<a href="#__codelineno-0-114" id="__codelineno-0-114" name="__codelineno-0-114"></a>                <span class="s1">'papers'</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="n">papers_data</span><span class="p">)</span>
<a href="#__codelineno-0-115" id="__codelineno-0-115" name="__codelineno-0-115"></a>            <span class="p">}</span>
<a href="#__codelineno-0-116" id="__codelineno-0-116" name="__codelineno-0-116"></a>        <span class="p">}</span>
<a href="#__codelineno-0-117" id="__codelineno-0-117" name="__codelineno-0-117"></a>
<a href="#__codelineno-0-118" id="__codelineno-0-118" name="__codelineno-0-118"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">simulate_common_crawl</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
<a href="#__codelineno-0-119" id="__codelineno-0-119" name="__codelineno-0-119"></a><span class="w">        </span><span class="sd">"""Simulate Common Crawl web data"""</span>
<a href="#__codelineno-0-120" id="__codelineno-0-120" name="__codelineno-0-120"></a>        <span class="k">return</span> <span class="p">[</span>
<a href="#__codelineno-0-121" id="__codelineno-0-121" name="__codelineno-0-121"></a>            <span class="s2">"This is a sample web page about artificial intelligence. AI is transforming many industries..."</span><span class="p">,</span>
<a href="#__codelineno-0-122" id="__codelineno-0-122" name="__codelineno-0-122"></a>            <span class="s2">"Welcome to our blog about machine learning. Today we'll discuss neural networks..."</span><span class="p">,</span>
<a href="#__codelineno-0-123" id="__codelineno-0-123" name="__codelineno-0-123"></a>            <span class="s2">"News article: Recent advances in natural language processing have led to breakthrough applications..."</span>
<a href="#__codelineno-0-124" id="__codelineno-0-124" name="__codelineno-0-124"></a>        <span class="p">]</span>
<a href="#__codelineno-0-125" id="__codelineno-0-125" name="__codelineno-0-125"></a>
<a href="#__codelineno-0-126" id="__codelineno-0-126" name="__codelineno-0-126"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">simulate_books_data</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
<a href="#__codelineno-0-127" id="__codelineno-0-127" name="__codelineno-0-127"></a>        <span class="k">return</span> <span class="p">[</span>
<a href="#__codelineno-0-128" id="__codelineno-0-128" name="__codelineno-0-128"></a>            <span class="s2">"Chapter 1: Introduction to Computer Science. Computer science is the study of algorithms..."</span><span class="p">,</span>
<a href="#__codelineno-0-129" id="__codelineno-0-129" name="__codelineno-0-129"></a>            <span class="s2">"In the realm of literature, we find that narrative structures have evolved significantly..."</span>
<a href="#__codelineno-0-130" id="__codelineno-0-130" name="__codelineno-0-130"></a>        <span class="p">]</span>
<a href="#__codelineno-0-131" id="__codelineno-0-131" name="__codelineno-0-131"></a>
<a href="#__codelineno-0-132" id="__codelineno-0-132" name="__codelineno-0-132"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">simulate_papers_data</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
<a href="#__codelineno-0-133" id="__codelineno-0-133" name="__codelineno-0-133"></a>        <span class="k">return</span> <span class="p">[</span>
<a href="#__codelineno-0-134" id="__codelineno-0-134" name="__codelineno-0-134"></a>            <span class="s2">"Abstract: This paper presents a novel approach to transformer architecture optimization..."</span><span class="p">,</span>
<a href="#__codelineno-0-135" id="__codelineno-0-135" name="__codelineno-0-135"></a>            <span class="s2">"We propose a new method for scaling neural language models to trillion parameters..."</span>
<a href="#__codelineno-0-136" id="__codelineno-0-136" name="__codelineno-0-136"></a>        <span class="p">]</span>
<a href="#__codelineno-0-137" id="__codelineno-0-137" name="__codelineno-0-137"></a>
<a href="#__codelineno-0-138" id="__codelineno-0-138" name="__codelineno-0-138"></a><span class="c1"># Example usage</span>
<a href="#__codelineno-0-139" id="__codelineno-0-139" name="__codelineno-0-139"></a><span class="n">collector</span> <span class="o">=</span> <span class="n">DataCollector</span><span class="p">()</span>
<a href="#__codelineno-0-140" id="__codelineno-0-140" name="__codelineno-0-140"></a><span class="n">dataset</span> <span class="o">=</span> <span class="n">collector</span><span class="o">.</span><span class="n">create_training_dataset</span><span class="p">([</span><span class="s1">'web'</span><span class="p">,</span> <span class="s1">'books'</span><span class="p">,</span> <span class="s1">'papers'</span><span class="p">])</span>
<a href="#__codelineno-0-141" id="__codelineno-0-141" name="__codelineno-0-141"></a><span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"Dataset created with </span><span class="si">{</span><span class="n">dataset</span><span class="p">[</span><span class="s1">'total_documents'</span><span class="p">]</span><span class="si">}</span><span class="s2"> documents and </span><span class="si">{</span><span class="n">dataset</span><span class="p">[</span><span class="s1">'total_tokens'</span><span class="p">]</span><span class="si">}</span><span class="s2"> tokens"</span><span class="p">)</span>
</code></pre></div></p>
<h3 id="tokenization-strategies">Tokenization Strategies</h3>
<p><strong>Subword Tokenization</strong>:
<div class="highlight"><pre><span></span><code><a href="#__codelineno-1-1" id="__codelineno-1-1" name="__codelineno-1-1"></a><span class="kn">import</span><span class="w"> </span><span class="nn">re</span>
<a href="#__codelineno-1-2" id="__codelineno-1-2" name="__codelineno-1-2"></a><span class="kn">from</span><span class="w"> </span><span class="nn">collections</span><span class="w"> </span><span class="kn">import</span> <span class="n">defaultdict</span><span class="p">,</span> <span class="n">Counter</span>
<a href="#__codelineno-1-3" id="__codelineno-1-3" name="__codelineno-1-3"></a><span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">Dict</span><span class="p">,</span> <span class="n">List</span><span class="p">,</span> <span class="n">Tuple</span>
<a href="#__codelineno-1-4" id="__codelineno-1-4" name="__codelineno-1-4"></a>
<a href="#__codelineno-1-5" id="__codelineno-1-5" name="__codelineno-1-5"></a><span class="k">class</span><span class="w"> </span><span class="nc">BPETokenizer</span><span class="p">:</span>
<a href="#__codelineno-1-6" id="__codelineno-1-6" name="__codelineno-1-6"></a><span class="w">    </span><span class="sd">"""Byte Pair Encoding tokenizer for LLMs"""</span>
<a href="#__codelineno-1-7" id="__codelineno-1-7" name="__codelineno-1-7"></a>
<a href="#__codelineno-1-8" id="__codelineno-1-8" name="__codelineno-1-8"></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">vocab_size</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">50000</span><span class="p">):</span>
<a href="#__codelineno-1-9" id="__codelineno-1-9" name="__codelineno-1-9"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">vocab_size</span> <span class="o">=</span> <span class="n">vocab_size</span>
<a href="#__codelineno-1-10" id="__codelineno-1-10" name="__codelineno-1-10"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">vocab</span> <span class="o">=</span> <span class="p">{}</span>
<a href="#__codelineno-1-11" id="__codelineno-1-11" name="__codelineno-1-11"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">merges</span> <span class="o">=</span> <span class="p">[]</span>
<a href="#__codelineno-1-12" id="__codelineno-1-12" name="__codelineno-1-12"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">special_tokens</span> <span class="o">=</span> <span class="p">{</span>
<a href="#__codelineno-1-13" id="__codelineno-1-13" name="__codelineno-1-13"></a>            <span class="s1">'&lt;pad&gt;'</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
<a href="#__codelineno-1-14" id="__codelineno-1-14" name="__codelineno-1-14"></a>            <span class="s1">'&lt;unk&gt;'</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span> 
<a href="#__codelineno-1-15" id="__codelineno-1-15" name="__codelineno-1-15"></a>            <span class="s1">'&lt;s&gt;'</span><span class="p">:</span> <span class="mi">2</span><span class="p">,</span>
<a href="#__codelineno-1-16" id="__codelineno-1-16" name="__codelineno-1-16"></a>            <span class="s1">'&lt;/s&gt;'</span><span class="p">:</span> <span class="mi">3</span>
<a href="#__codelineno-1-17" id="__codelineno-1-17" name="__codelineno-1-17"></a>        <span class="p">}</span>
<a href="#__codelineno-1-18" id="__codelineno-1-18" name="__codelineno-1-18"></a>
<a href="#__codelineno-1-19" id="__codelineno-1-19" name="__codelineno-1-19"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">get_word_freqs</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">texts</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">int</span><span class="p">]:</span>
<a href="#__codelineno-1-20" id="__codelineno-1-20" name="__codelineno-1-20"></a><span class="w">        </span><span class="sd">"""Get word frequencies from training texts"""</span>
<a href="#__codelineno-1-21" id="__codelineno-1-21" name="__codelineno-1-21"></a>        <span class="n">word_freqs</span> <span class="o">=</span> <span class="n">Counter</span><span class="p">()</span>
<a href="#__codelineno-1-22" id="__codelineno-1-22" name="__codelineno-1-22"></a>
<a href="#__codelineno-1-23" id="__codelineno-1-23" name="__codelineno-1-23"></a>        <span class="k">for</span> <span class="n">text</span> <span class="ow">in</span> <span class="n">texts</span><span class="p">:</span>
<a href="#__codelineno-1-24" id="__codelineno-1-24" name="__codelineno-1-24"></a>            <span class="c1"># Simple tokenization (space-based)</span>
<a href="#__codelineno-1-25" id="__codelineno-1-25" name="__codelineno-1-25"></a>            <span class="n">words</span> <span class="o">=</span> <span class="n">text</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="o">.</span><span class="n">split</span><span class="p">()</span>
<a href="#__codelineno-1-26" id="__codelineno-1-26" name="__codelineno-1-26"></a>            <span class="k">for</span> <span class="n">word</span> <span class="ow">in</span> <span class="n">words</span><span class="p">:</span>
<a href="#__codelineno-1-27" id="__codelineno-1-27" name="__codelineno-1-27"></a>                <span class="c1"># Clean punctuation</span>
<a href="#__codelineno-1-28" id="__codelineno-1-28" name="__codelineno-1-28"></a>                <span class="n">word</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="sa">r</span><span class="s1">'[^\w]'</span><span class="p">,</span> <span class="s1">''</span><span class="p">,</span> <span class="n">word</span><span class="p">)</span>
<a href="#__codelineno-1-29" id="__codelineno-1-29" name="__codelineno-1-29"></a>                <span class="k">if</span> <span class="n">word</span><span class="p">:</span>
<a href="#__codelineno-1-30" id="__codelineno-1-30" name="__codelineno-1-30"></a>                    <span class="n">word_freqs</span><span class="p">[</span><span class="n">word</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>
<a href="#__codelineno-1-31" id="__codelineno-1-31" name="__codelineno-1-31"></a>
<a href="#__codelineno-1-32" id="__codelineno-1-32" name="__codelineno-1-32"></a>        <span class="k">return</span> <span class="nb">dict</span><span class="p">(</span><span class="n">word_freqs</span><span class="p">)</span>
<a href="#__codelineno-1-33" id="__codelineno-1-33" name="__codelineno-1-33"></a>
<a href="#__codelineno-1-34" id="__codelineno-1-34" name="__codelineno-1-34"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">get_pairs</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">word_freqs</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">int</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="n">Tuple</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">],</span> <span class="nb">int</span><span class="p">]:</span>
<a href="#__codelineno-1-35" id="__codelineno-1-35" name="__codelineno-1-35"></a><span class="w">        </span><span class="sd">"""Get all pairs of consecutive symbols"""</span>
<a href="#__codelineno-1-36" id="__codelineno-1-36" name="__codelineno-1-36"></a>        <span class="n">pairs</span> <span class="o">=</span> <span class="n">defaultdict</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
<a href="#__codelineno-1-37" id="__codelineno-1-37" name="__codelineno-1-37"></a>
<a href="#__codelineno-1-38" id="__codelineno-1-38" name="__codelineno-1-38"></a>        <span class="k">for</span> <span class="n">word</span><span class="p">,</span> <span class="n">freq</span> <span class="ow">in</span> <span class="n">word_freqs</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
<a href="#__codelineno-1-39" id="__codelineno-1-39" name="__codelineno-1-39"></a>            <span class="c1"># Convert word to list of characters</span>
<a href="#__codelineno-1-40" id="__codelineno-1-40" name="__codelineno-1-40"></a>            <span class="n">symbols</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">word</span><span class="p">)</span>
<a href="#__codelineno-1-41" id="__codelineno-1-41" name="__codelineno-1-41"></a>
<a href="#__codelineno-1-42" id="__codelineno-1-42" name="__codelineno-1-42"></a>            <span class="c1"># Count all consecutive pairs</span>
<a href="#__codelineno-1-43" id="__codelineno-1-43" name="__codelineno-1-43"></a>            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">symbols</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">):</span>
<a href="#__codelineno-1-44" id="__codelineno-1-44" name="__codelineno-1-44"></a>                <span class="n">pair</span> <span class="o">=</span> <span class="p">(</span><span class="n">symbols</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">symbols</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">])</span>
<a href="#__codelineno-1-45" id="__codelineno-1-45" name="__codelineno-1-45"></a>                <span class="n">pairs</span><span class="p">[</span><span class="n">pair</span><span class="p">]</span> <span class="o">+=</span> <span class="n">freq</span>
<a href="#__codelineno-1-46" id="__codelineno-1-46" name="__codelineno-1-46"></a>
<a href="#__codelineno-1-47" id="__codelineno-1-47" name="__codelineno-1-47"></a>        <span class="k">return</span> <span class="nb">dict</span><span class="p">(</span><span class="n">pairs</span><span class="p">)</span>
<a href="#__codelineno-1-48" id="__codelineno-1-48" name="__codelineno-1-48"></a>
<a href="#__codelineno-1-49" id="__codelineno-1-49" name="__codelineno-1-49"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">merge_vocab</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pair</span><span class="p">:</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">],</span> <span class="n">word_freqs</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">int</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">int</span><span class="p">]:</span>
<a href="#__codelineno-1-50" id="__codelineno-1-50" name="__codelineno-1-50"></a><span class="w">        </span><span class="sd">"""Merge the most frequent pair in vocabulary"""</span>
<a href="#__codelineno-1-51" id="__codelineno-1-51" name="__codelineno-1-51"></a>        <span class="n">new_word_freqs</span> <span class="o">=</span> <span class="p">{}</span>
<a href="#__codelineno-1-52" id="__codelineno-1-52" name="__codelineno-1-52"></a>        <span class="n">bigram</span> <span class="o">=</span> <span class="s1">''</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">pair</span><span class="p">)</span>
<a href="#__codelineno-1-53" id="__codelineno-1-53" name="__codelineno-1-53"></a>
<a href="#__codelineno-1-54" id="__codelineno-1-54" name="__codelineno-1-54"></a>        <span class="k">for</span> <span class="n">word</span><span class="p">,</span> <span class="n">freq</span> <span class="ow">in</span> <span class="n">word_freqs</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
<a href="#__codelineno-1-55" id="__codelineno-1-55" name="__codelineno-1-55"></a>            <span class="c1"># Replace all occurrences of the pair</span>
<a href="#__codelineno-1-56" id="__codelineno-1-56" name="__codelineno-1-56"></a>            <span class="n">new_word</span> <span class="o">=</span> <span class="n">word</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">''</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">pair</span><span class="p">),</span> <span class="n">bigram</span><span class="p">)</span>
<a href="#__codelineno-1-57" id="__codelineno-1-57" name="__codelineno-1-57"></a>            <span class="n">new_word_freqs</span><span class="p">[</span><span class="n">new_word</span><span class="p">]</span> <span class="o">=</span> <span class="n">freq</span>
<a href="#__codelineno-1-58" id="__codelineno-1-58" name="__codelineno-1-58"></a>
<a href="#__codelineno-1-59" id="__codelineno-1-59" name="__codelineno-1-59"></a>        <span class="k">return</span> <span class="n">new_word_freqs</span>
<a href="#__codelineno-1-60" id="__codelineno-1-60" name="__codelineno-1-60"></a>
<a href="#__codelineno-1-61" id="__codelineno-1-61" name="__codelineno-1-61"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">train</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">texts</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]):</span>
<a href="#__codelineno-1-62" id="__codelineno-1-62" name="__codelineno-1-62"></a><span class="w">        </span><span class="sd">"""Train BPE tokenizer"""</span>
<a href="#__codelineno-1-63" id="__codelineno-1-63" name="__codelineno-1-63"></a>        <span class="c1"># Get initial word frequencies</span>
<a href="#__codelineno-1-64" id="__codelineno-1-64" name="__codelineno-1-64"></a>        <span class="n">word_freqs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_word_freqs</span><span class="p">(</span><span class="n">texts</span><span class="p">)</span>
<a href="#__codelineno-1-65" id="__codelineno-1-65" name="__codelineno-1-65"></a>
<a href="#__codelineno-1-66" id="__codelineno-1-66" name="__codelineno-1-66"></a>        <span class="c1"># Initialize vocabulary with single characters</span>
<a href="#__codelineno-1-67" id="__codelineno-1-67" name="__codelineno-1-67"></a>        <span class="n">vocab</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
<a href="#__codelineno-1-68" id="__codelineno-1-68" name="__codelineno-1-68"></a>        <span class="k">for</span> <span class="n">word</span> <span class="ow">in</span> <span class="n">word_freqs</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
<a href="#__codelineno-1-69" id="__codelineno-1-69" name="__codelineno-1-69"></a>            <span class="n">vocab</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">word</span><span class="p">))</span>
<a href="#__codelineno-1-70" id="__codelineno-1-70" name="__codelineno-1-70"></a>
<a href="#__codelineno-1-71" id="__codelineno-1-71" name="__codelineno-1-71"></a>        <span class="c1"># Add special tokens</span>
<a href="#__codelineno-1-72" id="__codelineno-1-72" name="__codelineno-1-72"></a>        <span class="n">vocab</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">special_tokens</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
<a href="#__codelineno-1-73" id="__codelineno-1-73" name="__codelineno-1-73"></a>
<a href="#__codelineno-1-74" id="__codelineno-1-74" name="__codelineno-1-74"></a>        <span class="c1"># Perform BPE merges</span>
<a href="#__codelineno-1-75" id="__codelineno-1-75" name="__codelineno-1-75"></a>        <span class="n">num_merges</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">vocab_size</span> <span class="o">-</span> <span class="nb">len</span><span class="p">(</span><span class="n">vocab</span><span class="p">)</span>
<a href="#__codelineno-1-76" id="__codelineno-1-76" name="__codelineno-1-76"></a>
<a href="#__codelineno-1-77" id="__codelineno-1-77" name="__codelineno-1-77"></a>        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">num_merges</span><span class="p">):</span>
<a href="#__codelineno-1-78" id="__codelineno-1-78" name="__codelineno-1-78"></a>            <span class="n">pairs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_pairs</span><span class="p">(</span><span class="n">word_freqs</span><span class="p">)</span>
<a href="#__codelineno-1-79" id="__codelineno-1-79" name="__codelineno-1-79"></a>
<a href="#__codelineno-1-80" id="__codelineno-1-80" name="__codelineno-1-80"></a>            <span class="k">if</span> <span class="ow">not</span> <span class="n">pairs</span><span class="p">:</span>
<a href="#__codelineno-1-81" id="__codelineno-1-81" name="__codelineno-1-81"></a>                <span class="k">break</span>
<a href="#__codelineno-1-82" id="__codelineno-1-82" name="__codelineno-1-82"></a>
<a href="#__codelineno-1-83" id="__codelineno-1-83" name="__codelineno-1-83"></a>            <span class="c1"># Find most frequent pair</span>
<a href="#__codelineno-1-84" id="__codelineno-1-84" name="__codelineno-1-84"></a>            <span class="n">best_pair</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">pairs</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="n">pairs</span><span class="o">.</span><span class="n">get</span><span class="p">)</span>
<a href="#__codelineno-1-85" id="__codelineno-1-85" name="__codelineno-1-85"></a>
<a href="#__codelineno-1-86" id="__codelineno-1-86" name="__codelineno-1-86"></a>            <span class="c1"># Merge the pair</span>
<a href="#__codelineno-1-87" id="__codelineno-1-87" name="__codelineno-1-87"></a>            <span class="n">word_freqs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">merge_vocab</span><span class="p">(</span><span class="n">best_pair</span><span class="p">,</span> <span class="n">word_freqs</span><span class="p">)</span>
<a href="#__codelineno-1-88" id="__codelineno-1-88" name="__codelineno-1-88"></a>
<a href="#__codelineno-1-89" id="__codelineno-1-89" name="__codelineno-1-89"></a>            <span class="c1"># Add merged token to vocabulary</span>
<a href="#__codelineno-1-90" id="__codelineno-1-90" name="__codelineno-1-90"></a>            <span class="n">merged_token</span> <span class="o">=</span> <span class="s1">''</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">best_pair</span><span class="p">)</span>
<a href="#__codelineno-1-91" id="__codelineno-1-91" name="__codelineno-1-91"></a>            <span class="n">vocab</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">merged_token</span><span class="p">)</span>
<a href="#__codelineno-1-92" id="__codelineno-1-92" name="__codelineno-1-92"></a>
<a href="#__codelineno-1-93" id="__codelineno-1-93" name="__codelineno-1-93"></a>            <span class="c1"># Store merge for encoding</span>
<a href="#__codelineno-1-94" id="__codelineno-1-94" name="__codelineno-1-94"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">merges</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">best_pair</span><span class="p">)</span>
<a href="#__codelineno-1-95" id="__codelineno-1-95" name="__codelineno-1-95"></a>
<a href="#__codelineno-1-96" id="__codelineno-1-96" name="__codelineno-1-96"></a>            <span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">%</span> <span class="mi">1000</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
<a href="#__codelineno-1-97" id="__codelineno-1-97" name="__codelineno-1-97"></a>                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"Merge </span><span class="si">{</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">num_merges</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">best_pair</span><span class="si">}</span><span class="s2"> -&gt; </span><span class="si">{</span><span class="n">merged_token</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
<a href="#__codelineno-1-98" id="__codelineno-1-98" name="__codelineno-1-98"></a>
<a href="#__codelineno-1-99" id="__codelineno-1-99" name="__codelineno-1-99"></a>        <span class="c1"># Create final vocabulary mapping</span>
<a href="#__codelineno-1-100" id="__codelineno-1-100" name="__codelineno-1-100"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">vocab</span> <span class="o">=</span> <span class="p">{</span><span class="n">token</span><span class="p">:</span> <span class="n">i</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">token</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="nb">sorted</span><span class="p">(</span><span class="n">vocab</span><span class="p">))}</span>
<a href="#__codelineno-1-101" id="__codelineno-1-101" name="__codelineno-1-101"></a>
<a href="#__codelineno-1-102" id="__codelineno-1-102" name="__codelineno-1-102"></a>        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"Trained BPE tokenizer with </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">vocab</span><span class="p">)</span><span class="si">}</span><span class="s2"> tokens"</span><span class="p">)</span>
<a href="#__codelineno-1-103" id="__codelineno-1-103" name="__codelineno-1-103"></a>
<a href="#__codelineno-1-104" id="__codelineno-1-104" name="__codelineno-1-104"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">encode</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">text</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="nb">int</span><span class="p">]:</span>
<a href="#__codelineno-1-105" id="__codelineno-1-105" name="__codelineno-1-105"></a><span class="w">        </span><span class="sd">"""Encode text to token IDs"""</span>
<a href="#__codelineno-1-106" id="__codelineno-1-106" name="__codelineno-1-106"></a>        <span class="c1"># This is simplified - real BPE encoding is more complex</span>
<a href="#__codelineno-1-107" id="__codelineno-1-107" name="__codelineno-1-107"></a>        <span class="n">tokens</span> <span class="o">=</span> <span class="p">[]</span>
<a href="#__codelineno-1-108" id="__codelineno-1-108" name="__codelineno-1-108"></a>        <span class="n">words</span> <span class="o">=</span> <span class="n">text</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="o">.</span><span class="n">split</span><span class="p">()</span>
<a href="#__codelineno-1-109" id="__codelineno-1-109" name="__codelineno-1-109"></a>
<a href="#__codelineno-1-110" id="__codelineno-1-110" name="__codelineno-1-110"></a>        <span class="k">for</span> <span class="n">word</span> <span class="ow">in</span> <span class="n">words</span><span class="p">:</span>
<a href="#__codelineno-1-111" id="__codelineno-1-111" name="__codelineno-1-111"></a>            <span class="n">word</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="sa">r</span><span class="s1">'[^\w]'</span><span class="p">,</span> <span class="s1">''</span><span class="p">,</span> <span class="n">word</span><span class="p">)</span>
<a href="#__codelineno-1-112" id="__codelineno-1-112" name="__codelineno-1-112"></a>            <span class="k">if</span> <span class="n">word</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">vocab</span><span class="p">:</span>
<a href="#__codelineno-1-113" id="__codelineno-1-113" name="__codelineno-1-113"></a>                <span class="n">tokens</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">vocab</span><span class="p">[</span><span class="n">word</span><span class="p">])</span>
<a href="#__codelineno-1-114" id="__codelineno-1-114" name="__codelineno-1-114"></a>            <span class="k">else</span><span class="p">:</span>
<a href="#__codelineno-1-115" id="__codelineno-1-115" name="__codelineno-1-115"></a>                <span class="c1"># Handle unknown words by character-level encoding</span>
<a href="#__codelineno-1-116" id="__codelineno-1-116" name="__codelineno-1-116"></a>                <span class="k">for</span> <span class="n">char</span> <span class="ow">in</span> <span class="n">word</span><span class="p">:</span>
<a href="#__codelineno-1-117" id="__codelineno-1-117" name="__codelineno-1-117"></a>                    <span class="k">if</span> <span class="n">char</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">vocab</span><span class="p">:</span>
<a href="#__codelineno-1-118" id="__codelineno-1-118" name="__codelineno-1-118"></a>                        <span class="n">tokens</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">vocab</span><span class="p">[</span><span class="n">char</span><span class="p">])</span>
<a href="#__codelineno-1-119" id="__codelineno-1-119" name="__codelineno-1-119"></a>                    <span class="k">else</span><span class="p">:</span>
<a href="#__codelineno-1-120" id="__codelineno-1-120" name="__codelineno-1-120"></a>                        <span class="n">tokens</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">vocab</span><span class="p">[</span><span class="s1">'&lt;unk&gt;'</span><span class="p">])</span>
<a href="#__codelineno-1-121" id="__codelineno-1-121" name="__codelineno-1-121"></a>
<a href="#__codelineno-1-122" id="__codelineno-1-122" name="__codelineno-1-122"></a>        <span class="k">return</span> <span class="n">tokens</span>
<a href="#__codelineno-1-123" id="__codelineno-1-123" name="__codelineno-1-123"></a>
<a href="#__codelineno-1-124" id="__codelineno-1-124" name="__codelineno-1-124"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">decode</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">token_ids</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">int</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<a href="#__codelineno-1-125" id="__codelineno-1-125" name="__codelineno-1-125"></a><span class="w">        </span><span class="sd">"""Decode token IDs back to text"""</span>
<a href="#__codelineno-1-126" id="__codelineno-1-126" name="__codelineno-1-126"></a>        <span class="n">id_to_token</span> <span class="o">=</span> <span class="p">{</span><span class="n">v</span><span class="p">:</span> <span class="n">k</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">vocab</span><span class="o">.</span><span class="n">items</span><span class="p">()}</span>
<a href="#__codelineno-1-127" id="__codelineno-1-127" name="__codelineno-1-127"></a>        <span class="n">tokens</span> <span class="o">=</span> <span class="p">[</span><span class="n">id_to_token</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">token_id</span><span class="p">,</span> <span class="s1">'&lt;unk&gt;'</span><span class="p">)</span> <span class="k">for</span> <span class="n">token_id</span> <span class="ow">in</span> <span class="n">token_ids</span><span class="p">]</span>
<a href="#__codelineno-1-128" id="__codelineno-1-128" name="__codelineno-1-128"></a>        <span class="k">return</span> <span class="s1">' '</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">tokens</span><span class="p">)</span>
<a href="#__codelineno-1-129" id="__codelineno-1-129" name="__codelineno-1-129"></a>
<a href="#__codelineno-1-130" id="__codelineno-1-130" name="__codelineno-1-130"></a><span class="c1"># Example tokenizer training</span>
<a href="#__codelineno-1-131" id="__codelineno-1-131" name="__codelineno-1-131"></a><span class="n">sample_texts</span> <span class="o">=</span> <span class="p">[</span>
<a href="#__codelineno-1-132" id="__codelineno-1-132" name="__codelineno-1-132"></a>    <span class="s2">"The quick brown fox jumps over the lazy dog"</span><span class="p">,</span>
<a href="#__codelineno-1-133" id="__codelineno-1-133" name="__codelineno-1-133"></a>    <span class="s2">"Machine learning is a subset of artificial intelligence"</span><span class="p">,</span>
<a href="#__codelineno-1-134" id="__codelineno-1-134" name="__codelineno-1-134"></a>    <span class="s2">"Natural language processing enables computers to understand human language"</span>
<a href="#__codelineno-1-135" id="__codelineno-1-135" name="__codelineno-1-135"></a><span class="p">]</span>
<a href="#__codelineno-1-136" id="__codelineno-1-136" name="__codelineno-1-136"></a>
<a href="#__codelineno-1-137" id="__codelineno-1-137" name="__codelineno-1-137"></a><span class="n">tokenizer</span> <span class="o">=</span> <span class="n">BPETokenizer</span><span class="p">(</span><span class="n">vocab_size</span><span class="o">=</span><span class="mi">1000</span><span class="p">)</span>
<a href="#__codelineno-1-138" id="__codelineno-1-138" name="__codelineno-1-138"></a><span class="n">tokenizer</span><span class="o">.</span><span class="n">train</span><span class="p">(</span><span class="n">sample_texts</span><span class="p">)</span>
<a href="#__codelineno-1-139" id="__codelineno-1-139" name="__codelineno-1-139"></a>
<a href="#__codelineno-1-140" id="__codelineno-1-140" name="__codelineno-1-140"></a><span class="c1"># Test encoding/decoding</span>
<a href="#__codelineno-1-141" id="__codelineno-1-141" name="__codelineno-1-141"></a><span class="n">text</span> <span class="o">=</span> <span class="s2">"The fox jumps"</span>
<a href="#__codelineno-1-142" id="__codelineno-1-142" name="__codelineno-1-142"></a><span class="n">token_ids</span> <span class="o">=</span> <span class="n">tokenizer</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="n">text</span><span class="p">)</span>
<a href="#__codelineno-1-143" id="__codelineno-1-143" name="__codelineno-1-143"></a><span class="n">decoded</span> <span class="o">=</span> <span class="n">tokenizer</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="n">token_ids</span><span class="p">)</span>
<a href="#__codelineno-1-144" id="__codelineno-1-144" name="__codelineno-1-144"></a><span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"Original: </span><span class="si">{</span><span class="n">text</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
<a href="#__codelineno-1-145" id="__codelineno-1-145" name="__codelineno-1-145"></a><span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"Encoded: </span><span class="si">{</span><span class="n">token_ids</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
<a href="#__codelineno-1-146" id="__codelineno-1-146" name="__codelineno-1-146"></a><span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"Decoded: </span><span class="si">{</span><span class="n">decoded</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
</code></pre></div></p>
<h2 id="pre-training-process">🚀 Pre-training Process</h2>
<h3 id="distributed-training-setup">Distributed Training Setup</h3>
<p><strong>Multi-GPU Training Strategy</strong>:
<div class="highlight"><pre><span></span><code><a href="#__codelineno-2-1" id="__codelineno-2-1" name="__codelineno-2-1"></a><span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>
<a href="#__codelineno-2-2" id="__codelineno-2-2" name="__codelineno-2-2"></a><span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">Dict</span><span class="p">,</span> <span class="n">List</span><span class="p">,</span> <span class="n">Optional</span>
<a href="#__codelineno-2-3" id="__codelineno-2-3" name="__codelineno-2-3"></a><span class="kn">import</span><span class="w"> </span><span class="nn">time</span>
<a href="#__codelineno-2-4" id="__codelineno-2-4" name="__codelineno-2-4"></a>
<a href="#__codelineno-2-5" id="__codelineno-2-5" name="__codelineno-2-5"></a><span class="k">class</span><span class="w"> </span><span class="nc">DistributedTrainer</span><span class="p">:</span>
<a href="#__codelineno-2-6" id="__codelineno-2-6" name="__codelineno-2-6"></a><span class="w">    </span><span class="sd">"""Simulate distributed training for LLMs"""</span>
<a href="#__codelineno-2-7" id="__codelineno-2-7" name="__codelineno-2-7"></a>
<a href="#__codelineno-2-8" id="__codelineno-2-8" name="__codelineno-2-8"></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> 
<a href="#__codelineno-2-9" id="__codelineno-2-9" name="__codelineno-2-9"></a>                 <span class="n">model_params</span><span class="p">:</span> <span class="n">Dict</span><span class="p">,</span>
<a href="#__codelineno-2-10" id="__codelineno-2-10" name="__codelineno-2-10"></a>                 <span class="n">num_gpus</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">8</span><span class="p">,</span>
<a href="#__codelineno-2-11" id="__codelineno-2-11" name="__codelineno-2-11"></a>                 <span class="n">batch_size_per_gpu</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">16</span><span class="p">,</span>
<a href="#__codelineno-2-12" id="__codelineno-2-12" name="__codelineno-2-12"></a>                 <span class="n">gradient_accumulation_steps</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">4</span><span class="p">):</span>
<a href="#__codelineno-2-13" id="__codelineno-2-13" name="__codelineno-2-13"></a>
<a href="#__codelineno-2-14" id="__codelineno-2-14" name="__codelineno-2-14"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">model_params</span> <span class="o">=</span> <span class="n">model_params</span>
<a href="#__codelineno-2-15" id="__codelineno-2-15" name="__codelineno-2-15"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">num_gpus</span> <span class="o">=</span> <span class="n">num_gpus</span>
<a href="#__codelineno-2-16" id="__codelineno-2-16" name="__codelineno-2-16"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">batch_size_per_gpu</span> <span class="o">=</span> <span class="n">batch_size_per_gpu</span>
<a href="#__codelineno-2-17" id="__codelineno-2-17" name="__codelineno-2-17"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">gradient_accumulation_steps</span> <span class="o">=</span> <span class="n">gradient_accumulation_steps</span>
<a href="#__codelineno-2-18" id="__codelineno-2-18" name="__codelineno-2-18"></a>
<a href="#__codelineno-2-19" id="__codelineno-2-19" name="__codelineno-2-19"></a>        <span class="c1"># Effective batch size</span>
<a href="#__codelineno-2-20" id="__codelineno-2-20" name="__codelineno-2-20"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">effective_batch_size</span> <span class="o">=</span> <span class="p">(</span>
<a href="#__codelineno-2-21" id="__codelineno-2-21" name="__codelineno-2-21"></a>            <span class="n">num_gpus</span> <span class="o">*</span> <span class="n">batch_size_per_gpu</span> <span class="o">*</span> <span class="n">gradient_accumulation_steps</span>
<a href="#__codelineno-2-22" id="__codelineno-2-22" name="__codelineno-2-22"></a>        <span class="p">)</span>
<a href="#__codelineno-2-23" id="__codelineno-2-23" name="__codelineno-2-23"></a>
<a href="#__codelineno-2-24" id="__codelineno-2-24" name="__codelineno-2-24"></a>        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"Distributed Training Setup:"</span><span class="p">)</span>
<a href="#__codelineno-2-25" id="__codelineno-2-25" name="__codelineno-2-25"></a>        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"  GPUs: </span><span class="si">{</span><span class="n">num_gpus</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
<a href="#__codelineno-2-26" id="__codelineno-2-26" name="__codelineno-2-26"></a>        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"  Batch size per GPU: </span><span class="si">{</span><span class="n">batch_size_per_gpu</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
<a href="#__codelineno-2-27" id="__codelineno-2-27" name="__codelineno-2-27"></a>        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"  Gradient accumulation steps: </span><span class="si">{</span><span class="n">gradient_accumulation_steps</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
<a href="#__codelineno-2-28" id="__codelineno-2-28" name="__codelineno-2-28"></a>        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"  Effective batch size: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">effective_batch_size</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
<a href="#__codelineno-2-29" id="__codelineno-2-29" name="__codelineno-2-29"></a>
<a href="#__codelineno-2-30" id="__codelineno-2-30" name="__codelineno-2-30"></a>        <span class="c1"># Training state</span>
<a href="#__codelineno-2-31" id="__codelineno-2-31" name="__codelineno-2-31"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">step</span> <span class="o">=</span> <span class="mi">0</span>
<a href="#__codelineno-2-32" id="__codelineno-2-32" name="__codelineno-2-32"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">total_tokens_seen</span> <span class="o">=</span> <span class="mi">0</span>
<a href="#__codelineno-2-33" id="__codelineno-2-33" name="__codelineno-2-33"></a>
<a href="#__codelineno-2-34" id="__codelineno-2-34" name="__codelineno-2-34"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">calculate_loss</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">logits</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">targets</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
<a href="#__codelineno-2-35" id="__codelineno-2-35" name="__codelineno-2-35"></a><span class="w">        </span><span class="sd">"""Calculate cross-entropy loss"""</span>
<a href="#__codelineno-2-36" id="__codelineno-2-36" name="__codelineno-2-36"></a>        <span class="c1"># Simplified cross-entropy calculation</span>
<a href="#__codelineno-2-37" id="__codelineno-2-37" name="__codelineno-2-37"></a>        <span class="n">batch_size</span><span class="p">,</span> <span class="n">seq_len</span><span class="p">,</span> <span class="n">vocab_size</span> <span class="o">=</span> <span class="n">logits</span><span class="o">.</span><span class="n">shape</span>
<a href="#__codelineno-2-38" id="__codelineno-2-38" name="__codelineno-2-38"></a>
<a href="#__codelineno-2-39" id="__codelineno-2-39" name="__codelineno-2-39"></a>        <span class="c1"># Apply softmax to logits</span>
<a href="#__codelineno-2-40" id="__codelineno-2-40" name="__codelineno-2-40"></a>        <span class="n">exp_logits</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">logits</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">logits</span><span class="p">,</span> <span class="n">axis</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span> <span class="n">keepdims</span><span class="o">=</span><span class="kc">True</span><span class="p">))</span>
<a href="#__codelineno-2-41" id="__codelineno-2-41" name="__codelineno-2-41"></a>        <span class="n">probs</span> <span class="o">=</span> <span class="n">exp_logits</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">exp_logits</span><span class="p">,</span> <span class="n">axis</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span> <span class="n">keepdims</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<a href="#__codelineno-2-42" id="__codelineno-2-42" name="__codelineno-2-42"></a>
<a href="#__codelineno-2-43" id="__codelineno-2-43" name="__codelineno-2-43"></a>        <span class="c1"># Calculate cross-entropy</span>
<a href="#__codelineno-2-44" id="__codelineno-2-44" name="__codelineno-2-44"></a>        <span class="n">loss</span> <span class="o">=</span> <span class="mf">0.0</span>
<a href="#__codelineno-2-45" id="__codelineno-2-45" name="__codelineno-2-45"></a>        <span class="n">count</span> <span class="o">=</span> <span class="mi">0</span>
<a href="#__codelineno-2-46" id="__codelineno-2-46" name="__codelineno-2-46"></a>
<a href="#__codelineno-2-47" id="__codelineno-2-47" name="__codelineno-2-47"></a>        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">batch_size</span><span class="p">):</span>
<a href="#__codelineno-2-48" id="__codelineno-2-48" name="__codelineno-2-48"></a>            <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">seq_len</span> <span class="o">-</span> <span class="mi">1</span><span class="p">):</span>  <span class="c1"># Exclude last position</span>
<a href="#__codelineno-2-49" id="__codelineno-2-49" name="__codelineno-2-49"></a>                <span class="n">target_token</span> <span class="o">=</span> <span class="n">targets</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span>  <span class="c1"># Next token prediction</span>
<a href="#__codelineno-2-50" id="__codelineno-2-50" name="__codelineno-2-50"></a>                <span class="k">if</span> <span class="n">target_token</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">:</span>  <span class="c1"># Valid target (not padding)</span>
<a href="#__codelineno-2-51" id="__codelineno-2-51" name="__codelineno-2-51"></a>                    <span class="n">loss</span> <span class="o">+=</span> <span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">probs</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">target_token</span><span class="p">]</span> <span class="o">+</span> <span class="mf">1e-8</span><span class="p">)</span>
<a href="#__codelineno-2-52" id="__codelineno-2-52" name="__codelineno-2-52"></a>                    <span class="n">count</span> <span class="o">+=</span> <span class="mi">1</span>
<a href="#__codelineno-2-53" id="__codelineno-2-53" name="__codelineno-2-53"></a>
<a href="#__codelineno-2-54" id="__codelineno-2-54" name="__codelineno-2-54"></a>        <span class="k">return</span> <span class="n">loss</span> <span class="o">/</span> <span class="n">count</span> <span class="k">if</span> <span class="n">count</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="mf">0.0</span>
<a href="#__codelineno-2-55" id="__codelineno-2-55" name="__codelineno-2-55"></a>
<a href="#__codelineno-2-56" id="__codelineno-2-56" name="__codelineno-2-56"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">training_step</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">batch</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">float</span><span class="p">]:</span>
<a href="#__codelineno-2-57" id="__codelineno-2-57" name="__codelineno-2-57"></a><span class="w">        </span><span class="sd">"""Simulate one training step"""</span>
<a href="#__codelineno-2-58" id="__codelineno-2-58" name="__codelineno-2-58"></a>        <span class="n">input_ids</span> <span class="o">=</span> <span class="n">batch</span><span class="p">[</span><span class="s1">'input_ids'</span><span class="p">]</span>
<a href="#__codelineno-2-59" id="__codelineno-2-59" name="__codelineno-2-59"></a>        <span class="n">attention_mask</span> <span class="o">=</span> <span class="n">batch</span><span class="p">[</span><span class="s1">'attention_mask'</span><span class="p">]</span>
<a href="#__codelineno-2-60" id="__codelineno-2-60" name="__codelineno-2-60"></a>
<a href="#__codelineno-2-61" id="__codelineno-2-61" name="__codelineno-2-61"></a>        <span class="n">batch_size</span><span class="p">,</span> <span class="n">seq_len</span> <span class="o">=</span> <span class="n">input_ids</span><span class="o">.</span><span class="n">shape</span>
<a href="#__codelineno-2-62" id="__codelineno-2-62" name="__codelineno-2-62"></a>        <span class="n">vocab_size</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model_params</span><span class="p">[</span><span class="s1">'vocab_size'</span><span class="p">]</span>
<a href="#__codelineno-2-63" id="__codelineno-2-63" name="__codelineno-2-63"></a>
<a href="#__codelineno-2-64" id="__codelineno-2-64" name="__codelineno-2-64"></a>        <span class="c1"># Simulate forward pass (generate random logits)</span>
<a href="#__codelineno-2-65" id="__codelineno-2-65" name="__codelineno-2-65"></a>        <span class="n">logits</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">randn</span><span class="p">(</span><span class="n">batch_size</span><span class="p">,</span> <span class="n">seq_len</span><span class="p">,</span> <span class="n">vocab_size</span><span class="p">)</span>
<a href="#__codelineno-2-66" id="__codelineno-2-66" name="__codelineno-2-66"></a>
<a href="#__codelineno-2-67" id="__codelineno-2-67" name="__codelineno-2-67"></a>        <span class="c1"># Calculate loss</span>
<a href="#__codelineno-2-68" id="__codelineno-2-68" name="__codelineno-2-68"></a>        <span class="n">loss</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">calculate_loss</span><span class="p">(</span><span class="n">logits</span><span class="p">,</span> <span class="n">input_ids</span><span class="p">)</span>
<a href="#__codelineno-2-69" id="__codelineno-2-69" name="__codelineno-2-69"></a>
<a href="#__codelineno-2-70" id="__codelineno-2-70" name="__codelineno-2-70"></a>        <span class="c1"># Simulate backward pass and parameter updates</span>
<a href="#__codelineno-2-71" id="__codelineno-2-71" name="__codelineno-2-71"></a>        <span class="c1"># In real training, this would involve actual gradient computation</span>
<a href="#__codelineno-2-72" id="__codelineno-2-72" name="__codelineno-2-72"></a>
<a href="#__codelineno-2-73" id="__codelineno-2-73" name="__codelineno-2-73"></a>        <span class="c1"># Update training statistics</span>
<a href="#__codelineno-2-74" id="__codelineno-2-74" name="__codelineno-2-74"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">step</span> <span class="o">+=</span> <span class="mi">1</span>
<a href="#__codelineno-2-75" id="__codelineno-2-75" name="__codelineno-2-75"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">total_tokens_seen</span> <span class="o">+=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">attention_mask</span><span class="p">)</span>
<a href="#__codelineno-2-76" id="__codelineno-2-76" name="__codelineno-2-76"></a>
<a href="#__codelineno-2-77" id="__codelineno-2-77" name="__codelineno-2-77"></a>        <span class="k">return</span> <span class="p">{</span>
<a href="#__codelineno-2-78" id="__codelineno-2-78" name="__codelineno-2-78"></a>            <span class="s1">'loss'</span><span class="p">:</span> <span class="n">loss</span><span class="p">,</span>
<a href="#__codelineno-2-79" id="__codelineno-2-79" name="__codelineno-2-79"></a>            <span class="s1">'learning_rate'</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_learning_rate</span><span class="p">(),</span>
<a href="#__codelineno-2-80" id="__codelineno-2-80" name="__codelineno-2-80"></a>            <span class="s1">'tokens_per_second'</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">calculate_throughput</span><span class="p">(),</span>
<a href="#__codelineno-2-81" id="__codelineno-2-81" name="__codelineno-2-81"></a>            <span class="s1">'step'</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">step</span>
<a href="#__codelineno-2-82" id="__codelineno-2-82" name="__codelineno-2-82"></a>        <span class="p">}</span>
<a href="#__codelineno-2-83" id="__codelineno-2-83" name="__codelineno-2-83"></a>
<a href="#__codelineno-2-84" id="__codelineno-2-84" name="__codelineno-2-84"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">get_learning_rate</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
<a href="#__codelineno-2-85" id="__codelineno-2-85" name="__codelineno-2-85"></a><span class="w">        </span><span class="sd">"""Get current learning rate (with warmup and decay)"""</span>
<a href="#__codelineno-2-86" id="__codelineno-2-86" name="__codelineno-2-86"></a>        <span class="n">warmup_steps</span> <span class="o">=</span> <span class="mi">2000</span>
<a href="#__codelineno-2-87" id="__codelineno-2-87" name="__codelineno-2-87"></a>        <span class="n">max_lr</span> <span class="o">=</span> <span class="mf">6e-4</span>
<a href="#__codelineno-2-88" id="__codelineno-2-88" name="__codelineno-2-88"></a>        <span class="n">min_lr</span> <span class="o">=</span> <span class="mf">6e-5</span>
<a href="#__codelineno-2-89" id="__codelineno-2-89" name="__codelineno-2-89"></a>
<a href="#__codelineno-2-90" id="__codelineno-2-90" name="__codelineno-2-90"></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">step</span> <span class="o">&lt;</span> <span class="n">warmup_steps</span><span class="p">:</span>
<a href="#__codelineno-2-91" id="__codelineno-2-91" name="__codelineno-2-91"></a>            <span class="c1"># Linear warmup</span>
<a href="#__codelineno-2-92" id="__codelineno-2-92" name="__codelineno-2-92"></a>            <span class="k">return</span> <span class="n">max_lr</span> <span class="o">*</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">step</span> <span class="o">/</span> <span class="n">warmup_steps</span><span class="p">)</span>
<a href="#__codelineno-2-93" id="__codelineno-2-93" name="__codelineno-2-93"></a>        <span class="k">else</span><span class="p">:</span>
<a href="#__codelineno-2-94" id="__codelineno-2-94" name="__codelineno-2-94"></a>            <span class="c1"># Cosine decay</span>
<a href="#__codelineno-2-95" id="__codelineno-2-95" name="__codelineno-2-95"></a>            <span class="n">decay_ratio</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">step</span> <span class="o">-</span> <span class="n">warmup_steps</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="mi">100000</span> <span class="o">-</span> <span class="n">warmup_steps</span><span class="p">)</span>
<a href="#__codelineno-2-96" id="__codelineno-2-96" name="__codelineno-2-96"></a>            <span class="n">decay_ratio</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">decay_ratio</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">)</span>
<a href="#__codelineno-2-97" id="__codelineno-2-97" name="__codelineno-2-97"></a>            <span class="k">return</span> <span class="n">min_lr</span> <span class="o">+</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="p">(</span><span class="n">max_lr</span> <span class="o">-</span> <span class="n">min_lr</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">*</span> <span class="n">decay_ratio</span><span class="p">))</span>
<a href="#__codelineno-2-98" id="__codelineno-2-98" name="__codelineno-2-98"></a>
<a href="#__codelineno-2-99" id="__codelineno-2-99" name="__codelineno-2-99"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">calculate_throughput</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
<a href="#__codelineno-2-100" id="__codelineno-2-100" name="__codelineno-2-100"></a><span class="w">        </span><span class="sd">"""Calculate tokens processed per second"""</span>
<a href="#__codelineno-2-101" id="__codelineno-2-101" name="__codelineno-2-101"></a>        <span class="c1"># Simulate throughput calculation</span>
<a href="#__codelineno-2-102" id="__codelineno-2-102" name="__codelineno-2-102"></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">effective_batch_size</span> <span class="o">*</span> <span class="mi">2048</span> <span class="o">*</span> <span class="mf">0.8</span>  <span class="c1"># tokens/second</span>
<a href="#__codelineno-2-103" id="__codelineno-2-103" name="__codelineno-2-103"></a>
<a href="#__codelineno-2-104" id="__codelineno-2-104" name="__codelineno-2-104"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">train_epoch</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dataset</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">],</span> <span class="n">epoch</span><span class="p">:</span> <span class="nb">int</span><span class="p">):</span>
<a href="#__codelineno-2-105" id="__codelineno-2-105" name="__codelineno-2-105"></a><span class="w">        </span><span class="sd">"""Train for one epoch"""</span>
<a href="#__codelineno-2-106" id="__codelineno-2-106" name="__codelineno-2-106"></a>        <span class="n">epoch_losses</span> <span class="o">=</span> <span class="p">[]</span>
<a href="#__codelineno-2-107" id="__codelineno-2-107" name="__codelineno-2-107"></a>        <span class="n">start_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
<a href="#__codelineno-2-108" id="__codelineno-2-108" name="__codelineno-2-108"></a>
<a href="#__codelineno-2-109" id="__codelineno-2-109" name="__codelineno-2-109"></a>        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"</span><span class="se">\n</span><span class="s2">Epoch </span><span class="si">{</span><span class="n">epoch</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
<a href="#__codelineno-2-110" id="__codelineno-2-110" name="__codelineno-2-110"></a>        <span class="nb">print</span><span class="p">(</span><span class="s2">"-"</span> <span class="o">*</span> <span class="mi">50</span><span class="p">)</span>
<a href="#__codelineno-2-111" id="__codelineno-2-111" name="__codelineno-2-111"></a>
<a href="#__codelineno-2-112" id="__codelineno-2-112" name="__codelineno-2-112"></a>        <span class="k">for</span> <span class="n">batch_idx</span><span class="p">,</span> <span class="n">batch</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">dataset</span><span class="p">):</span>
<a href="#__codelineno-2-113" id="__codelineno-2-113" name="__codelineno-2-113"></a>            <span class="c1"># Training step</span>
<a href="#__codelineno-2-114" id="__codelineno-2-114" name="__codelineno-2-114"></a>            <span class="n">step_metrics</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">training_step</span><span class="p">(</span><span class="n">batch</span><span class="p">)</span>
<a href="#__codelineno-2-115" id="__codelineno-2-115" name="__codelineno-2-115"></a>            <span class="n">epoch_losses</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">step_metrics</span><span class="p">[</span><span class="s1">'loss'</span><span class="p">])</span>
<a href="#__codelineno-2-116" id="__codelineno-2-116" name="__codelineno-2-116"></a>
<a href="#__codelineno-2-117" id="__codelineno-2-117" name="__codelineno-2-117"></a>            <span class="c1"># Logging</span>
<a href="#__codelineno-2-118" id="__codelineno-2-118" name="__codelineno-2-118"></a>            <span class="k">if</span> <span class="n">batch_idx</span> <span class="o">%</span> <span class="mi">100</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
<a href="#__codelineno-2-119" id="__codelineno-2-119" name="__codelineno-2-119"></a>                <span class="n">elapsed</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">start_time</span>
<a href="#__codelineno-2-120" id="__codelineno-2-120" name="__codelineno-2-120"></a>                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"Step </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">step</span><span class="si">:</span><span class="s2">6d</span><span class="si">}</span><span class="s2"> | "</span>
<a href="#__codelineno-2-121" id="__codelineno-2-121" name="__codelineno-2-121"></a>                      <span class="sa">f</span><span class="s2">"Loss: </span><span class="si">{</span><span class="n">step_metrics</span><span class="p">[</span><span class="s1">'loss'</span><span class="p">]</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2"> | "</span>
<a href="#__codelineno-2-122" id="__codelineno-2-122" name="__codelineno-2-122"></a>                      <span class="sa">f</span><span class="s2">"LR: </span><span class="si">{</span><span class="n">step_metrics</span><span class="p">[</span><span class="s1">'learning_rate'</span><span class="p">]</span><span class="si">:</span><span class="s2">.2e</span><span class="si">}</span><span class="s2"> | "</span>
<a href="#__codelineno-2-123" id="__codelineno-2-123" name="__codelineno-2-123"></a>                      <span class="sa">f</span><span class="s2">"Tokens/s: </span><span class="si">{</span><span class="n">step_metrics</span><span class="p">[</span><span class="s1">'tokens_per_second'</span><span class="p">]</span><span class="si">:</span><span class="s2">,.0f</span><span class="si">}</span><span class="s2"> | "</span>
<a href="#__codelineno-2-124" id="__codelineno-2-124" name="__codelineno-2-124"></a>                      <span class="sa">f</span><span class="s2">"Time: </span><span class="si">{</span><span class="n">elapsed</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2">s"</span><span class="p">)</span>
<a href="#__codelineno-2-125" id="__codelineno-2-125" name="__codelineno-2-125"></a>
<a href="#__codelineno-2-126" id="__codelineno-2-126" name="__codelineno-2-126"></a>        <span class="n">avg_loss</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">epoch_losses</span><span class="p">)</span>
<a href="#__codelineno-2-127" id="__codelineno-2-127" name="__codelineno-2-127"></a>        <span class="n">total_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">start_time</span>
<a href="#__codelineno-2-128" id="__codelineno-2-128" name="__codelineno-2-128"></a>
<a href="#__codelineno-2-129" id="__codelineno-2-129" name="__codelineno-2-129"></a>        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"Epoch </span><span class="si">{</span><span class="n">epoch</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="si">}</span><span class="s2"> completed:"</span><span class="p">)</span>
<a href="#__codelineno-2-130" id="__codelineno-2-130" name="__codelineno-2-130"></a>        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"  Average Loss: </span><span class="si">{</span><span class="n">avg_loss</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
<a href="#__codelineno-2-131" id="__codelineno-2-131" name="__codelineno-2-131"></a>        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"  Total Time: </span><span class="si">{</span><span class="n">total_time</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2">s"</span><span class="p">)</span>
<a href="#__codelineno-2-132" id="__codelineno-2-132" name="__codelineno-2-132"></a>        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"  Total Tokens Seen: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">total_tokens_seen</span><span class="si">:</span><span class="s2">,</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
<a href="#__codelineno-2-133" id="__codelineno-2-133" name="__codelineno-2-133"></a>
<a href="#__codelineno-2-134" id="__codelineno-2-134" name="__codelineno-2-134"></a>        <span class="k">return</span> <span class="n">avg_loss</span>
<a href="#__codelineno-2-135" id="__codelineno-2-135" name="__codelineno-2-135"></a>
<a href="#__codelineno-2-136" id="__codelineno-2-136" name="__codelineno-2-136"></a><span class="c1"># Simulate training</span>
<a href="#__codelineno-2-137" id="__codelineno-2-137" name="__codelineno-2-137"></a><span class="n">model_config</span> <span class="o">=</span> <span class="p">{</span>
<a href="#__codelineno-2-138" id="__codelineno-2-138" name="__codelineno-2-138"></a>    <span class="s1">'vocab_size'</span><span class="p">:</span> <span class="mi">50000</span><span class="p">,</span>
<a href="#__codelineno-2-139" id="__codelineno-2-139" name="__codelineno-2-139"></a>    <span class="s1">'d_model'</span><span class="p">:</span> <span class="mi">768</span><span class="p">,</span>
<a href="#__codelineno-2-140" id="__codelineno-2-140" name="__codelineno-2-140"></a>    <span class="s1">'num_layers'</span><span class="p">:</span> <span class="mi">12</span><span class="p">,</span>
<a href="#__codelineno-2-141" id="__codelineno-2-141" name="__codelineno-2-141"></a>    <span class="s1">'num_heads'</span><span class="p">:</span> <span class="mi">12</span>
<a href="#__codelineno-2-142" id="__codelineno-2-142" name="__codelineno-2-142"></a><span class="p">}</span>
<a href="#__codelineno-2-143" id="__codelineno-2-143" name="__codelineno-2-143"></a>
<a href="#__codelineno-2-144" id="__codelineno-2-144" name="__codelineno-2-144"></a><span class="n">trainer</span> <span class="o">=</span> <span class="n">DistributedTrainer</span><span class="p">(</span><span class="n">model_config</span><span class="p">)</span>
<a href="#__codelineno-2-145" id="__codelineno-2-145" name="__codelineno-2-145"></a>
<a href="#__codelineno-2-146" id="__codelineno-2-146" name="__codelineno-2-146"></a><span class="c1"># Create dummy dataset</span>
<a href="#__codelineno-2-147" id="__codelineno-2-147" name="__codelineno-2-147"></a><span class="n">dummy_dataset</span> <span class="o">=</span> <span class="p">[]</span>
<a href="#__codelineno-2-148" id="__codelineno-2-148" name="__codelineno-2-148"></a><span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1000</span><span class="p">):</span>  <span class="c1"># 1000 batches</span>
<a href="#__codelineno-2-149" id="__codelineno-2-149" name="__codelineno-2-149"></a>    <span class="n">batch</span> <span class="o">=</span> <span class="p">{</span>
<a href="#__codelineno-2-150" id="__codelineno-2-150" name="__codelineno-2-150"></a>        <span class="s1">'input_ids'</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">randint</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">50000</span><span class="p">,</span> <span class="p">(</span><span class="mi">16</span><span class="p">,</span> <span class="mi">2048</span><span class="p">)),</span>
<a href="#__codelineno-2-151" id="__codelineno-2-151" name="__codelineno-2-151"></a>        <span class="s1">'attention_mask'</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">((</span><span class="mi">16</span><span class="p">,</span> <span class="mi">2048</span><span class="p">))</span>
<a href="#__codelineno-2-152" id="__codelineno-2-152" name="__codelineno-2-152"></a>    <span class="p">}</span>
<a href="#__codelineno-2-153" id="__codelineno-2-153" name="__codelineno-2-153"></a>    <span class="n">dummy_dataset</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">batch</span><span class="p">)</span>
<a href="#__codelineno-2-154" id="__codelineno-2-154" name="__codelineno-2-154"></a>
<a href="#__codelineno-2-155" id="__codelineno-2-155" name="__codelineno-2-155"></a><span class="c1"># Train for a few steps</span>
<a href="#__codelineno-2-156" id="__codelineno-2-156" name="__codelineno-2-156"></a><span class="k">for</span> <span class="n">epoch</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">2</span><span class="p">):</span>
<a href="#__codelineno-2-157" id="__codelineno-2-157" name="__codelineno-2-157"></a>    <span class="n">avg_loss</span> <span class="o">=</span> <span class="n">trainer</span><span class="o">.</span><span class="n">train_epoch</span><span class="p">(</span><span class="n">dummy_dataset</span><span class="p">[:</span><span class="mi">10</span><span class="p">],</span> <span class="n">epoch</span><span class="p">)</span>  <span class="c1"># Just 10 batches for demo</span>
</code></pre></div></p>
<h3 id="training-objectives-and-loss-functions">Training Objectives and Loss Functions</h3>
<p><strong>Language Modeling Loss</strong>:
<div class="highlight"><pre><span></span><code><a href="#__codelineno-3-1" id="__codelineno-3-1" name="__codelineno-3-1"></a><span class="k">class</span><span class="w"> </span><span class="nc">LanguageModelingLoss</span><span class="p">:</span>
<a href="#__codelineno-3-2" id="__codelineno-3-2" name="__codelineno-3-2"></a><span class="w">    </span><span class="sd">"""Various loss functions for language model training"""</span>
<a href="#__codelineno-3-3" id="__codelineno-3-3" name="__codelineno-3-3"></a>
<a href="#__codelineno-3-4" id="__codelineno-3-4" name="__codelineno-3-4"></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">vocab_size</span><span class="p">:</span> <span class="nb">int</span><span class="p">):</span>
<a href="#__codelineno-3-5" id="__codelineno-3-5" name="__codelineno-3-5"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">vocab_size</span> <span class="o">=</span> <span class="n">vocab_size</span>
<a href="#__codelineno-3-6" id="__codelineno-3-6" name="__codelineno-3-6"></a>
<a href="#__codelineno-3-7" id="__codelineno-3-7" name="__codelineno-3-7"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">cross_entropy_loss</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">logits</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">targets</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> 
<a href="#__codelineno-3-8" id="__codelineno-3-8" name="__codelineno-3-8"></a>                          <span class="n">ignore_index</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="o">-</span><span class="mi">100</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
<a href="#__codelineno-3-9" id="__codelineno-3-9" name="__codelineno-3-9"></a><span class="w">        </span><span class="sd">"""Standard cross-entropy loss for next-token prediction"""</span>
<a href="#__codelineno-3-10" id="__codelineno-3-10" name="__codelineno-3-10"></a>        <span class="n">batch_size</span><span class="p">,</span> <span class="n">seq_len</span><span class="p">,</span> <span class="n">vocab_size</span> <span class="o">=</span> <span class="n">logits</span><span class="o">.</span><span class="n">shape</span>
<a href="#__codelineno-3-11" id="__codelineno-3-11" name="__codelineno-3-11"></a>
<a href="#__codelineno-3-12" id="__codelineno-3-12" name="__codelineno-3-12"></a>        <span class="c1"># Shift targets for next-token prediction</span>
<a href="#__codelineno-3-13" id="__codelineno-3-13" name="__codelineno-3-13"></a>        <span class="n">shifted_targets</span> <span class="o">=</span> <span class="n">targets</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">:]</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>  <span class="c1"># Remove first token</span>
<a href="#__codelineno-3-14" id="__codelineno-3-14" name="__codelineno-3-14"></a>        <span class="n">shifted_logits</span> <span class="o">=</span> <span class="n">logits</span><span class="p">[:,</span> <span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="p">:]</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">vocab_size</span><span class="p">)</span>  <span class="c1"># Remove last position</span>
<a href="#__codelineno-3-15" id="__codelineno-3-15" name="__codelineno-3-15"></a>
<a href="#__codelineno-3-16" id="__codelineno-3-16" name="__codelineno-3-16"></a>        <span class="c1"># Apply softmax</span>
<a href="#__codelineno-3-17" id="__codelineno-3-17" name="__codelineno-3-17"></a>        <span class="n">max_logits</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">shifted_logits</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">keepdims</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<a href="#__codelineno-3-18" id="__codelineno-3-18" name="__codelineno-3-18"></a>        <span class="n">exp_logits</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">shifted_logits</span> <span class="o">-</span> <span class="n">max_logits</span><span class="p">)</span>
<a href="#__codelineno-3-19" id="__codelineno-3-19" name="__codelineno-3-19"></a>        <span class="n">probs</span> <span class="o">=</span> <span class="n">exp_logits</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">exp_logits</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">keepdims</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<a href="#__codelineno-3-20" id="__codelineno-3-20" name="__codelineno-3-20"></a>
<a href="#__codelineno-3-21" id="__codelineno-3-21" name="__codelineno-3-21"></a>        <span class="c1"># Calculate loss</span>
<a href="#__codelineno-3-22" id="__codelineno-3-22" name="__codelineno-3-22"></a>        <span class="n">total_loss</span> <span class="o">=</span> <span class="mf">0.0</span>
<a href="#__codelineno-3-23" id="__codelineno-3-23" name="__codelineno-3-23"></a>        <span class="n">valid_tokens</span> <span class="o">=</span> <span class="mi">0</span>
<a href="#__codelineno-3-24" id="__codelineno-3-24" name="__codelineno-3-24"></a>
<a href="#__codelineno-3-25" id="__codelineno-3-25" name="__codelineno-3-25"></a>        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">shifted_targets</span><span class="p">)):</span>
<a href="#__codelineno-3-26" id="__codelineno-3-26" name="__codelineno-3-26"></a>            <span class="k">if</span> <span class="n">shifted_targets</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">!=</span> <span class="n">ignore_index</span><span class="p">:</span>
<a href="#__codelineno-3-27" id="__codelineno-3-27" name="__codelineno-3-27"></a>                <span class="n">token_prob</span> <span class="o">=</span> <span class="n">probs</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">shifted_targets</span><span class="p">[</span><span class="n">i</span><span class="p">]]</span>
<a href="#__codelineno-3-28" id="__codelineno-3-28" name="__codelineno-3-28"></a>                <span class="n">total_loss</span> <span class="o">+=</span> <span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">token_prob</span> <span class="o">+</span> <span class="mf">1e-8</span><span class="p">)</span>
<a href="#__codelineno-3-29" id="__codelineno-3-29" name="__codelineno-3-29"></a>                <span class="n">valid_tokens</span> <span class="o">+=</span> <span class="mi">1</span>
<a href="#__codelineno-3-30" id="__codelineno-3-30" name="__codelineno-3-30"></a>
<a href="#__codelineno-3-31" id="__codelineno-3-31" name="__codelineno-3-31"></a>        <span class="k">return</span> <span class="n">total_loss</span> <span class="o">/</span> <span class="n">valid_tokens</span> <span class="k">if</span> <span class="n">valid_tokens</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="mf">0.0</span>
<a href="#__codelineno-3-32" id="__codelineno-3-32" name="__codelineno-3-32"></a>
<a href="#__codelineno-3-33" id="__codelineno-3-33" name="__codelineno-3-33"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">perplexity</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">logits</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">targets</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
<a href="#__codelineno-3-34" id="__codelineno-3-34" name="__codelineno-3-34"></a><span class="w">        </span><span class="sd">"""Calculate perplexity metric"""</span>
<a href="#__codelineno-3-35" id="__codelineno-3-35" name="__codelineno-3-35"></a>        <span class="n">loss</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cross_entropy_loss</span><span class="p">(</span><span class="n">logits</span><span class="p">,</span> <span class="n">targets</span><span class="p">)</span>
<a href="#__codelineno-3-36" id="__codelineno-3-36" name="__codelineno-3-36"></a>        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">loss</span><span class="p">)</span>
<a href="#__codelineno-3-37" id="__codelineno-3-37" name="__codelineno-3-37"></a>
<a href="#__codelineno-3-38" id="__codelineno-3-38" name="__codelineno-3-38"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">prefix_lm_loss</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">logits</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">targets</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> 
<a href="#__codelineno-3-39" id="__codelineno-3-39" name="__codelineno-3-39"></a>                      <span class="n">prefix_length</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
<a href="#__codelineno-3-40" id="__codelineno-3-40" name="__codelineno-3-40"></a><span class="w">        </span><span class="sd">"""Prefix language modeling loss (like T5)"""</span>
<a href="#__codelineno-3-41" id="__codelineno-3-41" name="__codelineno-3-41"></a>        <span class="c1"># Only compute loss on non-prefix tokens</span>
<a href="#__codelineno-3-42" id="__codelineno-3-42" name="__codelineno-3-42"></a>        <span class="n">suffix_logits</span> <span class="o">=</span> <span class="n">logits</span><span class="p">[:,</span> <span class="n">prefix_length</span><span class="p">:,</span> <span class="p">:]</span>
<a href="#__codelineno-3-43" id="__codelineno-3-43" name="__codelineno-3-43"></a>        <span class="n">suffix_targets</span> <span class="o">=</span> <span class="n">targets</span><span class="p">[:,</span> <span class="n">prefix_length</span><span class="p">:]</span>
<a href="#__codelineno-3-44" id="__codelineno-3-44" name="__codelineno-3-44"></a>
<a href="#__codelineno-3-45" id="__codelineno-3-45" name="__codelineno-3-45"></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">cross_entropy_loss</span><span class="p">(</span><span class="n">suffix_logits</span><span class="p">,</span> <span class="n">suffix_targets</span><span class="p">)</span>
<a href="#__codelineno-3-46" id="__codelineno-3-46" name="__codelineno-3-46"></a>
<a href="#__codelineno-3-47" id="__codelineno-3-47" name="__codelineno-3-47"></a><span class="c1"># Training monitoring</span>
<a href="#__codelineno-3-48" id="__codelineno-3-48" name="__codelineno-3-48"></a><span class="k">class</span><span class="w"> </span><span class="nc">TrainingMonitor</span><span class="p">:</span>
<a href="#__codelineno-3-49" id="__codelineno-3-49" name="__codelineno-3-49"></a><span class="w">    </span><span class="sd">"""Monitor training progress and metrics"""</span>
<a href="#__codelineno-3-50" id="__codelineno-3-50" name="__codelineno-3-50"></a>
<a href="#__codelineno-3-51" id="__codelineno-3-51" name="__codelineno-3-51"></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<a href="#__codelineno-3-52" id="__codelineno-3-52" name="__codelineno-3-52"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">metrics_history</span> <span class="o">=</span> <span class="p">{</span>
<a href="#__codelineno-3-53" id="__codelineno-3-53" name="__codelineno-3-53"></a>            <span class="s1">'loss'</span><span class="p">:</span> <span class="p">[],</span>
<a href="#__codelineno-3-54" id="__codelineno-3-54" name="__codelineno-3-54"></a>            <span class="s1">'perplexity'</span><span class="p">:</span> <span class="p">[],</span>
<a href="#__codelineno-3-55" id="__codelineno-3-55" name="__codelineno-3-55"></a>            <span class="s1">'learning_rate'</span><span class="p">:</span> <span class="p">[],</span>
<a href="#__codelineno-3-56" id="__codelineno-3-56" name="__codelineno-3-56"></a>            <span class="s1">'tokens_per_second'</span><span class="p">:</span> <span class="p">[],</span>
<a href="#__codelineno-3-57" id="__codelineno-3-57" name="__codelineno-3-57"></a>            <span class="s1">'gradient_norm'</span><span class="p">:</span> <span class="p">[]</span>
<a href="#__codelineno-3-58" id="__codelineno-3-58" name="__codelineno-3-58"></a>        <span class="p">}</span>
<a href="#__codelineno-3-59" id="__codelineno-3-59" name="__codelineno-3-59"></a>
<a href="#__codelineno-3-60" id="__codelineno-3-60" name="__codelineno-3-60"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">log_metrics</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">step</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">metrics</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">float</span><span class="p">]):</span>
<a href="#__codelineno-3-61" id="__codelineno-3-61" name="__codelineno-3-61"></a><span class="w">        </span><span class="sd">"""Log training metrics"""</span>
<a href="#__codelineno-3-62" id="__codelineno-3-62" name="__codelineno-3-62"></a>        <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">metrics</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
<a href="#__codelineno-3-63" id="__codelineno-3-63" name="__codelineno-3-63"></a>            <span class="k">if</span> <span class="n">key</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">metrics_history</span><span class="p">:</span>
<a href="#__codelineno-3-64" id="__codelineno-3-64" name="__codelineno-3-64"></a>                <span class="bp">self</span><span class="o">.</span><span class="n">metrics_history</span><span class="p">[</span><span class="n">key</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
<a href="#__codelineno-3-65" id="__codelineno-3-65" name="__codelineno-3-65"></a>
<a href="#__codelineno-3-66" id="__codelineno-3-66" name="__codelineno-3-66"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">plot_training_curves</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<a href="#__codelineno-3-67" id="__codelineno-3-67" name="__codelineno-3-67"></a><span class="w">        </span><span class="sd">"""Plot training progress"""</span>
<a href="#__codelineno-3-68" id="__codelineno-3-68" name="__codelineno-3-68"></a>        <span class="kn">import</span><span class="w"> </span><span class="nn">matplotlib.pyplot</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">plt</span>
<a href="#__codelineno-3-69" id="__codelineno-3-69" name="__codelineno-3-69"></a>
<a href="#__codelineno-3-70" id="__codelineno-3-70" name="__codelineno-3-70"></a>        <span class="n">fig</span><span class="p">,</span> <span class="n">axes</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span> <span class="mi">8</span><span class="p">))</span>
<a href="#__codelineno-3-71" id="__codelineno-3-71" name="__codelineno-3-71"></a>
<a href="#__codelineno-3-72" id="__codelineno-3-72" name="__codelineno-3-72"></a>        <span class="c1"># Loss curve</span>
<a href="#__codelineno-3-73" id="__codelineno-3-73" name="__codelineno-3-73"></a>        <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">metrics_history</span><span class="p">[</span><span class="s1">'loss'</span><span class="p">])</span>
<a href="#__codelineno-3-74" id="__codelineno-3-74" name="__codelineno-3-74"></a>        <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">'Training Loss'</span><span class="p">)</span>
<a href="#__codelineno-3-75" id="__codelineno-3-75" name="__codelineno-3-75"></a>        <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">'Cross-Entropy Loss'</span><span class="p">)</span>
<a href="#__codelineno-3-76" id="__codelineno-3-76" name="__codelineno-3-76"></a>
<a href="#__codelineno-3-77" id="__codelineno-3-77" name="__codelineno-3-77"></a>        <span class="c1"># Perplexity curve</span>
<a href="#__codelineno-3-78" id="__codelineno-3-78" name="__codelineno-3-78"></a>        <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">metrics_history</span><span class="p">[</span><span class="s1">'perplexity'</span><span class="p">])</span>
<a href="#__codelineno-3-79" id="__codelineno-3-79" name="__codelineno-3-79"></a>        <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">'Perplexity'</span><span class="p">)</span>
<a href="#__codelineno-3-80" id="__codelineno-3-80" name="__codelineno-3-80"></a>        <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">'Perplexity'</span><span class="p">)</span>
<a href="#__codelineno-3-81" id="__codelineno-3-81" name="__codelineno-3-81"></a>
<a href="#__codelineno-3-82" id="__codelineno-3-82" name="__codelineno-3-82"></a>        <span class="c1"># Learning rate schedule</span>
<a href="#__codelineno-3-83" id="__codelineno-3-83" name="__codelineno-3-83"></a>        <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">metrics_history</span><span class="p">[</span><span class="s1">'learning_rate'</span><span class="p">])</span>
<a href="#__codelineno-3-84" id="__codelineno-3-84" name="__codelineno-3-84"></a>        <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">'Learning Rate Schedule'</span><span class="p">)</span>
<a href="#__codelineno-3-85" id="__codelineno-3-85" name="__codelineno-3-85"></a>        <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">'Learning Rate'</span><span class="p">)</span>
<a href="#__codelineno-3-86" id="__codelineno-3-86" name="__codelineno-3-86"></a>
<a href="#__codelineno-3-87" id="__codelineno-3-87" name="__codelineno-3-87"></a>        <span class="c1"># Throughput</span>
<a href="#__codelineno-3-88" id="__codelineno-3-88" name="__codelineno-3-88"></a>        <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">metrics_history</span><span class="p">[</span><span class="s1">'tokens_per_second'</span><span class="p">])</span>
<a href="#__codelineno-3-89" id="__codelineno-3-89" name="__codelineno-3-89"></a>        <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">'Training Throughput'</span><span class="p">)</span>
<a href="#__codelineno-3-90" id="__codelineno-3-90" name="__codelineno-3-90"></a>        <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">'Tokens/Second'</span><span class="p">)</span>
<a href="#__codelineno-3-91" id="__codelineno-3-91" name="__codelineno-3-91"></a>
<a href="#__codelineno-3-92" id="__codelineno-3-92" name="__codelineno-3-92"></a>        <span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
<a href="#__codelineno-3-93" id="__codelineno-3-93" name="__codelineno-3-93"></a>        <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
<a href="#__codelineno-3-94" id="__codelineno-3-94" name="__codelineno-3-94"></a>
<a href="#__codelineno-3-95" id="__codelineno-3-95" name="__codelineno-3-95"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">get_training_summary</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">float</span><span class="p">]:</span>
<a href="#__codelineno-3-96" id="__codelineno-3-96" name="__codelineno-3-96"></a><span class="w">        </span><span class="sd">"""Get summary statistics"""</span>
<a href="#__codelineno-3-97" id="__codelineno-3-97" name="__codelineno-3-97"></a>        <span class="k">return</span> <span class="p">{</span>
<a href="#__codelineno-3-98" id="__codelineno-3-98" name="__codelineno-3-98"></a>            <span class="s1">'final_loss'</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">metrics_history</span><span class="p">[</span><span class="s1">'loss'</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">metrics_history</span><span class="p">[</span><span class="s1">'loss'</span><span class="p">]</span> <span class="k">else</span> <span class="mi">0</span><span class="p">,</span>
<a href="#__codelineno-3-99" id="__codelineno-3-99" name="__codelineno-3-99"></a>            <span class="s1">'best_loss'</span><span class="p">:</span> <span class="nb">min</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">metrics_history</span><span class="p">[</span><span class="s1">'loss'</span><span class="p">])</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">metrics_history</span><span class="p">[</span><span class="s1">'loss'</span><span class="p">]</span> <span class="k">else</span> <span class="mi">0</span><span class="p">,</span>
<a href="#__codelineno-3-100" id="__codelineno-3-100" name="__codelineno-3-100"></a>            <span class="s1">'avg_throughput'</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">metrics_history</span><span class="p">[</span><span class="s1">'tokens_per_second'</span><span class="p">])</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">metrics_history</span><span class="p">[</span><span class="s1">'tokens_per_second'</span><span class="p">]</span> <span class="k">else</span> <span class="mi">0</span>
<a href="#__codelineno-3-101" id="__codelineno-3-101" name="__codelineno-3-101"></a>        <span class="p">}</span>
</code></pre></div></p>
<h2 id="supervised-fine-tuning-sft">🎯 Supervised Fine-tuning (SFT)</h2>
<h3 id="instruction-following-training">Instruction Following Training</h3>
<p><strong>Creating Instruction Datasets</strong>:
<div class="highlight"><pre><span></span><code><a href="#__codelineno-4-1" id="__codelineno-4-1" name="__codelineno-4-1"></a><span class="k">class</span><span class="w"> </span><span class="nc">InstructionDataset</span><span class="p">:</span>
<a href="#__codelineno-4-2" id="__codelineno-4-2" name="__codelineno-4-2"></a><span class="w">    </span><span class="sd">"""Generate and format instruction-following data"""</span>
<a href="#__codelineno-4-3" id="__codelineno-4-3" name="__codelineno-4-3"></a>
<a href="#__codelineno-4-4" id="__codelineno-4-4" name="__codelineno-4-4"></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<a href="#__codelineno-4-5" id="__codelineno-4-5" name="__codelineno-4-5"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">instruction_templates</span> <span class="o">=</span> <span class="p">[</span>
<a href="#__codelineno-4-6" id="__codelineno-4-6" name="__codelineno-4-6"></a>            <span class="s2">"Write a </span><span class="si">{type}</span><span class="s2"> about </span><span class="si">{topic}</span><span class="s2">"</span><span class="p">,</span>
<a href="#__codelineno-4-7" id="__codelineno-4-7" name="__codelineno-4-7"></a>            <span class="s2">"Explain </span><span class="si">{concept}</span><span class="s2"> in simple terms"</span><span class="p">,</span>
<a href="#__codelineno-4-8" id="__codelineno-4-8" name="__codelineno-4-8"></a>            <span class="s2">"Summarize the following text: </span><span class="si">{text}</span><span class="s2">"</span><span class="p">,</span>
<a href="#__codelineno-4-9" id="__codelineno-4-9" name="__codelineno-4-9"></a>            <span class="s2">"Translate the following </span><span class="si">{source_lang}</span><span class="s2"> text to </span><span class="si">{target_lang}</span><span class="s2">: </span><span class="si">{text}</span><span class="s2">"</span><span class="p">,</span>
<a href="#__codelineno-4-10" id="__codelineno-4-10" name="__codelineno-4-10"></a>            <span class="s2">"Answer the following question: </span><span class="si">{question}</span><span class="s2">"</span>
<a href="#__codelineno-4-11" id="__codelineno-4-11" name="__codelineno-4-11"></a>        <span class="p">]</span>
<a href="#__codelineno-4-12" id="__codelineno-4-12" name="__codelineno-4-12"></a>
<a href="#__codelineno-4-13" id="__codelineno-4-13" name="__codelineno-4-13"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">generate_instruction_examples</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]]:</span>
<a href="#__codelineno-4-14" id="__codelineno-4-14" name="__codelineno-4-14"></a><span class="w">        </span><span class="sd">"""Generate instruction-following examples"""</span>
<a href="#__codelineno-4-15" id="__codelineno-4-15" name="__codelineno-4-15"></a>        <span class="n">examples</span> <span class="o">=</span> <span class="p">[]</span>
<a href="#__codelineno-4-16" id="__codelineno-4-16" name="__codelineno-4-16"></a>
<a href="#__codelineno-4-17" id="__codelineno-4-17" name="__codelineno-4-17"></a>        <span class="c1"># Writing tasks</span>
<a href="#__codelineno-4-18" id="__codelineno-4-18" name="__codelineno-4-18"></a>        <span class="n">examples</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
<a href="#__codelineno-4-19" id="__codelineno-4-19" name="__codelineno-4-19"></a>            <span class="s1">'instruction'</span><span class="p">:</span> <span class="s1">'Write a short story about a robot learning emotions'</span><span class="p">,</span>
<a href="#__codelineno-4-20" id="__codelineno-4-20" name="__codelineno-4-20"></a>            <span class="s1">'input'</span><span class="p">:</span> <span class="s1">''</span><span class="p">,</span>
<a href="#__codelineno-4-21" id="__codelineno-4-21" name="__codelineno-4-21"></a>            <span class="s1">'output'</span><span class="p">:</span> <span class="s1">'In a lab filled with blinking lights, Unit-7 processed its first smile. The expression felt foreign, stretching actuators in unfamiliar ways. But as its creator laughed with joy, something new sparked in Unit-7</span><span class="se">\'</span><span class="s1">s neural networks—not just recognition, but resonance. For the first time, the robot understood that emotions weren</span><span class="se">\'</span><span class="s1">t just data patterns, but bridges connecting one consciousness to another.'</span>
<a href="#__codelineno-4-22" id="__codelineno-4-22" name="__codelineno-4-22"></a>        <span class="p">})</span>
<a href="#__codelineno-4-23" id="__codelineno-4-23" name="__codelineno-4-23"></a>
<a href="#__codelineno-4-24" id="__codelineno-4-24" name="__codelineno-4-24"></a>        <span class="c1"># Explanation tasks  </span>
<a href="#__codelineno-4-25" id="__codelineno-4-25" name="__codelineno-4-25"></a>        <span class="n">examples</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
<a href="#__codelineno-4-26" id="__codelineno-4-26" name="__codelineno-4-26"></a>            <span class="s1">'instruction'</span><span class="p">:</span> <span class="s1">'Explain machine learning in simple terms'</span><span class="p">,</span>
<a href="#__codelineno-4-27" id="__codelineno-4-27" name="__codelineno-4-27"></a>            <span class="s1">'input'</span><span class="p">:</span> <span class="s1">''</span><span class="p">,</span>
<a href="#__codelineno-4-28" id="__codelineno-4-28" name="__codelineno-4-28"></a>            <span class="s1">'output'</span><span class="p">:</span> <span class="s1">'Machine learning is like teaching a computer to recognize patterns, similar to how a child learns to identify animals. Instead of programming specific rules, we show the computer many examples (like thousands of cat photos) so it can learn to identify cats on its own. The more examples it sees, the better it becomes at making predictions about new, unseen data.'</span>
<a href="#__codelineno-4-29" id="__codelineno-4-29" name="__codelineno-4-29"></a>        <span class="p">})</span>
<a href="#__codelineno-4-30" id="__codelineno-4-30" name="__codelineno-4-30"></a>
<a href="#__codelineno-4-31" id="__codelineno-4-31" name="__codelineno-4-31"></a>        <span class="c1"># Q&amp;A tasks</span>
<a href="#__codelineno-4-32" id="__codelineno-4-32" name="__codelineno-4-32"></a>        <span class="n">examples</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
<a href="#__codelineno-4-33" id="__codelineno-4-33" name="__codelineno-4-33"></a>            <span class="s1">'instruction'</span><span class="p">:</span> <span class="s1">'Answer the following question'</span><span class="p">,</span>
<a href="#__codelineno-4-34" id="__codelineno-4-34" name="__codelineno-4-34"></a>            <span class="s1">'input'</span><span class="p">:</span> <span class="s1">'What causes seasons on Earth?'</span><span class="p">,</span>
<a href="#__codelineno-4-35" id="__codelineno-4-35" name="__codelineno-4-35"></a>            <span class="s1">'output'</span><span class="p">:</span> <span class="s1">'Seasons are caused by Earth</span><span class="se">\'</span><span class="s1">s tilted axis as it orbits the Sun. Earth is tilted at about 23.5 degrees, so different parts of the planet receive varying amounts of direct sunlight throughout the year. When your hemisphere tilts toward the Sun, you experience summer with longer days and more direct sunlight. When it tilts away, you get winter with shorter days and less direct sunlight.'</span>
<a href="#__codelineno-4-36" id="__codelineno-4-36" name="__codelineno-4-36"></a>        <span class="p">})</span>
<a href="#__codelineno-4-37" id="__codelineno-4-37" name="__codelineno-4-37"></a>
<a href="#__codelineno-4-38" id="__codelineno-4-38" name="__codelineno-4-38"></a>        <span class="k">return</span> <span class="n">examples</span>
<a href="#__codelineno-4-39" id="__codelineno-4-39" name="__codelineno-4-39"></a>
<a href="#__codelineno-4-40" id="__codelineno-4-40" name="__codelineno-4-40"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">format_for_training</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">examples</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]])</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
<a href="#__codelineno-4-41" id="__codelineno-4-41" name="__codelineno-4-41"></a><span class="w">        </span><span class="sd">"""Format examples for training"""</span>
<a href="#__codelineno-4-42" id="__codelineno-4-42" name="__codelineno-4-42"></a>        <span class="n">formatted</span> <span class="o">=</span> <span class="p">[]</span>
<a href="#__codelineno-4-43" id="__codelineno-4-43" name="__codelineno-4-43"></a>
<a href="#__codelineno-4-44" id="__codelineno-4-44" name="__codelineno-4-44"></a>        <span class="k">for</span> <span class="n">example</span> <span class="ow">in</span> <span class="n">examples</span><span class="p">:</span>
<a href="#__codelineno-4-45" id="__codelineno-4-45" name="__codelineno-4-45"></a>            <span class="k">if</span> <span class="n">example</span><span class="p">[</span><span class="s1">'input'</span><span class="p">]:</span>
<a href="#__codelineno-4-46" id="__codelineno-4-46" name="__codelineno-4-46"></a>                <span class="c1"># With input context</span>
<a href="#__codelineno-4-47" id="__codelineno-4-47" name="__codelineno-4-47"></a>                <span class="n">text</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">"### Instruction:</span><span class="se">\n</span><span class="si">{</span><span class="n">example</span><span class="p">[</span><span class="s1">'instruction'</span><span class="p">]</span><span class="si">}</span><span class="se">\n\n</span><span class="s2">### Input:</span><span class="se">\n</span><span class="si">{</span><span class="n">example</span><span class="p">[</span><span class="s1">'input'</span><span class="p">]</span><span class="si">}</span><span class="se">\n\n</span><span class="s2">### Response:</span><span class="se">\n</span><span class="si">{</span><span class="n">example</span><span class="p">[</span><span class="s1">'output'</span><span class="p">]</span><span class="si">}</span><span class="s2">"</span>
<a href="#__codelineno-4-48" id="__codelineno-4-48" name="__codelineno-4-48"></a>            <span class="k">else</span><span class="p">:</span>
<a href="#__codelineno-4-49" id="__codelineno-4-49" name="__codelineno-4-49"></a>                <span class="c1"># Without input context</span>
<a href="#__codelineno-4-50" id="__codelineno-4-50" name="__codelineno-4-50"></a>                <span class="n">text</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">"### Instruction:</span><span class="se">\n</span><span class="si">{</span><span class="n">example</span><span class="p">[</span><span class="s1">'instruction'</span><span class="p">]</span><span class="si">}</span><span class="se">\n\n</span><span class="s2">### Response:</span><span class="se">\n</span><span class="si">{</span><span class="n">example</span><span class="p">[</span><span class="s1">'output'</span><span class="p">]</span><span class="si">}</span><span class="s2">"</span>
<a href="#__codelineno-4-51" id="__codelineno-4-51" name="__codelineno-4-51"></a>
<a href="#__codelineno-4-52" id="__codelineno-4-52" name="__codelineno-4-52"></a>            <span class="n">formatted</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">text</span><span class="p">)</span>
<a href="#__codelineno-4-53" id="__codelineno-4-53" name="__codelineno-4-53"></a>
<a href="#__codelineno-4-54" id="__codelineno-4-54" name="__codelineno-4-54"></a>        <span class="k">return</span> <span class="n">formatted</span>
<a href="#__codelineno-4-55" id="__codelineno-4-55" name="__codelineno-4-55"></a>
<a href="#__codelineno-4-56" id="__codelineno-4-56" name="__codelineno-4-56"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">create_training_data</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">examples</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]],</span> 
<a href="#__codelineno-4-57" id="__codelineno-4-57" name="__codelineno-4-57"></a>                           <span class="n">tokenizer</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">]]:</span>
<a href="#__codelineno-4-58" id="__codelineno-4-58" name="__codelineno-4-58"></a><span class="w">        </span><span class="sd">"""Create tokenized training data"""</span>
<a href="#__codelineno-4-59" id="__codelineno-4-59" name="__codelineno-4-59"></a>        <span class="n">training_data</span> <span class="o">=</span> <span class="p">[]</span>
<a href="#__codelineno-4-60" id="__codelineno-4-60" name="__codelineno-4-60"></a>
<a href="#__codelineno-4-61" id="__codelineno-4-61" name="__codelineno-4-61"></a>        <span class="k">for</span> <span class="n">example</span> <span class="ow">in</span> <span class="n">examples</span><span class="p">:</span>
<a href="#__codelineno-4-62" id="__codelineno-4-62" name="__codelineno-4-62"></a>            <span class="n">formatted_text</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">format_for_training</span><span class="p">([</span><span class="n">example</span><span class="p">])[</span><span class="mi">0</span><span class="p">]</span>
<a href="#__codelineno-4-63" id="__codelineno-4-63" name="__codelineno-4-63"></a>
<a href="#__codelineno-4-64" id="__codelineno-4-64" name="__codelineno-4-64"></a>            <span class="c1"># Tokenize</span>
<a href="#__codelineno-4-65" id="__codelineno-4-65" name="__codelineno-4-65"></a>            <span class="n">tokens</span> <span class="o">=</span> <span class="n">tokenizer</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="n">formatted_text</span><span class="p">)</span>
<a href="#__codelineno-4-66" id="__codelineno-4-66" name="__codelineno-4-66"></a>
<a href="#__codelineno-4-67" id="__codelineno-4-67" name="__codelineno-4-67"></a>            <span class="c1"># Create labels (for computing loss only on response)</span>
<a href="#__codelineno-4-68" id="__codelineno-4-68" name="__codelineno-4-68"></a>            <span class="n">labels</span> <span class="o">=</span> <span class="n">tokens</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
<a href="#__codelineno-4-69" id="__codelineno-4-69" name="__codelineno-4-69"></a>
<a href="#__codelineno-4-70" id="__codelineno-4-70" name="__codelineno-4-70"></a>            <span class="c1"># Find response start (simplified)</span>
<a href="#__codelineno-4-71" id="__codelineno-4-71" name="__codelineno-4-71"></a>            <span class="n">response_start</span> <span class="o">=</span> <span class="n">formatted_text</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s2">"### Response:"</span><span class="p">)</span>
<a href="#__codelineno-4-72" id="__codelineno-4-72" name="__codelineno-4-72"></a>            <span class="k">if</span> <span class="n">response_start</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
<a href="#__codelineno-4-73" id="__codelineno-4-73" name="__codelineno-4-73"></a>                <span class="c1"># Mask instruction tokens (set to -100 to ignore in loss)</span>
<a href="#__codelineno-4-74" id="__codelineno-4-74" name="__codelineno-4-74"></a>                <span class="n">instruction_tokens</span> <span class="o">=</span> <span class="n">tokenizer</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="n">formatted_text</span><span class="p">[:</span><span class="n">response_start</span><span class="p">])</span>
<a href="#__codelineno-4-75" id="__codelineno-4-75" name="__codelineno-4-75"></a>                <span class="n">labels</span><span class="p">[:</span><span class="nb">len</span><span class="p">(</span><span class="n">instruction_tokens</span><span class="p">)]</span> <span class="o">=</span> <span class="p">[</span><span class="o">-</span><span class="mi">100</span><span class="p">]</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">instruction_tokens</span><span class="p">)</span>
<a href="#__codelineno-4-76" id="__codelineno-4-76" name="__codelineno-4-76"></a>
<a href="#__codelineno-4-77" id="__codelineno-4-77" name="__codelineno-4-77"></a>            <span class="n">training_data</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
<a href="#__codelineno-4-78" id="__codelineno-4-78" name="__codelineno-4-78"></a>                <span class="s1">'input_ids'</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">tokens</span><span class="p">),</span>
<a href="#__codelineno-4-79" id="__codelineno-4-79" name="__codelineno-4-79"></a>                <span class="s1">'labels'</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">labels</span><span class="p">)</span>
<a href="#__codelineno-4-80" id="__codelineno-4-80" name="__codelineno-4-80"></a>            <span class="p">})</span>
<a href="#__codelineno-4-81" id="__codelineno-4-81" name="__codelineno-4-81"></a>
<a href="#__codelineno-4-82" id="__codelineno-4-82" name="__codelineno-4-82"></a>        <span class="k">return</span> <span class="n">training_data</span>
<a href="#__codelineno-4-83" id="__codelineno-4-83" name="__codelineno-4-83"></a>
<a href="#__codelineno-4-84" id="__codelineno-4-84" name="__codelineno-4-84"></a><span class="c1"># SFT Training loop</span>
<a href="#__codelineno-4-85" id="__codelineno-4-85" name="__codelineno-4-85"></a><span class="k">class</span><span class="w"> </span><span class="nc">SFTTrainer</span><span class="p">:</span>
<a href="#__codelineno-4-86" id="__codelineno-4-86" name="__codelineno-4-86"></a><span class="w">    </span><span class="sd">"""Supervised Fine-tuning trainer"""</span>
<a href="#__codelineno-4-87" id="__codelineno-4-87" name="__codelineno-4-87"></a>
<a href="#__codelineno-4-88" id="__codelineno-4-88" name="__codelineno-4-88"></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">base_model</span><span class="p">,</span> <span class="n">tokenizer</span><span class="p">):</span>
<a href="#__codelineno-4-89" id="__codelineno-4-89" name="__codelineno-4-89"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">model</span> <span class="o">=</span> <span class="n">base_model</span>
<a href="#__codelineno-4-90" id="__codelineno-4-90" name="__codelineno-4-90"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">tokenizer</span> <span class="o">=</span> <span class="n">tokenizer</span>
<a href="#__codelineno-4-91" id="__codelineno-4-91" name="__codelineno-4-91"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">training_stats</span> <span class="o">=</span> <span class="p">[]</span>
<a href="#__codelineno-4-92" id="__codelineno-4-92" name="__codelineno-4-92"></a>
<a href="#__codelineno-4-93" id="__codelineno-4-93" name="__codelineno-4-93"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">compute_loss</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">logits</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">labels</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
<a href="#__codelineno-4-94" id="__codelineno-4-94" name="__codelineno-4-94"></a><span class="w">        </span><span class="sd">"""Compute loss only on response tokens"""</span>
<a href="#__codelineno-4-95" id="__codelineno-4-95" name="__codelineno-4-95"></a>        <span class="c1"># Find non-masked positions</span>
<a href="#__codelineno-4-96" id="__codelineno-4-96" name="__codelineno-4-96"></a>        <span class="n">valid_positions</span> <span class="o">=</span> <span class="n">labels</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">100</span>
<a href="#__codelineno-4-97" id="__codelineno-4-97" name="__codelineno-4-97"></a>
<a href="#__codelineno-4-98" id="__codelineno-4-98" name="__codelineno-4-98"></a>        <span class="k">if</span> <span class="ow">not</span> <span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">valid_positions</span><span class="p">):</span>
<a href="#__codelineno-4-99" id="__codelineno-4-99" name="__codelineno-4-99"></a>            <span class="k">return</span> <span class="mf">0.0</span>
<a href="#__codelineno-4-100" id="__codelineno-4-100" name="__codelineno-4-100"></a>
<a href="#__codelineno-4-101" id="__codelineno-4-101" name="__codelineno-4-101"></a>        <span class="c1"># Get predictions and targets for valid positions</span>
<a href="#__codelineno-4-102" id="__codelineno-4-102" name="__codelineno-4-102"></a>        <span class="n">valid_logits</span> <span class="o">=</span> <span class="n">logits</span><span class="p">[</span><span class="n">valid_positions</span><span class="p">]</span>
<a href="#__codelineno-4-103" id="__codelineno-4-103" name="__codelineno-4-103"></a>        <span class="n">valid_labels</span> <span class="o">=</span> <span class="n">labels</span><span class="p">[</span><span class="n">valid_positions</span><span class="p">]</span>
<a href="#__codelineno-4-104" id="__codelineno-4-104" name="__codelineno-4-104"></a>
<a href="#__codelineno-4-105" id="__codelineno-4-105" name="__codelineno-4-105"></a>        <span class="c1"># Apply softmax</span>
<a href="#__codelineno-4-106" id="__codelineno-4-106" name="__codelineno-4-106"></a>        <span class="n">max_logits</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">valid_logits</span><span class="p">,</span> <span class="n">axis</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span> <span class="n">keepdims</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<a href="#__codelineno-4-107" id="__codelineno-4-107" name="__codelineno-4-107"></a>        <span class="n">exp_logits</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">valid_logits</span> <span class="o">-</span> <span class="n">max_logits</span><span class="p">)</span>
<a href="#__codelineno-4-108" id="__codelineno-4-108" name="__codelineno-4-108"></a>        <span class="n">probs</span> <span class="o">=</span> <span class="n">exp_logits</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">exp_logits</span><span class="p">,</span> <span class="n">axis</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span> <span class="n">keepdims</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<a href="#__codelineno-4-109" id="__codelineno-4-109" name="__codelineno-4-109"></a>
<a href="#__codelineno-4-110" id="__codelineno-4-110" name="__codelineno-4-110"></a>        <span class="c1"># Cross-entropy loss</span>
<a href="#__codelineno-4-111" id="__codelineno-4-111" name="__codelineno-4-111"></a>        <span class="n">loss</span> <span class="o">=</span> <span class="mf">0.0</span>
<a href="#__codelineno-4-112" id="__codelineno-4-112" name="__codelineno-4-112"></a>        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">label</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">valid_labels</span><span class="p">):</span>
<a href="#__codelineno-4-113" id="__codelineno-4-113" name="__codelineno-4-113"></a>            <span class="n">loss</span> <span class="o">+=</span> <span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">probs</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">label</span><span class="p">]</span> <span class="o">+</span> <span class="mf">1e-8</span><span class="p">)</span>
<a href="#__codelineno-4-114" id="__codelineno-4-114" name="__codelineno-4-114"></a>
<a href="#__codelineno-4-115" id="__codelineno-4-115" name="__codelineno-4-115"></a>        <span class="k">return</span> <span class="n">loss</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="n">valid_labels</span><span class="p">)</span>
<a href="#__codelineno-4-116" id="__codelineno-4-116" name="__codelineno-4-116"></a>
<a href="#__codelineno-4-117" id="__codelineno-4-117" name="__codelineno-4-117"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">train_step</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">batch</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">]])</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
<a href="#__codelineno-4-118" id="__codelineno-4-118" name="__codelineno-4-118"></a><span class="w">        </span><span class="sd">"""Single training step"""</span>
<a href="#__codelineno-4-119" id="__codelineno-4-119" name="__codelineno-4-119"></a>        <span class="n">total_loss</span> <span class="o">=</span> <span class="mf">0.0</span>
<a href="#__codelineno-4-120" id="__codelineno-4-120" name="__codelineno-4-120"></a>
<a href="#__codelineno-4-121" id="__codelineno-4-121" name="__codelineno-4-121"></a>        <span class="k">for</span> <span class="n">example</span> <span class="ow">in</span> <span class="n">batch</span><span class="p">:</span>
<a href="#__codelineno-4-122" id="__codelineno-4-122" name="__codelineno-4-122"></a>            <span class="n">input_ids</span> <span class="o">=</span> <span class="n">example</span><span class="p">[</span><span class="s1">'input_ids'</span><span class="p">]</span>
<a href="#__codelineno-4-123" id="__codelineno-4-123" name="__codelineno-4-123"></a>            <span class="n">labels</span> <span class="o">=</span> <span class="n">example</span><span class="p">[</span><span class="s1">'labels'</span><span class="p">]</span>
<a href="#__codelineno-4-124" id="__codelineno-4-124" name="__codelineno-4-124"></a>
<a href="#__codelineno-4-125" id="__codelineno-4-125" name="__codelineno-4-125"></a>            <span class="c1"># Forward pass (simplified)</span>
<a href="#__codelineno-4-126" id="__codelineno-4-126" name="__codelineno-4-126"></a>            <span class="n">logits</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">randn</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">input_ids</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">tokenizer</span><span class="o">.</span><span class="n">vocab_size</span><span class="p">)</span>
<a href="#__codelineno-4-127" id="__codelineno-4-127" name="__codelineno-4-127"></a>
<a href="#__codelineno-4-128" id="__codelineno-4-128" name="__codelineno-4-128"></a>            <span class="c1"># Compute loss</span>
<a href="#__codelineno-4-129" id="__codelineno-4-129" name="__codelineno-4-129"></a>            <span class="n">loss</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">compute_loss</span><span class="p">(</span><span class="n">logits</span><span class="p">,</span> <span class="n">labels</span><span class="p">)</span>
<a href="#__codelineno-4-130" id="__codelineno-4-130" name="__codelineno-4-130"></a>            <span class="n">total_loss</span> <span class="o">+=</span> <span class="n">loss</span>
<a href="#__codelineno-4-131" id="__codelineno-4-131" name="__codelineno-4-131"></a>
<a href="#__codelineno-4-132" id="__codelineno-4-132" name="__codelineno-4-132"></a>        <span class="k">return</span> <span class="n">total_loss</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="n">batch</span><span class="p">)</span>
<a href="#__codelineno-4-133" id="__codelineno-4-133" name="__codelineno-4-133"></a>
<a href="#__codelineno-4-134" id="__codelineno-4-134" name="__codelineno-4-134"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">fine_tune</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dataset</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">]],</span> 
<a href="#__codelineno-4-135" id="__codelineno-4-135" name="__codelineno-4-135"></a>                  <span class="n">epochs</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">3</span><span class="p">,</span> <span class="n">batch_size</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">4</span><span class="p">):</span>
<a href="#__codelineno-4-136" id="__codelineno-4-136" name="__codelineno-4-136"></a><span class="w">        </span><span class="sd">"""Fine-tune model on instruction data"""</span>
<a href="#__codelineno-4-137" id="__codelineno-4-137" name="__codelineno-4-137"></a>        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"Starting supervised fine-tuning..."</span><span class="p">)</span>
<a href="#__codelineno-4-138" id="__codelineno-4-138" name="__codelineno-4-138"></a>        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"Dataset size: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">dataset</span><span class="p">)</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
<a href="#__codelineno-4-139" id="__codelineno-4-139" name="__codelineno-4-139"></a>        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"Epochs: </span><span class="si">{</span><span class="n">epochs</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
<a href="#__codelineno-4-140" id="__codelineno-4-140" name="__codelineno-4-140"></a>        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"Batch size: </span><span class="si">{</span><span class="n">batch_size</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
<a href="#__codelineno-4-141" id="__codelineno-4-141" name="__codelineno-4-141"></a>
<a href="#__codelineno-4-142" id="__codelineno-4-142" name="__codelineno-4-142"></a>        <span class="k">for</span> <span class="n">epoch</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">epochs</span><span class="p">):</span>
<a href="#__codelineno-4-143" id="__codelineno-4-143" name="__codelineno-4-143"></a>            <span class="n">epoch_losses</span> <span class="o">=</span> <span class="p">[]</span>
<a href="#__codelineno-4-144" id="__codelineno-4-144" name="__codelineno-4-144"></a>
<a href="#__codelineno-4-145" id="__codelineno-4-145" name="__codelineno-4-145"></a>            <span class="c1"># Create batches</span>
<a href="#__codelineno-4-146" id="__codelineno-4-146" name="__codelineno-4-146"></a>            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">dataset</span><span class="p">),</span> <span class="n">batch_size</span><span class="p">):</span>
<a href="#__codelineno-4-147" id="__codelineno-4-147" name="__codelineno-4-147"></a>                <span class="n">batch</span> <span class="o">=</span> <span class="n">dataset</span><span class="p">[</span><span class="n">i</span><span class="p">:</span><span class="n">i</span> <span class="o">+</span> <span class="n">batch_size</span><span class="p">]</span>
<a href="#__codelineno-4-148" id="__codelineno-4-148" name="__codelineno-4-148"></a>
<a href="#__codelineno-4-149" id="__codelineno-4-149" name="__codelineno-4-149"></a>                <span class="c1"># Training step</span>
<a href="#__codelineno-4-150" id="__codelineno-4-150" name="__codelineno-4-150"></a>                <span class="n">loss</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">train_step</span><span class="p">(</span><span class="n">batch</span><span class="p">)</span>
<a href="#__codelineno-4-151" id="__codelineno-4-151" name="__codelineno-4-151"></a>                <span class="n">epoch_losses</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">loss</span><span class="p">)</span>
<a href="#__codelineno-4-152" id="__codelineno-4-152" name="__codelineno-4-152"></a>
<a href="#__codelineno-4-153" id="__codelineno-4-153" name="__codelineno-4-153"></a>                <span class="k">if</span> <span class="n">i</span> <span class="o">%</span> <span class="p">(</span><span class="n">batch_size</span> <span class="o">*</span> <span class="mi">10</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
<a href="#__codelineno-4-154" id="__codelineno-4-154" name="__codelineno-4-154"></a>                    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"Epoch </span><span class="si">{</span><span class="n">epoch</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="si">}</span><span class="s2">, Batch </span><span class="si">{</span><span class="n">i</span><span class="w"> </span><span class="o">//</span><span class="w"> </span><span class="n">batch_size</span><span class="si">}</span><span class="s2">: Loss = </span><span class="si">{</span><span class="n">loss</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
<a href="#__codelineno-4-155" id="__codelineno-4-155" name="__codelineno-4-155"></a>
<a href="#__codelineno-4-156" id="__codelineno-4-156" name="__codelineno-4-156"></a>            <span class="n">avg_loss</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">epoch_losses</span><span class="p">)</span>
<a href="#__codelineno-4-157" id="__codelineno-4-157" name="__codelineno-4-157"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">training_stats</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">avg_loss</span><span class="p">)</span>
<a href="#__codelineno-4-158" id="__codelineno-4-158" name="__codelineno-4-158"></a>            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"Epoch </span><span class="si">{</span><span class="n">epoch</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="si">}</span><span class="s2"> completed. Average loss: </span><span class="si">{</span><span class="n">avg_loss</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
<a href="#__codelineno-4-159" id="__codelineno-4-159" name="__codelineno-4-159"></a>
<a href="#__codelineno-4-160" id="__codelineno-4-160" name="__codelineno-4-160"></a><span class="c1"># Example SFT training</span>
<a href="#__codelineno-4-161" id="__codelineno-4-161" name="__codelineno-4-161"></a><span class="n">instruction_dataset</span> <span class="o">=</span> <span class="n">InstructionDataset</span><span class="p">()</span>
<a href="#__codelineno-4-162" id="__codelineno-4-162" name="__codelineno-4-162"></a><span class="n">examples</span> <span class="o">=</span> <span class="n">instruction_dataset</span><span class="o">.</span><span class="n">generate_instruction_examples</span><span class="p">()</span>
<a href="#__codelineno-4-163" id="__codelineno-4-163" name="__codelineno-4-163"></a>
<a href="#__codelineno-4-164" id="__codelineno-4-164" name="__codelineno-4-164"></a><span class="nb">print</span><span class="p">(</span><span class="s2">"Instruction Examples:"</span><span class="p">)</span>
<a href="#__codelineno-4-165" id="__codelineno-4-165" name="__codelineno-4-165"></a><span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">example</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">examples</span><span class="p">):</span>
<a href="#__codelineno-4-166" id="__codelineno-4-166" name="__codelineno-4-166"></a>    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"</span><span class="se">\n</span><span class="s2">Example </span><span class="si">{</span><span class="n">i</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="si">}</span><span class="s2">:"</span><span class="p">)</span>
<a href="#__codelineno-4-167" id="__codelineno-4-167" name="__codelineno-4-167"></a>    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"Instruction: </span><span class="si">{</span><span class="n">example</span><span class="p">[</span><span class="s1">'instruction'</span><span class="p">]</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
<a href="#__codelineno-4-168" id="__codelineno-4-168" name="__codelineno-4-168"></a>    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"Input: </span><span class="si">{</span><span class="n">example</span><span class="p">[</span><span class="s1">'input'</span><span class="p">]</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
<a href="#__codelineno-4-169" id="__codelineno-4-169" name="__codelineno-4-169"></a>    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"Output: </span><span class="si">{</span><span class="n">example</span><span class="p">[</span><span class="s1">'output'</span><span class="p">][:</span><span class="mi">100</span><span class="p">]</span><span class="si">}</span><span class="s2">..."</span><span class="p">)</span>
</code></pre></div></p>
<h2 id="reinforcement-learning-from-human-feedback-rlhf">🔄 Reinforcement Learning from Human Feedback (RLHF)</h2>
<h3 id="reward-model-training">Reward Model Training</h3>
<p><strong>Human Preference Data Collection</strong>:
<div class="highlight"><pre><span></span><code><a href="#__codelineno-5-1" id="__codelineno-5-1" name="__codelineno-5-1"></a><span class="k">class</span><span class="w"> </span><span class="nc">RewardModel</span><span class="p">:</span>
<a href="#__codelineno-5-2" id="__codelineno-5-2" name="__codelineno-5-2"></a><span class="w">    </span><span class="sd">"""Reward model for RLHF training"""</span>
<a href="#__codelineno-5-3" id="__codelineno-5-3" name="__codelineno-5-3"></a>
<a href="#__codelineno-5-4" id="__codelineno-5-4" name="__codelineno-5-4"></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">d_model</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">768</span><span class="p">):</span>
<a href="#__codelineno-5-5" id="__codelineno-5-5" name="__codelineno-5-5"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">d_model</span> <span class="o">=</span> <span class="n">d_model</span>
<a href="#__codelineno-5-6" id="__codelineno-5-6" name="__codelineno-5-6"></a>        <span class="c1"># Initialize reward head (maps model outputs to scalar reward)</span>
<a href="#__codelineno-5-7" id="__codelineno-5-7" name="__codelineno-5-7"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">reward_head</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">randn</span><span class="p">(</span><span class="n">d_model</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="mf">0.01</span>
<a href="#__codelineno-5-8" id="__codelineno-5-8" name="__codelineno-5-8"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">bias</span> <span class="o">=</span> <span class="mf">0.0</span>
<a href="#__codelineno-5-9" id="__codelineno-5-9" name="__codelineno-5-9"></a>
<a href="#__codelineno-5-10" id="__codelineno-5-10" name="__codelineno-5-10"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">compute_reward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">hidden_states</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
<a href="#__codelineno-5-11" id="__codelineno-5-11" name="__codelineno-5-11"></a><span class="w">        </span><span class="sd">"""Compute scalar reward from hidden states"""</span>
<a href="#__codelineno-5-12" id="__codelineno-5-12" name="__codelineno-5-12"></a>        <span class="c1"># Take last token's hidden state</span>
<a href="#__codelineno-5-13" id="__codelineno-5-13" name="__codelineno-5-13"></a>        <span class="n">last_hidden</span> <span class="o">=</span> <span class="n">hidden_states</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="p">:]</span>
<a href="#__codelineno-5-14" id="__codelineno-5-14" name="__codelineno-5-14"></a>
<a href="#__codelineno-5-15" id="__codelineno-5-15" name="__codelineno-5-15"></a>        <span class="c1"># Linear projection to scalar reward</span>
<a href="#__codelineno-5-16" id="__codelineno-5-16" name="__codelineno-5-16"></a>        <span class="n">reward</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">last_hidden</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">reward_head</span><span class="o">.</span><span class="n">flatten</span><span class="p">())</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">bias</span>
<a href="#__codelineno-5-17" id="__codelineno-5-17" name="__codelineno-5-17"></a>
<a href="#__codelineno-5-18" id="__codelineno-5-18" name="__codelineno-5-18"></a>        <span class="k">return</span> <span class="n">reward</span>
<a href="#__codelineno-5-19" id="__codelineno-5-19" name="__codelineno-5-19"></a>
<a href="#__codelineno-5-20" id="__codelineno-5-20" name="__codelineno-5-20"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">train_on_preferences</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">comparisons</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">]):</span>
<a href="#__codelineno-5-21" id="__codelineno-5-21" name="__codelineno-5-21"></a><span class="w">        </span><span class="sd">"""Train reward model on human preference comparisons"""</span>
<a href="#__codelineno-5-22" id="__codelineno-5-22" name="__codelineno-5-22"></a>        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"Training reward model on </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">comparisons</span><span class="p">)</span><span class="si">}</span><span class="s2"> comparisons"</span><span class="p">)</span>
<a href="#__codelineno-5-23" id="__codelineno-5-23" name="__codelineno-5-23"></a>
<a href="#__codelineno-5-24" id="__codelineno-5-24" name="__codelineno-5-24"></a>        <span class="n">losses</span> <span class="o">=</span> <span class="p">[]</span>
<a href="#__codelineno-5-25" id="__codelineno-5-25" name="__codelineno-5-25"></a>
<a href="#__codelineno-5-26" id="__codelineno-5-26" name="__codelineno-5-26"></a>        <span class="k">for</span> <span class="n">comparison</span> <span class="ow">in</span> <span class="n">comparisons</span><span class="p">:</span>
<a href="#__codelineno-5-27" id="__codelineno-5-27" name="__codelineno-5-27"></a>            <span class="n">response_a</span> <span class="o">=</span> <span class="n">comparison</span><span class="p">[</span><span class="s1">'response_a'</span><span class="p">]</span>
<a href="#__codelineno-5-28" id="__codelineno-5-28" name="__codelineno-5-28"></a>            <span class="n">response_b</span> <span class="o">=</span> <span class="n">comparison</span><span class="p">[</span><span class="s1">'response_b'</span><span class="p">]</span>
<a href="#__codelineno-5-29" id="__codelineno-5-29" name="__codelineno-5-29"></a>            <span class="n">preference</span> <span class="o">=</span> <span class="n">comparison</span><span class="p">[</span><span class="s1">'preference'</span><span class="p">]</span>  <span class="c1"># 'A' or 'B'</span>
<a href="#__codelineno-5-30" id="__codelineno-5-30" name="__codelineno-5-30"></a>
<a href="#__codelineno-5-31" id="__codelineno-5-31" name="__codelineno-5-31"></a>            <span class="c1"># Get hidden states (simulated)</span>
<a href="#__codelineno-5-32" id="__codelineno-5-32" name="__codelineno-5-32"></a>            <span class="n">hidden_a</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">randn</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">response_a</span><span class="o">.</span><span class="n">split</span><span class="p">()),</span> <span class="bp">self</span><span class="o">.</span><span class="n">d_model</span><span class="p">)</span>
<a href="#__codelineno-5-33" id="__codelineno-5-33" name="__codelineno-5-33"></a>            <span class="n">hidden_b</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">randn</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">response_b</span><span class="o">.</span><span class="n">split</span><span class="p">()),</span> <span class="bp">self</span><span class="o">.</span><span class="n">d_model</span><span class="p">)</span>
<a href="#__codelineno-5-34" id="__codelineno-5-34" name="__codelineno-5-34"></a>
<a href="#__codelineno-5-35" id="__codelineno-5-35" name="__codelineno-5-35"></a>            <span class="c1"># Compute rewards</span>
<a href="#__codelineno-5-36" id="__codelineno-5-36" name="__codelineno-5-36"></a>            <span class="n">reward_a</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">compute_reward</span><span class="p">(</span><span class="n">hidden_a</span><span class="p">)</span>
<a href="#__codelineno-5-37" id="__codelineno-5-37" name="__codelineno-5-37"></a>            <span class="n">reward_b</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">compute_reward</span><span class="p">(</span><span class="n">hidden_b</span><span class="p">)</span>
<a href="#__codelineno-5-38" id="__codelineno-5-38" name="__codelineno-5-38"></a>
<a href="#__codelineno-5-39" id="__codelineno-5-39" name="__codelineno-5-39"></a>            <span class="c1"># Bradley-Terry loss</span>
<a href="#__codelineno-5-40" id="__codelineno-5-40" name="__codelineno-5-40"></a>            <span class="k">if</span> <span class="n">preference</span> <span class="o">==</span> <span class="s1">'A'</span><span class="p">:</span>
<a href="#__codelineno-5-41" id="__codelineno-5-41" name="__codelineno-5-41"></a>                <span class="c1"># A is preferred, so reward_a should be higher</span>
<a href="#__codelineno-5-42" id="__codelineno-5-42" name="__codelineno-5-42"></a>                <span class="n">loss</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">reward_b</span> <span class="o">-</span> <span class="n">reward_a</span><span class="p">))</span>
<a href="#__codelineno-5-43" id="__codelineno-5-43" name="__codelineno-5-43"></a>            <span class="k">else</span><span class="p">:</span>
<a href="#__codelineno-5-44" id="__codelineno-5-44" name="__codelineno-5-44"></a>                <span class="c1"># B is preferred, so reward_b should be higher</span>
<a href="#__codelineno-5-45" id="__codelineno-5-45" name="__codelineno-5-45"></a>                <span class="n">loss</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">reward_a</span> <span class="o">-</span> <span class="n">reward_b</span><span class="p">))</span>
<a href="#__codelineno-5-46" id="__codelineno-5-46" name="__codelineno-5-46"></a>
<a href="#__codelineno-5-47" id="__codelineno-5-47" name="__codelineno-5-47"></a>            <span class="n">losses</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">loss</span><span class="p">)</span>
<a href="#__codelineno-5-48" id="__codelineno-5-48" name="__codelineno-5-48"></a>
<a href="#__codelineno-5-49" id="__codelineno-5-49" name="__codelineno-5-49"></a>            <span class="c1"># Gradient update (simplified)</span>
<a href="#__codelineno-5-50" id="__codelineno-5-50" name="__codelineno-5-50"></a>            <span class="n">learning_rate</span> <span class="o">=</span> <span class="mf">0.001</span>
<a href="#__codelineno-5-51" id="__codelineno-5-51" name="__codelineno-5-51"></a>            <span class="k">if</span> <span class="n">preference</span> <span class="o">==</span> <span class="s1">'A'</span><span class="p">:</span>
<a href="#__codelineno-5-52" id="__codelineno-5-52" name="__codelineno-5-52"></a>                <span class="n">gradient</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">reward_b</span> <span class="o">-</span> <span class="n">reward_a</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">reward_b</span> <span class="o">-</span> <span class="n">reward_a</span><span class="p">))</span>
<a href="#__codelineno-5-53" id="__codelineno-5-53" name="__codelineno-5-53"></a>                <span class="bp">self</span><span class="o">.</span><span class="n">reward_head</span> <span class="o">-=</span> <span class="n">learning_rate</span> <span class="o">*</span> <span class="n">gradient</span> <span class="o">*</span> <span class="n">hidden_a</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">:]</span><span class="o">.</span><span class="n">T</span>
<a href="#__codelineno-5-54" id="__codelineno-5-54" name="__codelineno-5-54"></a>            <span class="k">else</span><span class="p">:</span>
<a href="#__codelineno-5-55" id="__codelineno-5-55" name="__codelineno-5-55"></a>                <span class="n">gradient</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">reward_a</span> <span class="o">-</span> <span class="n">reward_b</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">reward_a</span> <span class="o">-</span> <span class="n">reward_b</span><span class="p">))</span>
<a href="#__codelineno-5-56" id="__codelineno-5-56" name="__codelineno-5-56"></a>                <span class="bp">self</span><span class="o">.</span><span class="n">reward_head</span> <span class="o">-=</span> <span class="n">learning_rate</span> <span class="o">*</span> <span class="n">gradient</span> <span class="o">*</span> <span class="n">hidden_b</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">:]</span><span class="o">.</span><span class="n">T</span>
<a href="#__codelineno-5-57" id="__codelineno-5-57" name="__codelineno-5-57"></a>
<a href="#__codelineno-5-58" id="__codelineno-5-58" name="__codelineno-5-58"></a>        <span class="n">avg_loss</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">losses</span><span class="p">)</span>
<a href="#__codelineno-5-59" id="__codelineno-5-59" name="__codelineno-5-59"></a>        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"Reward model training completed. Average loss: </span><span class="si">{</span><span class="n">avg_loss</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
<a href="#__codelineno-5-60" id="__codelineno-5-60" name="__codelineno-5-60"></a>
<a href="#__codelineno-5-61" id="__codelineno-5-61" name="__codelineno-5-61"></a>        <span class="k">return</span> <span class="n">avg_loss</span>
<a href="#__codelineno-5-62" id="__codelineno-5-62" name="__codelineno-5-62"></a>
<a href="#__codelineno-5-63" id="__codelineno-5-63" name="__codelineno-5-63"></a><span class="k">class</span><span class="w"> </span><span class="nc">PPOTrainer</span><span class="p">:</span>
<a href="#__codelineno-5-64" id="__codelineno-5-64" name="__codelineno-5-64"></a><span class="w">    </span><span class="sd">"""Proximal Policy Optimization for RLHF"""</span>
<a href="#__codelineno-5-65" id="__codelineno-5-65" name="__codelineno-5-65"></a>
<a href="#__codelineno-5-66" id="__codelineno-5-66" name="__codelineno-5-66"></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">policy_model</span><span class="p">,</span> <span class="n">reward_model</span><span class="p">,</span> <span class="n">reference_model</span><span class="p">):</span>
<a href="#__codelineno-5-67" id="__codelineno-5-67" name="__codelineno-5-67"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">policy</span> <span class="o">=</span> <span class="n">policy_model</span>
<a href="#__codelineno-5-68" id="__codelineno-5-68" name="__codelineno-5-68"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">reward_model</span> <span class="o">=</span> <span class="n">reward_model</span>
<a href="#__codelineno-5-69" id="__codelineno-5-69" name="__codelineno-5-69"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">reference</span> <span class="o">=</span> <span class="n">reference_model</span>
<a href="#__codelineno-5-70" id="__codelineno-5-70" name="__codelineno-5-70"></a>
<a href="#__codelineno-5-71" id="__codelineno-5-71" name="__codelineno-5-71"></a>        <span class="c1"># PPO hyperparameters</span>
<a href="#__codelineno-5-72" id="__codelineno-5-72" name="__codelineno-5-72"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">clip_epsilon</span> <span class="o">=</span> <span class="mf">0.2</span>
<a href="#__codelineno-5-73" id="__codelineno-5-73" name="__codelineno-5-73"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">kl_penalty</span> <span class="o">=</span> <span class="mf">0.1</span>
<a href="#__codelineno-5-74" id="__codelineno-5-74" name="__codelineno-5-74"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">value_loss_coef</span> <span class="o">=</span> <span class="mf">0.1</span>
<a href="#__codelineno-5-75" id="__codelineno-5-75" name="__codelineno-5-75"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">entropy_bonus</span> <span class="o">=</span> <span class="mf">0.01</span>
<a href="#__codelineno-5-76" id="__codelineno-5-76" name="__codelineno-5-76"></a>
<a href="#__codelineno-5-77" id="__codelineno-5-77" name="__codelineno-5-77"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">compute_advantages</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">rewards</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">float</span><span class="p">],</span> <span class="n">values</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">float</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="nb">float</span><span class="p">]:</span>
<a href="#__codelineno-5-78" id="__codelineno-5-78" name="__codelineno-5-78"></a><span class="w">        </span><span class="sd">"""Compute advantages using GAE"""</span>
<a href="#__codelineno-5-79" id="__codelineno-5-79" name="__codelineno-5-79"></a>        <span class="n">advantages</span> <span class="o">=</span> <span class="p">[]</span>
<a href="#__codelineno-5-80" id="__codelineno-5-80" name="__codelineno-5-80"></a>        <span class="n">gae</span> <span class="o">=</span> <span class="mi">0</span>
<a href="#__codelineno-5-81" id="__codelineno-5-81" name="__codelineno-5-81"></a>        <span class="n">gamma</span> <span class="o">=</span> <span class="mf">0.99</span>
<a href="#__codelineno-5-82" id="__codelineno-5-82" name="__codelineno-5-82"></a>        <span class="n">lam</span> <span class="o">=</span> <span class="mf">0.95</span>
<a href="#__codelineno-5-83" id="__codelineno-5-83" name="__codelineno-5-83"></a>
<a href="#__codelineno-5-84" id="__codelineno-5-84" name="__codelineno-5-84"></a>        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">reversed</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">rewards</span><span class="p">))):</span>
<a href="#__codelineno-5-85" id="__codelineno-5-85" name="__codelineno-5-85"></a>            <span class="k">if</span> <span class="n">i</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">rewards</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">:</span>
<a href="#__codelineno-5-86" id="__codelineno-5-86" name="__codelineno-5-86"></a>                <span class="n">next_value</span> <span class="o">=</span> <span class="mi">0</span>
<a href="#__codelineno-5-87" id="__codelineno-5-87" name="__codelineno-5-87"></a>            <span class="k">else</span><span class="p">:</span>
<a href="#__codelineno-5-88" id="__codelineno-5-88" name="__codelineno-5-88"></a>                <span class="n">next_value</span> <span class="o">=</span> <span class="n">values</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span>
<a href="#__codelineno-5-89" id="__codelineno-5-89" name="__codelineno-5-89"></a>
<a href="#__codelineno-5-90" id="__codelineno-5-90" name="__codelineno-5-90"></a>            <span class="n">delta</span> <span class="o">=</span> <span class="n">rewards</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">+</span> <span class="n">gamma</span> <span class="o">*</span> <span class="n">next_value</span> <span class="o">-</span> <span class="n">values</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
<a href="#__codelineno-5-91" id="__codelineno-5-91" name="__codelineno-5-91"></a>            <span class="n">gae</span> <span class="o">=</span> <span class="n">delta</span> <span class="o">+</span> <span class="n">gamma</span> <span class="o">*</span> <span class="n">lam</span> <span class="o">*</span> <span class="n">gae</span>
<a href="#__codelineno-5-92" id="__codelineno-5-92" name="__codelineno-5-92"></a>            <span class="n">advantages</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">gae</span><span class="p">)</span>
<a href="#__codelineno-5-93" id="__codelineno-5-93" name="__codelineno-5-93"></a>
<a href="#__codelineno-5-94" id="__codelineno-5-94" name="__codelineno-5-94"></a>        <span class="k">return</span> <span class="n">advantages</span>
<a href="#__codelineno-5-95" id="__codelineno-5-95" name="__codelineno-5-95"></a>
<a href="#__codelineno-5-96" id="__codelineno-5-96" name="__codelineno-5-96"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">ppo_step</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">prompts</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span> <span class="n">responses</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">float</span><span class="p">]:</span>
<a href="#__codelineno-5-97" id="__codelineno-5-97" name="__codelineno-5-97"></a><span class="w">        </span><span class="sd">"""Single PPO training step"""</span>
<a href="#__codelineno-5-98" id="__codelineno-5-98" name="__codelineno-5-98"></a>        <span class="n">batch_size</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">prompts</span><span class="p">)</span>
<a href="#__codelineno-5-99" id="__codelineno-5-99" name="__codelineno-5-99"></a>
<a href="#__codelineno-5-100" id="__codelineno-5-100" name="__codelineno-5-100"></a>        <span class="c1"># Generate responses and compute rewards</span>
<a href="#__codelineno-5-101" id="__codelineno-5-101" name="__codelineno-5-101"></a>        <span class="n">rewards</span> <span class="o">=</span> <span class="p">[]</span>
<a href="#__codelineno-5-102" id="__codelineno-5-102" name="__codelineno-5-102"></a>        <span class="n">kl_penalties</span> <span class="o">=</span> <span class="p">[]</span>
<a href="#__codelineno-5-103" id="__codelineno-5-103" name="__codelineno-5-103"></a>
<a href="#__codelineno-5-104" id="__codelineno-5-104" name="__codelineno-5-104"></a>        <span class="k">for</span> <span class="n">prompt</span><span class="p">,</span> <span class="n">response</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">prompts</span><span class="p">,</span> <span class="n">responses</span><span class="p">):</span>
<a href="#__codelineno-5-105" id="__codelineno-5-105" name="__codelineno-5-105"></a>            <span class="c1"># Compute reward from reward model</span>
<a href="#__codelineno-5-106" id="__codelineno-5-106" name="__codelineno-5-106"></a>            <span class="c1"># (In practice, this involves forward passes through the models)</span>
<a href="#__codelineno-5-107" id="__codelineno-5-107" name="__codelineno-5-107"></a>            <span class="n">reward</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">reward_model</span><span class="o">.</span><span class="n">compute_reward</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">randn</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">768</span><span class="p">))</span>
<a href="#__codelineno-5-108" id="__codelineno-5-108" name="__codelineno-5-108"></a>
<a href="#__codelineno-5-109" id="__codelineno-5-109" name="__codelineno-5-109"></a>            <span class="c1"># Compute KL penalty vs reference model</span>
<a href="#__codelineno-5-110" id="__codelineno-5-110" name="__codelineno-5-110"></a>            <span class="c1"># (This prevents the model from deviating too much from the reference)</span>
<a href="#__codelineno-5-111" id="__codelineno-5-111" name="__codelineno-5-111"></a>            <span class="n">kl_penalty</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">uniform</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mf">0.1</span><span class="p">)</span>  <span class="c1"># Simulated</span>
<a href="#__codelineno-5-112" id="__codelineno-5-112" name="__codelineno-5-112"></a>
<a href="#__codelineno-5-113" id="__codelineno-5-113" name="__codelineno-5-113"></a>            <span class="n">total_reward</span> <span class="o">=</span> <span class="n">reward</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">kl_penalty</span> <span class="o">*</span> <span class="n">kl_penalty</span>
<a href="#__codelineno-5-114" id="__codelineno-5-114" name="__codelineno-5-114"></a>
<a href="#__codelineno-5-115" id="__codelineno-5-115" name="__codelineno-5-115"></a>            <span class="n">rewards</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">total_reward</span><span class="p">)</span>
<a href="#__codelineno-5-116" id="__codelineno-5-116" name="__codelineno-5-116"></a>            <span class="n">kl_penalties</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">kl_penalty</span><span class="p">)</span>
<a href="#__codelineno-5-117" id="__codelineno-5-117" name="__codelineno-5-117"></a>
<a href="#__codelineno-5-118" id="__codelineno-5-118" name="__codelineno-5-118"></a>        <span class="c1"># Compute value estimates and advantages</span>
<a href="#__codelineno-5-119" id="__codelineno-5-119" name="__codelineno-5-119"></a>        <span class="n">values</span> <span class="o">=</span> <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">uniform</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">batch_size</span><span class="p">)]</span>  <span class="c1"># Simulated</span>
<a href="#__codelineno-5-120" id="__codelineno-5-120" name="__codelineno-5-120"></a>        <span class="n">advantages</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">compute_advantages</span><span class="p">(</span><span class="n">rewards</span><span class="p">,</span> <span class="n">values</span><span class="p">)</span>
<a href="#__codelineno-5-121" id="__codelineno-5-121" name="__codelineno-5-121"></a>
<a href="#__codelineno-5-122" id="__codelineno-5-122" name="__codelineno-5-122"></a>        <span class="c1"># PPO loss computation (simplified)</span>
<a href="#__codelineno-5-123" id="__codelineno-5-123" name="__codelineno-5-123"></a>        <span class="n">policy_loss</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">([</span><span class="nb">max</span><span class="p">(</span><span class="n">adv</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">clip_epsilon</span> <span class="o">*</span> <span class="n">adv</span><span class="p">)</span> <span class="k">for</span> <span class="n">adv</span> <span class="ow">in</span> <span class="n">advantages</span><span class="p">])</span>
<a href="#__codelineno-5-124" id="__codelineno-5-124" name="__codelineno-5-124"></a>        <span class="n">value_loss</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">([(</span><span class="n">r</span> <span class="o">-</span> <span class="n">v</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span> <span class="k">for</span> <span class="n">r</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">rewards</span><span class="p">,</span> <span class="n">values</span><span class="p">)])</span>
<a href="#__codelineno-5-125" id="__codelineno-5-125" name="__codelineno-5-125"></a>
<a href="#__codelineno-5-126" id="__codelineno-5-126" name="__codelineno-5-126"></a>        <span class="n">total_loss</span> <span class="o">=</span> <span class="n">policy_loss</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">value_loss_coef</span> <span class="o">*</span> <span class="n">value_loss</span>
<a href="#__codelineno-5-127" id="__codelineno-5-127" name="__codelineno-5-127"></a>
<a href="#__codelineno-5-128" id="__codelineno-5-128" name="__codelineno-5-128"></a>        <span class="k">return</span> <span class="p">{</span>
<a href="#__codelineno-5-129" id="__codelineno-5-129" name="__codelineno-5-129"></a>            <span class="s1">'policy_loss'</span><span class="p">:</span> <span class="n">policy_loss</span><span class="p">,</span>
<a href="#__codelineno-5-130" id="__codelineno-5-130" name="__codelineno-5-130"></a>            <span class="s1">'value_loss'</span><span class="p">:</span> <span class="n">value_loss</span><span class="p">,</span>
<a href="#__codelineno-5-131" id="__codelineno-5-131" name="__codelineno-5-131"></a>            <span class="s1">'total_loss'</span><span class="p">:</span> <span class="n">total_loss</span><span class="p">,</span>
<a href="#__codelineno-5-132" id="__codelineno-5-132" name="__codelineno-5-132"></a>            <span class="s1">'avg_reward'</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">rewards</span><span class="p">),</span>
<a href="#__codelineno-5-133" id="__codelineno-5-133" name="__codelineno-5-133"></a>            <span class="s1">'avg_kl'</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">kl_penalties</span><span class="p">)</span>
<a href="#__codelineno-5-134" id="__codelineno-5-134" name="__codelineno-5-134"></a>        <span class="p">}</span>
<a href="#__codelineno-5-135" id="__codelineno-5-135" name="__codelineno-5-135"></a>
<a href="#__codelineno-5-136" id="__codelineno-5-136" name="__codelineno-5-136"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">train</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dataset</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]],</span> <span class="n">epochs</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">1</span><span class="p">):</span>
<a href="#__codelineno-5-137" id="__codelineno-5-137" name="__codelineno-5-137"></a><span class="w">        </span><span class="sd">"""Train policy using PPO"""</span>
<a href="#__codelineno-5-138" id="__codelineno-5-138" name="__codelineno-5-138"></a>        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"Starting PPO training for </span><span class="si">{</span><span class="n">epochs</span><span class="si">}</span><span class="s2"> epochs"</span><span class="p">)</span>
<a href="#__codelineno-5-139" id="__codelineno-5-139" name="__codelineno-5-139"></a>
<a href="#__codelineno-5-140" id="__codelineno-5-140" name="__codelineno-5-140"></a>        <span class="k">for</span> <span class="n">epoch</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">epochs</span><span class="p">):</span>
<a href="#__codelineno-5-141" id="__codelineno-5-141" name="__codelineno-5-141"></a>            <span class="n">epoch_metrics</span> <span class="o">=</span> <span class="p">[]</span>
<a href="#__codelineno-5-142" id="__codelineno-5-142" name="__codelineno-5-142"></a>
<a href="#__codelineno-5-143" id="__codelineno-5-143" name="__codelineno-5-143"></a>            <span class="c1"># Sample batches</span>
<a href="#__codelineno-5-144" id="__codelineno-5-144" name="__codelineno-5-144"></a>            <span class="n">batch_size</span> <span class="o">=</span> <span class="mi">8</span>
<a href="#__codelineno-5-145" id="__codelineno-5-145" name="__codelineno-5-145"></a>            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">dataset</span><span class="p">),</span> <span class="n">batch_size</span><span class="p">):</span>
<a href="#__codelineno-5-146" id="__codelineno-5-146" name="__codelineno-5-146"></a>                <span class="n">batch</span> <span class="o">=</span> <span class="n">dataset</span><span class="p">[</span><span class="n">i</span><span class="p">:</span><span class="n">i</span> <span class="o">+</span> <span class="n">batch_size</span><span class="p">]</span>
<a href="#__codelineno-5-147" id="__codelineno-5-147" name="__codelineno-5-147"></a>
<a href="#__codelineno-5-148" id="__codelineno-5-148" name="__codelineno-5-148"></a>                <span class="n">prompts</span> <span class="o">=</span> <span class="p">[</span><span class="n">item</span><span class="p">[</span><span class="s1">'prompt'</span><span class="p">]</span> <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">batch</span><span class="p">]</span>
<a href="#__codelineno-5-149" id="__codelineno-5-149" name="__codelineno-5-149"></a>                <span class="n">responses</span> <span class="o">=</span> <span class="p">[</span><span class="n">item</span><span class="p">[</span><span class="s1">'response'</span><span class="p">]</span> <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">batch</span><span class="p">]</span>
<a href="#__codelineno-5-150" id="__codelineno-5-150" name="__codelineno-5-150"></a>
<a href="#__codelineno-5-151" id="__codelineno-5-151" name="__codelineno-5-151"></a>                <span class="c1"># PPO step</span>
<a href="#__codelineno-5-152" id="__codelineno-5-152" name="__codelineno-5-152"></a>                <span class="n">metrics</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ppo_step</span><span class="p">(</span><span class="n">prompts</span><span class="p">,</span> <span class="n">responses</span><span class="p">)</span>
<a href="#__codelineno-5-153" id="__codelineno-5-153" name="__codelineno-5-153"></a>                <span class="n">epoch_metrics</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">metrics</span><span class="p">)</span>
<a href="#__codelineno-5-154" id="__codelineno-5-154" name="__codelineno-5-154"></a>
<a href="#__codelineno-5-155" id="__codelineno-5-155" name="__codelineno-5-155"></a>                <span class="k">if</span> <span class="n">i</span> <span class="o">%</span> <span class="p">(</span><span class="n">batch_size</span> <span class="o">*</span> <span class="mi">5</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
<a href="#__codelineno-5-156" id="__codelineno-5-156" name="__codelineno-5-156"></a>                    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"Epoch </span><span class="si">{</span><span class="n">epoch</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="si">}</span><span class="s2">, Step </span><span class="si">{</span><span class="n">i</span><span class="w"> </span><span class="o">//</span><span class="w"> </span><span class="n">batch_size</span><span class="si">}</span><span class="s2">: "</span>
<a href="#__codelineno-5-157" id="__codelineno-5-157" name="__codelineno-5-157"></a>                          <span class="sa">f</span><span class="s2">"Reward = </span><span class="si">{</span><span class="n">metrics</span><span class="p">[</span><span class="s1">'avg_reward'</span><span class="p">]</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2">, "</span>
<a href="#__codelineno-5-158" id="__codelineno-5-158" name="__codelineno-5-158"></a>                          <span class="sa">f</span><span class="s2">"KL = </span><span class="si">{</span><span class="n">metrics</span><span class="p">[</span><span class="s1">'avg_kl'</span><span class="p">]</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
<a href="#__codelineno-5-159" id="__codelineno-5-159" name="__codelineno-5-159"></a>
<a href="#__codelineno-5-160" id="__codelineno-5-160" name="__codelineno-5-160"></a>            <span class="c1"># Epoch summary</span>
<a href="#__codelineno-5-161" id="__codelineno-5-161" name="__codelineno-5-161"></a>            <span class="n">avg_reward</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">([</span><span class="n">m</span><span class="p">[</span><span class="s1">'avg_reward'</span><span class="p">]</span> <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="n">epoch_metrics</span><span class="p">])</span>
<a href="#__codelineno-5-162" id="__codelineno-5-162" name="__codelineno-5-162"></a>            <span class="n">avg_kl</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">([</span><span class="n">m</span><span class="p">[</span><span class="s1">'avg_kl'</span><span class="p">]</span> <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="n">epoch_metrics</span><span class="p">])</span>
<a href="#__codelineno-5-163" id="__codelineno-5-163" name="__codelineno-5-163"></a>
<a href="#__codelineno-5-164" id="__codelineno-5-164" name="__codelineno-5-164"></a>            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"Epoch </span><span class="si">{</span><span class="n">epoch</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="si">}</span><span class="s2"> completed: "</span>
<a href="#__codelineno-5-165" id="__codelineno-5-165" name="__codelineno-5-165"></a>                  <span class="sa">f</span><span class="s2">"Avg Reward = </span><span class="si">{</span><span class="n">avg_reward</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2">, "</span>
<a href="#__codelineno-5-166" id="__codelineno-5-166" name="__codelineno-5-166"></a>                  <span class="sa">f</span><span class="s2">"Avg KL = </span><span class="si">{</span><span class="n">avg_kl</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
<a href="#__codelineno-5-167" id="__codelineno-5-167" name="__codelineno-5-167"></a>
<a href="#__codelineno-5-168" id="__codelineno-5-168" name="__codelineno-5-168"></a><span class="c1"># Example RLHF training</span>
<a href="#__codelineno-5-169" id="__codelineno-5-169" name="__codelineno-5-169"></a><span class="n">preference_data</span> <span class="o">=</span> <span class="p">[</span>
<a href="#__codelineno-5-170" id="__codelineno-5-170" name="__codelineno-5-170"></a>    <span class="p">{</span>
<a href="#__codelineno-5-171" id="__codelineno-5-171" name="__codelineno-5-171"></a>        <span class="s1">'prompt'</span><span class="p">:</span> <span class="s1">'Explain quantum computing'</span><span class="p">,</span>
<a href="#__codelineno-5-172" id="__codelineno-5-172" name="__codelineno-5-172"></a>        <span class="s1">'response_a'</span><span class="p">:</span> <span class="s1">'Quantum computing uses quantum bits that can be 0 and 1 simultaneously.'</span><span class="p">,</span>
<a href="#__codelineno-5-173" id="__codelineno-5-173" name="__codelineno-5-173"></a>        <span class="s1">'response_b'</span><span class="p">:</span> <span class="s1">'Quantum computing is really complicated and uses weird physics stuff.'</span><span class="p">,</span>
<a href="#__codelineno-5-174" id="__codelineno-5-174" name="__codelineno-5-174"></a>        <span class="s1">'preference'</span><span class="p">:</span> <span class="s1">'A'</span>
<a href="#__codelineno-5-175" id="__codelineno-5-175" name="__codelineno-5-175"></a>    <span class="p">},</span>
<a href="#__codelineno-5-176" id="__codelineno-5-176" name="__codelineno-5-176"></a>    <span class="p">{</span>
<a href="#__codelineno-5-177" id="__codelineno-5-177" name="__codelineno-5-177"></a>        <span class="s1">'prompt'</span><span class="p">:</span> <span class="s1">'Write a poem about AI'</span><span class="p">,</span>
<a href="#__codelineno-5-178" id="__codelineno-5-178" name="__codelineno-5-178"></a>        <span class="s1">'response_a'</span><span class="p">:</span> <span class="s1">'AI is smart and cool, it helps us with many things.'</span><span class="p">,</span>
<a href="#__codelineno-5-179" id="__codelineno-5-179" name="__codelineno-5-179"></a>        <span class="s1">'response_b'</span><span class="p">:</span> <span class="s1">'Silicon dreams awaken, algorithms dance in digital dawn.'</span><span class="p">,</span>
<a href="#__codelineno-5-180" id="__codelineno-5-180" name="__codelineno-5-180"></a>        <span class="s1">'preference'</span><span class="p">:</span> <span class="s1">'B'</span>
<a href="#__codelineno-5-181" id="__codelineno-5-181" name="__codelineno-5-181"></a>    <span class="p">}</span>
<a href="#__codelineno-5-182" id="__codelineno-5-182" name="__codelineno-5-182"></a><span class="p">]</span>
<a href="#__codelineno-5-183" id="__codelineno-5-183" name="__codelineno-5-183"></a>
<a href="#__codelineno-5-184" id="__codelineno-5-184" name="__codelineno-5-184"></a><span class="c1"># Train reward model</span>
<a href="#__codelineno-5-185" id="__codelineno-5-185" name="__codelineno-5-185"></a><span class="n">reward_model</span> <span class="o">=</span> <span class="n">RewardModel</span><span class="p">()</span>
<a href="#__codelineno-5-186" id="__codelineno-5-186" name="__codelineno-5-186"></a><span class="n">reward_model</span><span class="o">.</span><span class="n">train_on_preferences</span><span class="p">(</span><span class="n">preference_data</span><span class="p">)</span>
<a href="#__codelineno-5-187" id="__codelineno-5-187" name="__codelineno-5-187"></a>
<a href="#__codelineno-5-188" id="__codelineno-5-188" name="__codelineno-5-188"></a><span class="nb">print</span><span class="p">(</span><span class="s2">"RLHF training pipeline completed!"</span><span class="p">)</span>
</code></pre></div></p>
<h2 id="training-metrics-and-evaluation">📊 Training Metrics and Evaluation</h2>
<h3 id="key-training-metrics">Key Training Metrics</h3>
<p><strong>Training Monitoring Dashboard</strong>:
<div class="highlight"><pre><span></span><code><a href="#__codelineno-6-1" id="__codelineno-6-1" name="__codelineno-6-1"></a><span class="k">class</span><span class="w"> </span><span class="nc">TrainingDashboard</span><span class="p">:</span>
<a href="#__codelineno-6-2" id="__codelineno-6-2" name="__codelineno-6-2"></a><span class="w">    </span><span class="sd">"""Comprehensive training monitoring and visualization"""</span>
<a href="#__codelineno-6-3" id="__codelineno-6-3" name="__codelineno-6-3"></a>
<a href="#__codelineno-6-4" id="__codelineno-6-4" name="__codelineno-6-4"></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<a href="#__codelineno-6-5" id="__codelineno-6-5" name="__codelineno-6-5"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">metrics</span> <span class="o">=</span> <span class="p">{</span>
<a href="#__codelineno-6-6" id="__codelineno-6-6" name="__codelineno-6-6"></a>            <span class="s1">'pre_training'</span><span class="p">:</span> <span class="p">{</span>
<a href="#__codelineno-6-7" id="__codelineno-6-7" name="__codelineno-6-7"></a>                <span class="s1">'loss'</span><span class="p">:</span> <span class="p">[],</span>
<a href="#__codelineno-6-8" id="__codelineno-6-8" name="__codelineno-6-8"></a>                <span class="s1">'perplexity'</span><span class="p">:</span> <span class="p">[],</span>
<a href="#__codelineno-6-9" id="__codelineno-6-9" name="__codelineno-6-9"></a>                <span class="s1">'learning_rate'</span><span class="p">:</span> <span class="p">[],</span>
<a href="#__codelineno-6-10" id="__codelineno-6-10" name="__codelineno-6-10"></a>                <span class="s1">'gradient_norm'</span><span class="p">:</span> <span class="p">[],</span>
<a href="#__codelineno-6-11" id="__codelineno-6-11" name="__codelineno-6-11"></a>                <span class="s1">'tokens_per_second'</span><span class="p">:</span> <span class="p">[]</span>
<a href="#__codelineno-6-12" id="__codelineno-6-12" name="__codelineno-6-12"></a>            <span class="p">},</span>
<a href="#__codelineno-6-13" id="__codelineno-6-13" name="__codelineno-6-13"></a>            <span class="s1">'sft'</span><span class="p">:</span> <span class="p">{</span>
<a href="#__codelineno-6-14" id="__codelineno-6-14" name="__codelineno-6-14"></a>                <span class="s1">'instruction_loss'</span><span class="p">:</span> <span class="p">[],</span>
<a href="#__codelineno-6-15" id="__codelineno-6-15" name="__codelineno-6-15"></a>                <span class="s1">'response_quality'</span><span class="p">:</span> <span class="p">[],</span>
<a href="#__codelineno-6-16" id="__codelineno-6-16" name="__codelineno-6-16"></a>                <span class="s1">'task_accuracy'</span><span class="p">:</span> <span class="p">[]</span>
<a href="#__codelineno-6-17" id="__codelineno-6-17" name="__codelineno-6-17"></a>            <span class="p">},</span>
<a href="#__codelineno-6-18" id="__codelineno-6-18" name="__codelineno-6-18"></a>            <span class="s1">'rlhf'</span><span class="p">:</span> <span class="p">{</span>
<a href="#__codelineno-6-19" id="__codelineno-6-19" name="__codelineno-6-19"></a>                <span class="s1">'reward_score'</span><span class="p">:</span> <span class="p">[],</span>
<a href="#__codelineno-6-20" id="__codelineno-6-20" name="__codelineno-6-20"></a>                <span class="s1">'kl_divergence'</span><span class="p">:</span> <span class="p">[],</span>
<a href="#__codelineno-6-21" id="__codelineno-6-21" name="__codelineno-6-21"></a>                <span class="s1">'policy_loss'</span><span class="p">:</span> <span class="p">[],</span>
<a href="#__codelineno-6-22" id="__codelineno-6-22" name="__codelineno-6-22"></a>                <span class="s1">'value_loss'</span><span class="p">:</span> <span class="p">[]</span>
<a href="#__codelineno-6-23" id="__codelineno-6-23" name="__codelineno-6-23"></a>            <span class="p">}</span>
<a href="#__codelineno-6-24" id="__codelineno-6-24" name="__codelineno-6-24"></a>        <span class="p">}</span>
<a href="#__codelineno-6-25" id="__codelineno-6-25" name="__codelineno-6-25"></a>
<a href="#__codelineno-6-26" id="__codelineno-6-26" name="__codelineno-6-26"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">checkpoints</span> <span class="o">=</span> <span class="p">[]</span>
<a href="#__codelineno-6-27" id="__codelineno-6-27" name="__codelineno-6-27"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">evaluation_results</span> <span class="o">=</span> <span class="p">[]</span>
<a href="#__codelineno-6-28" id="__codelineno-6-28" name="__codelineno-6-28"></a>
<a href="#__codelineno-6-29" id="__codelineno-6-29" name="__codelineno-6-29"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">log_pretraining_metrics</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">step</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">loss</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">perplexity</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
<a href="#__codelineno-6-30" id="__codelineno-6-30" name="__codelineno-6-30"></a>                               <span class="n">lr</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">grad_norm</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">throughput</span><span class="p">:</span> <span class="nb">float</span><span class="p">):</span>
<a href="#__codelineno-6-31" id="__codelineno-6-31" name="__codelineno-6-31"></a><span class="w">        </span><span class="sd">"""Log pre-training metrics"""</span>
<a href="#__codelineno-6-32" id="__codelineno-6-32" name="__codelineno-6-32"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">metrics</span><span class="p">[</span><span class="s1">'pre_training'</span><span class="p">][</span><span class="s1">'loss'</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">loss</span><span class="p">)</span>
<a href="#__codelineno-6-33" id="__codelineno-6-33" name="__codelineno-6-33"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">metrics</span><span class="p">[</span><span class="s1">'pre_training'</span><span class="p">][</span><span class="s1">'perplexity'</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">perplexity</span><span class="p">)</span>
<a href="#__codelineno-6-34" id="__codelineno-6-34" name="__codelineno-6-34"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">metrics</span><span class="p">[</span><span class="s1">'pre_training'</span><span class="p">][</span><span class="s1">'learning_rate'</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">lr</span><span class="p">)</span>
<a href="#__codelineno-6-35" id="__codelineno-6-35" name="__codelineno-6-35"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">metrics</span><span class="p">[</span><span class="s1">'pre_training'</span><span class="p">][</span><span class="s1">'gradient_norm'</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">grad_norm</span><span class="p">)</span>
<a href="#__codelineno-6-36" id="__codelineno-6-36" name="__codelineno-6-36"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">metrics</span><span class="p">[</span><span class="s1">'pre_training'</span><span class="p">][</span><span class="s1">'tokens_per_second'</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">throughput</span><span class="p">)</span>
<a href="#__codelineno-6-37" id="__codelineno-6-37" name="__codelineno-6-37"></a>
<a href="#__codelineno-6-38" id="__codelineno-6-38" name="__codelineno-6-38"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">create_training_report</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<a href="#__codelineno-6-39" id="__codelineno-6-39" name="__codelineno-6-39"></a><span class="w">        </span><span class="sd">"""Generate comprehensive training report"""</span>
<a href="#__codelineno-6-40" id="__codelineno-6-40" name="__codelineno-6-40"></a>        <span class="n">report</span> <span class="o">=</span> <span class="s2">"# LLM Training Report</span><span class="se">\n\n</span><span class="s2">"</span>
<a href="#__codelineno-6-41" id="__codelineno-6-41" name="__codelineno-6-41"></a>
<a href="#__codelineno-6-42" id="__codelineno-6-42" name="__codelineno-6-42"></a>        <span class="c1"># Pre-training summary</span>
<a href="#__codelineno-6-43" id="__codelineno-6-43" name="__codelineno-6-43"></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">metrics</span><span class="p">[</span><span class="s1">'pre_training'</span><span class="p">][</span><span class="s1">'loss'</span><span class="p">]:</span>
<a href="#__codelineno-6-44" id="__codelineno-6-44" name="__codelineno-6-44"></a>            <span class="n">final_loss</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">metrics</span><span class="p">[</span><span class="s1">'pre_training'</span><span class="p">][</span><span class="s1">'loss'</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
<a href="#__codelineno-6-45" id="__codelineno-6-45" name="__codelineno-6-45"></a>            <span class="n">min_loss</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">metrics</span><span class="p">[</span><span class="s1">'pre_training'</span><span class="p">][</span><span class="s1">'loss'</span><span class="p">])</span>
<a href="#__codelineno-6-46" id="__codelineno-6-46" name="__codelineno-6-46"></a>            <span class="n">report</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">"## Pre-training Results</span><span class="se">\n</span><span class="s2">"</span>
<a href="#__codelineno-6-47" id="__codelineno-6-47" name="__codelineno-6-47"></a>            <span class="n">report</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">"- Final Loss: </span><span class="si">{</span><span class="n">final_loss</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="se">\n</span><span class="s2">"</span>
<a href="#__codelineno-6-48" id="__codelineno-6-48" name="__codelineno-6-48"></a>            <span class="n">report</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">"- Best Loss: </span><span class="si">{</span><span class="n">min_loss</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="se">\n</span><span class="s2">"</span>
<a href="#__codelineno-6-49" id="__codelineno-6-49" name="__codelineno-6-49"></a>            <span class="n">report</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">"- Final Perplexity: </span><span class="si">{</span><span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">final_loss</span><span class="p">)</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="se">\n\n</span><span class="s2">"</span>
<a href="#__codelineno-6-50" id="__codelineno-6-50" name="__codelineno-6-50"></a>
<a href="#__codelineno-6-51" id="__codelineno-6-51" name="__codelineno-6-51"></a>        <span class="c1"># SFT summary</span>
<a href="#__codelineno-6-52" id="__codelineno-6-52" name="__codelineno-6-52"></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">metrics</span><span class="p">[</span><span class="s1">'sft'</span><span class="p">][</span><span class="s1">'instruction_loss'</span><span class="p">]:</span>
<a href="#__codelineno-6-53" id="__codelineno-6-53" name="__codelineno-6-53"></a>            <span class="n">final_sft_loss</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">metrics</span><span class="p">[</span><span class="s1">'sft'</span><span class="p">][</span><span class="s1">'instruction_loss'</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
<a href="#__codelineno-6-54" id="__codelineno-6-54" name="__codelineno-6-54"></a>            <span class="n">report</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">"## Supervised Fine-tuning Results</span><span class="se">\n</span><span class="s2">"</span>
<a href="#__codelineno-6-55" id="__codelineno-6-55" name="__codelineno-6-55"></a>            <span class="n">report</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">"- Final SFT Loss: </span><span class="si">{</span><span class="n">final_sft_loss</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="se">\n\n</span><span class="s2">"</span>
<a href="#__codelineno-6-56" id="__codelineno-6-56" name="__codelineno-6-56"></a>
<a href="#__codelineno-6-57" id="__codelineno-6-57" name="__codelineno-6-57"></a>        <span class="c1"># RLHF summary</span>
<a href="#__codelineno-6-58" id="__codelineno-6-58" name="__codelineno-6-58"></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">metrics</span><span class="p">[</span><span class="s1">'rlhf'</span><span class="p">][</span><span class="s1">'reward_score'</span><span class="p">]:</span>
<a href="#__codelineno-6-59" id="__codelineno-6-59" name="__codelineno-6-59"></a>            <span class="n">avg_reward</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">metrics</span><span class="p">[</span><span class="s1">'rlhf'</span><span class="p">][</span><span class="s1">'reward_score'</span><span class="p">][</span><span class="o">-</span><span class="mi">10</span><span class="p">:])</span>
<a href="#__codelineno-6-60" id="__codelineno-6-60" name="__codelineno-6-60"></a>            <span class="n">report</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">"## RLHF Results</span><span class="se">\n</span><span class="s2">"</span>
<a href="#__codelineno-6-61" id="__codelineno-6-61" name="__codelineno-6-61"></a>            <span class="n">report</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">"- Average Reward (last 10 steps): </span><span class="si">{</span><span class="n">avg_reward</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="se">\n\n</span><span class="s2">"</span>
<a href="#__codelineno-6-62" id="__codelineno-6-62" name="__codelineno-6-62"></a>
<a href="#__codelineno-6-63" id="__codelineno-6-63" name="__codelineno-6-63"></a>        <span class="k">return</span> <span class="n">report</span>
<a href="#__codelineno-6-64" id="__codelineno-6-64" name="__codelineno-6-64"></a>
<a href="#__codelineno-6-65" id="__codelineno-6-65" name="__codelineno-6-65"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">plot_training_progress</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<a href="#__codelineno-6-66" id="__codelineno-6-66" name="__codelineno-6-66"></a><span class="w">        </span><span class="sd">"""Plot comprehensive training curves"""</span>
<a href="#__codelineno-6-67" id="__codelineno-6-67" name="__codelineno-6-67"></a>        <span class="kn">import</span><span class="w"> </span><span class="nn">matplotlib.pyplot</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">plt</span>
<a href="#__codelineno-6-68" id="__codelineno-6-68" name="__codelineno-6-68"></a>
<a href="#__codelineno-6-69" id="__codelineno-6-69" name="__codelineno-6-69"></a>        <span class="n">fig</span><span class="p">,</span> <span class="n">axes</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">18</span><span class="p">,</span> <span class="mi">10</span><span class="p">))</span>
<a href="#__codelineno-6-70" id="__codelineno-6-70" name="__codelineno-6-70"></a>
<a href="#__codelineno-6-71" id="__codelineno-6-71" name="__codelineno-6-71"></a>        <span class="c1"># Pre-training loss</span>
<a href="#__codelineno-6-72" id="__codelineno-6-72" name="__codelineno-6-72"></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">metrics</span><span class="p">[</span><span class="s1">'pre_training'</span><span class="p">][</span><span class="s1">'loss'</span><span class="p">]:</span>
<a href="#__codelineno-6-73" id="__codelineno-6-73" name="__codelineno-6-73"></a>            <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">metrics</span><span class="p">[</span><span class="s1">'pre_training'</span><span class="p">][</span><span class="s1">'loss'</span><span class="p">])</span>
<a href="#__codelineno-6-74" id="__codelineno-6-74" name="__codelineno-6-74"></a>            <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">'Pre-training Loss'</span><span class="p">)</span>
<a href="#__codelineno-6-75" id="__codelineno-6-75" name="__codelineno-6-75"></a>            <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">'Steps'</span><span class="p">)</span>
<a href="#__codelineno-6-76" id="__codelineno-6-76" name="__codelineno-6-76"></a>            <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">'Cross-Entropy Loss'</span><span class="p">)</span>
<a href="#__codelineno-6-77" id="__codelineno-6-77" name="__codelineno-6-77"></a>            <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_yscale</span><span class="p">(</span><span class="s1">'log'</span><span class="p">)</span>
<a href="#__codelineno-6-78" id="__codelineno-6-78" name="__codelineno-6-78"></a>
<a href="#__codelineno-6-79" id="__codelineno-6-79" name="__codelineno-6-79"></a>        <span class="c1"># Learning rate schedule</span>
<a href="#__codelineno-6-80" id="__codelineno-6-80" name="__codelineno-6-80"></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">metrics</span><span class="p">[</span><span class="s1">'pre_training'</span><span class="p">][</span><span class="s1">'learning_rate'</span><span class="p">]:</span>
<a href="#__codelineno-6-81" id="__codelineno-6-81" name="__codelineno-6-81"></a>            <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">metrics</span><span class="p">[</span><span class="s1">'pre_training'</span><span class="p">][</span><span class="s1">'learning_rate'</span><span class="p">])</span>
<a href="#__codelineno-6-82" id="__codelineno-6-82" name="__codelineno-6-82"></a>            <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">'Learning Rate Schedule'</span><span class="p">)</span>
<a href="#__codelineno-6-83" id="__codelineno-6-83" name="__codelineno-6-83"></a>            <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">'Steps'</span><span class="p">)</span>
<a href="#__codelineno-6-84" id="__codelineno-6-84" name="__codelineno-6-84"></a>            <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">'Learning Rate'</span><span class="p">)</span>
<a href="#__codelineno-6-85" id="__codelineno-6-85" name="__codelineno-6-85"></a>            <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_yscale</span><span class="p">(</span><span class="s1">'log'</span><span class="p">)</span>
<a href="#__codelineno-6-86" id="__codelineno-6-86" name="__codelineno-6-86"></a>
<a href="#__codelineno-6-87" id="__codelineno-6-87" name="__codelineno-6-87"></a>        <span class="c1"># Training throughput</span>
<a href="#__codelineno-6-88" id="__codelineno-6-88" name="__codelineno-6-88"></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">metrics</span><span class="p">[</span><span class="s1">'pre_training'</span><span class="p">][</span><span class="s1">'tokens_per_second'</span><span class="p">]:</span>
<a href="#__codelineno-6-89" id="__codelineno-6-89" name="__codelineno-6-89"></a>            <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">metrics</span><span class="p">[</span><span class="s1">'pre_training'</span><span class="p">][</span><span class="s1">'tokens_per_second'</span><span class="p">])</span>
<a href="#__codelineno-6-90" id="__codelineno-6-90" name="__codelineno-6-90"></a>            <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">'Training Throughput'</span><span class="p">)</span>
<a href="#__codelineno-6-91" id="__codelineno-6-91" name="__codelineno-6-91"></a>            <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">'Steps'</span><span class="p">)</span>
<a href="#__codelineno-6-92" id="__codelineno-6-92" name="__codelineno-6-92"></a>            <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">'Tokens/Second'</span><span class="p">)</span>
<a href="#__codelineno-6-93" id="__codelineno-6-93" name="__codelineno-6-93"></a>
<a href="#__codelineno-6-94" id="__codelineno-6-94" name="__codelineno-6-94"></a>        <span class="c1"># SFT loss</span>
<a href="#__codelineno-6-95" id="__codelineno-6-95" name="__codelineno-6-95"></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">metrics</span><span class="p">[</span><span class="s1">'sft'</span><span class="p">][</span><span class="s1">'instruction_loss'</span><span class="p">]:</span>
<a href="#__codelineno-6-96" id="__codelineno-6-96" name="__codelineno-6-96"></a>            <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">metrics</span><span class="p">[</span><span class="s1">'sft'</span><span class="p">][</span><span class="s1">'instruction_loss'</span><span class="p">])</span>
<a href="#__codelineno-6-97" id="__codelineno-6-97" name="__codelineno-6-97"></a>            <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">'SFT Loss'</span><span class="p">)</span>
<a href="#__codelineno-6-98" id="__codelineno-6-98" name="__codelineno-6-98"></a>            <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">'Steps'</span><span class="p">)</span>
<a href="#__codelineno-6-99" id="__codelineno-6-99" name="__codelineno-6-99"></a>            <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">'Instruction Loss'</span><span class="p">)</span>
<a href="#__codelineno-6-100" id="__codelineno-6-100" name="__codelineno-6-100"></a>
<a href="#__codelineno-6-101" id="__codelineno-6-101" name="__codelineno-6-101"></a>        <span class="c1"># RLHF rewards</span>
<a href="#__codelineno-6-102" id="__codelineno-6-102" name="__codelineno-6-102"></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">metrics</span><span class="p">[</span><span class="s1">'rlhf'</span><span class="p">][</span><span class="s1">'reward_score'</span><span class="p">]:</span>
<a href="#__codelineno-6-103" id="__codelineno-6-103" name="__codelineno-6-103"></a>            <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">metrics</span><span class="p">[</span><span class="s1">'rlhf'</span><span class="p">][</span><span class="s1">'reward_score'</span><span class="p">])</span>
<a href="#__codelineno-6-104" id="__codelineno-6-104" name="__codelineno-6-104"></a>            <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">'RLHF Reward Progression'</span><span class="p">)</span>
<a href="#__codelineno-6-105" id="__codelineno-6-105" name="__codelineno-6-105"></a>            <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">'Steps'</span><span class="p">)</span>
<a href="#__codelineno-6-106" id="__codelineno-6-106" name="__codelineno-6-106"></a>            <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">'Average Reward'</span><span class="p">)</span>
<a href="#__codelineno-6-107" id="__codelineno-6-107" name="__codelineno-6-107"></a>
<a href="#__codelineno-6-108" id="__codelineno-6-108" name="__codelineno-6-108"></a>        <span class="c1"># KL divergence</span>
<a href="#__codelineno-6-109" id="__codelineno-6-109" name="__codelineno-6-109"></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">metrics</span><span class="p">[</span><span class="s1">'rlhf'</span><span class="p">][</span><span class="s1">'kl_divergence'</span><span class="p">]:</span>
<a href="#__codelineno-6-110" id="__codelineno-6-110" name="__codelineno-6-110"></a>            <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">metrics</span><span class="p">[</span><span class="s1">'rlhf'</span><span class="p">][</span><span class="s1">'kl_divergence'</span><span class="p">])</span>
<a href="#__codelineno-6-111" id="__codelineno-6-111" name="__codelineno-6-111"></a>            <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">'KL Divergence from Reference'</span><span class="p">)</span>
<a href="#__codelineno-6-112" id="__codelineno-6-112" name="__codelineno-6-112"></a>            <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">'Steps'</span><span class="p">)</span>
<a href="#__codelineno-6-113" id="__codelineno-6-113" name="__codelineno-6-113"></a>            <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">'KL Divergence'</span><span class="p">)</span>
<a href="#__codelineno-6-114" id="__codelineno-6-114" name="__codelineno-6-114"></a>
<a href="#__codelineno-6-115" id="__codelineno-6-115" name="__codelineno-6-115"></a>        <span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
<a href="#__codelineno-6-116" id="__codelineno-6-116" name="__codelineno-6-116"></a>        <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
<a href="#__codelineno-6-117" id="__codelineno-6-117" name="__codelineno-6-117"></a>
<a href="#__codelineno-6-118" id="__codelineno-6-118" name="__codelineno-6-118"></a><span class="c1"># Create dashboard and simulate training</span>
<a href="#__codelineno-6-119" id="__codelineno-6-119" name="__codelineno-6-119"></a><span class="n">dashboard</span> <span class="o">=</span> <span class="n">TrainingDashboard</span><span class="p">()</span>
<a href="#__codelineno-6-120" id="__codelineno-6-120" name="__codelineno-6-120"></a>
<a href="#__codelineno-6-121" id="__codelineno-6-121" name="__codelineno-6-121"></a><span class="c1"># Simulate metrics</span>
<a href="#__codelineno-6-122" id="__codelineno-6-122" name="__codelineno-6-122"></a><span class="k">for</span> <span class="n">step</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">100</span><span class="p">):</span>
<a href="#__codelineno-6-123" id="__codelineno-6-123" name="__codelineno-6-123"></a>    <span class="c1"># Pre-training metrics</span>
<a href="#__codelineno-6-124" id="__codelineno-6-124" name="__codelineno-6-124"></a>    <span class="n">loss</span> <span class="o">=</span> <span class="mf">5.0</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="n">step</span> <span class="o">/</span> <span class="mi">50</span><span class="p">)</span> <span class="o">+</span> <span class="mf">1.0</span> <span class="o">+</span> <span class="mf">0.1</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">randn</span><span class="p">()</span>
<a href="#__codelineno-6-125" id="__codelineno-6-125" name="__codelineno-6-125"></a>    <span class="n">perplexity</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">loss</span><span class="p">)</span>
<a href="#__codelineno-6-126" id="__codelineno-6-126" name="__codelineno-6-126"></a>    <span class="n">lr</span> <span class="o">=</span> <span class="mf">6e-4</span> <span class="o">*</span> <span class="nb">min</span><span class="p">(</span><span class="n">step</span> <span class="o">/</span> <span class="mi">2000</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">step</span> <span class="o">/</span> <span class="mi">10000</span><span class="p">)</span>
<a href="#__codelineno-6-127" id="__codelineno-6-127" name="__codelineno-6-127"></a>    <span class="n">grad_norm</span> <span class="o">=</span> <span class="mf">1.0</span> <span class="o">+</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">randn</span><span class="p">()</span>
<a href="#__codelineno-6-128" id="__codelineno-6-128" name="__codelineno-6-128"></a>    <span class="n">throughput</span> <span class="o">=</span> <span class="mi">50000</span> <span class="o">+</span> <span class="mi">5000</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">randn</span><span class="p">()</span>
<a href="#__codelineno-6-129" id="__codelineno-6-129" name="__codelineno-6-129"></a>
<a href="#__codelineno-6-130" id="__codelineno-6-130" name="__codelineno-6-130"></a>    <span class="n">dashboard</span><span class="o">.</span><span class="n">log_pretraining_metrics</span><span class="p">(</span><span class="n">step</span><span class="p">,</span> <span class="n">loss</span><span class="p">,</span> <span class="n">perplexity</span><span class="p">,</span> <span class="n">lr</span><span class="p">,</span> <span class="n">grad_norm</span><span class="p">,</span> <span class="n">throughput</span><span class="p">)</span>
<a href="#__codelineno-6-131" id="__codelineno-6-131" name="__codelineno-6-131"></a>
<a href="#__codelineno-6-132" id="__codelineno-6-132" name="__codelineno-6-132"></a>    <span class="c1"># SFT metrics (later in training)</span>
<a href="#__codelineno-6-133" id="__codelineno-6-133" name="__codelineno-6-133"></a>    <span class="k">if</span> <span class="n">step</span> <span class="o">&gt;</span> <span class="mi">70</span><span class="p">:</span>
<a href="#__codelineno-6-134" id="__codelineno-6-134" name="__codelineno-6-134"></a>        <span class="n">sft_loss</span> <span class="o">=</span> <span class="mf">2.0</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="p">(</span><span class="n">step</span> <span class="o">-</span> <span class="mi">70</span><span class="p">)</span> <span class="o">/</span> <span class="mi">10</span><span class="p">)</span> <span class="o">+</span> <span class="mf">0.5</span> <span class="o">+</span> <span class="mf">0.05</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">randn</span><span class="p">()</span>
<a href="#__codelineno-6-135" id="__codelineno-6-135" name="__codelineno-6-135"></a>        <span class="n">dashboard</span><span class="o">.</span><span class="n">metrics</span><span class="p">[</span><span class="s1">'sft'</span><span class="p">][</span><span class="s1">'instruction_loss'</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">sft_loss</span><span class="p">)</span>
<a href="#__codelineno-6-136" id="__codelineno-6-136" name="__codelineno-6-136"></a>
<a href="#__codelineno-6-137" id="__codelineno-6-137" name="__codelineno-6-137"></a>    <span class="c1"># RLHF metrics (final phase)</span>
<a href="#__codelineno-6-138" id="__codelineno-6-138" name="__codelineno-6-138"></a>    <span class="k">if</span> <span class="n">step</span> <span class="o">&gt;</span> <span class="mi">85</span><span class="p">:</span>
<a href="#__codelineno-6-139" id="__codelineno-6-139" name="__codelineno-6-139"></a>        <span class="n">reward</span> <span class="o">=</span> <span class="mf">0.1</span> <span class="o">*</span> <span class="p">(</span><span class="n">step</span> <span class="o">-</span> <span class="mi">85</span><span class="p">)</span> <span class="o">+</span> <span class="mf">0.2</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">randn</span><span class="p">()</span>
<a href="#__codelineno-6-140" id="__codelineno-6-140" name="__codelineno-6-140"></a>        <span class="n">kl_div</span> <span class="o">=</span> <span class="mf">0.05</span> <span class="o">+</span> <span class="mf">0.02</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">randn</span><span class="p">()</span>
<a href="#__codelineno-6-141" id="__codelineno-6-141" name="__codelineno-6-141"></a>        <span class="n">dashboard</span><span class="o">.</span><span class="n">metrics</span><span class="p">[</span><span class="s1">'rlhf'</span><span class="p">][</span><span class="s1">'reward_score'</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">reward</span><span class="p">)</span>
<a href="#__codelineno-6-142" id="__codelineno-6-142" name="__codelineno-6-142"></a>        <span class="n">dashboard</span><span class="o">.</span><span class="n">metrics</span><span class="p">[</span><span class="s1">'rlhf'</span><span class="p">][</span><span class="s1">'kl_divergence'</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">kl_div</span><span class="p">)</span>
<a href="#__codelineno-6-143" id="__codelineno-6-143" name="__codelineno-6-143"></a>
<a href="#__codelineno-6-144" id="__codelineno-6-144" name="__codelineno-6-144"></a><span class="c1"># Generate report and plots</span>
<a href="#__codelineno-6-145" id="__codelineno-6-145" name="__codelineno-6-145"></a><span class="nb">print</span><span class="p">(</span><span class="n">dashboard</span><span class="o">.</span><span class="n">create_training_report</span><span class="p">())</span>
<a href="#__codelineno-6-146" id="__codelineno-6-146" name="__codelineno-6-146"></a><span class="n">dashboard</span><span class="o">.</span><span class="n">plot_training_progress</span><span class="p">()</span>
</code></pre></div></p>
<h2 id="training-process-checklist">✅ Training Process Checklist</h2>
<p>Ensure you understand:</p>
<ol>
<li><strong>Data Pipeline</strong>: Collection, cleaning, tokenization, deduplication</li>
<li><strong>Distributed Training</strong>: Multi-GPU setups, gradient accumulation</li>
<li><strong>Pre-training Objectives</strong>: Next-token prediction, loss functions</li>
<li><strong>SFT Process</strong>: Instruction formatting, response masking</li>
<li><strong>RLHF Pipeline</strong>: Reward models, PPO, human preferences</li>
<li><strong>Training Monitoring</strong>: Metrics, checkpointing, evaluation</li>
</ol>
<h2 id="next-steps">🚀 Next Steps</h2>
<p>Continue with:</p>
<ol>
<li><strong><a href="../fine-tuning/">Fine-tuning &amp; Adaptation</a></strong> - Customize models for specific tasks</li>
<li><strong><a href="../prompt-engineering/">Prompt Engineering</a></strong> - Optimize model interactions</li>
<li><strong><a href="../../agents/architecture/">Building LLM Agents</a></strong> - Apply trained models to agents</li>
</ol>
<hr/>
<p><em>Understanding the complete training process is essential for working with LLMs effectively and building robust agent systems that leverage these powerful foundation models.</em></p>
</article>
</div>
<script>var tabs=__md_get("__tabs");if(Array.isArray(tabs))e:for(var set of document.querySelectorAll(".tabbed-set")){var labels=set.querySelector(".tabbed-labels");for(var tab of tabs)for(var label of labels.getElementsByTagName("label"))if(label.innerText.trim()===tab){var input=document.getElementById(label.htmlFor);input.checked=!0;continue e}}</script>
<script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script>
</div>
<button class="md-top md-icon" data-md-component="top" hidden="" type="button">
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M13 20h-2V8l-5.5 5.5-1.42-1.42L12 4.16l7.92 7.92-1.42 1.42L13 8z"></path></svg>
  Back to top
</button>
</main>
<footer class="md-footer">
<div class="md-footer-meta md-typeset">
<div class="md-footer-meta__inner md-grid">
<div class="md-copyright">
<div class="md-copyright__highlight">
      Copyright © 2024 LLM-MCP Learning Path Contributors
    </div>
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" rel="noopener" target="_blank">
      Material for MkDocs
    </a>
</div>
</div>
</div>
</footer>
</div>
<div class="md-dialog" data-md-component="dialog">
<div class="md-dialog__inner md-typeset"></div>
</div>
<script id="__config" type="application/json">{"base": "../../..", "features": ["navigation.tabs", "navigation.sections", "navigation.expand", "navigation.path", "navigation.top", "search.suggest", "search.highlight", "content.tabs.link", "content.code.annotation", "content.code.copy"], "search": "../../../assets/javascripts/workers/search.973d3a69.min.js", "tags": null, "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}, "version": null}</script>
<script src="../../../assets/javascripts/bundle.f55a23d4.min.js"></script>
<script src="../../../javascripts/mathjax.js"></script>
<script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
<script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
</body>
</html>